<script>
document.addEventListener("DOMContentLoaded",()=>{
  /* ======== Farbdefinitionen ======== */
  const CAT_COLORS = {
    Gelb:"#F4D03F", Pink:"#E91E63", Blau:"#1976D2", Gruen:"#1E8449",
    HellesPink:"#F54927", Orange:"#E67E22", Dunkelgruen:"#117A65", Rot:"#C0392B"
  };
  const TEXT_ON = {
    Gelb:"#000", Pink:"#fff", Blau:"#fff", Gruen:"#fff",
    HellesPink:"#fff", Orange:"#fff", Dunkelgruen:"#fff", Rot:"#fff"
  };

  const CATEGORIES = {
    Gelb:"Grundwerkzeuge Metallverarbeitung",
    Pink:"Werkzeugkasten Mechaniker",
    Blau:"Blech- / Kunststoffarbeiten",
    Gruen:"Drehen / Fr√§sen",
    HellesPink:"Hydraulik / Pneumatik",
    Orange:"Elektrotechnik",
    Dunkelgruen:"Flugger√§temechanik allgemein",
    Rot:"‚ö†Ô∏è Verwechslungsgefahr"
  };

  const RAW_URL = "https://beeferino.github.io/vokabeltrainer/vokabeln.json";

  /* ======== DOM Elemente ======== */
  const el = {
    cat: document.getElementById("category"),
    mode: document.getElementById("mode"),
    delay: document.getElementById("delay"),
    fbBtn: document.getElementById("feedbackBtn"),
    learn: document.getElementById("learnBtn"),
    cards: document.getElementById("cardsBtn"),
    last: document.getElementById("last30Btn"),
    trainer: document.getElementById("trainer"),
    word: document.getElementById("word"),
    ans: document.getElementById("answerInput"),
    fb: document.getElementById("feedback"),
    right: document.getElementById("rightBtn"),
    wrong: document.getElementById("wrongBtn"),
    skip: document.getElementById("skipBtn"),
    restart: document.getElementById("restartBtn"),
    result: document.getElementById("result")
  };

  /* ======== State ======== */
  let list=[], currentSet=[], index=0, errors=[], skipped=[], mode="mixed", gameType="learn";
  let feedbackOn=true, trap=false, currentAnswer="";

  /* ======== Feedback Toggle ======== */
  el.fbBtn.onclick=()=>{
    feedbackOn=!feedbackOn;
    el.fbBtn.classList.toggle("active",feedbackOn);
    el.fbBtn.textContent = feedbackOn ? "üß© Feedback: AN" : "üß© Feedback: AUS";
  };

  /* ======== Kategorie-Farbe beibehalten ======== */
  function updateCategoryColor(){
    const val = el.cat.value;
    if(val==="Alle"){el.cat.style.background="#f1f5f9";el.cat.style.color="#000";return;}
    el.cat.style.background = CAT_COLORS[val];
    el.cat.style.color = TEXT_ON[val];
  }
  el.cat.addEventListener("change",updateCategoryColor);
  updateCategoryColor();

  /* ======== Laden der Daten ======== */
  async function loadData(){
    try{
      const r=await fetch(RAW_URL,{cache:"no-store"});
      list=await r.json();
      localStorage.setItem("vokabeln",JSON.stringify(list));
    }catch{
      list=JSON.parse(localStorage.getItem("vokabeln")||"[]");
    }
  }

  /* ======== Hilfsfunktionen ======== */
  const shuffle = a => a.sort(()=>Math.random()-.5);
  const flash = c => { el.trainer.classList.add(c); setTimeout(()=>el.trainer.classList.remove(c),400); };

  function getWrong(correct){
    let pool = list.map(v=>v[1]);
    let w;
    do { w = pool[Math.floor(Math.random()*pool.length)] } while(w===correct);
    return w;
  }

  /* ======== Spielstart ======== */
  function startGame(type,modeSel,custom=null){
    gameType=type;
    mode=modeSel;
    let data=list;
    const cat=el.cat.value;
    if(cat!=="Alle") data=data.filter(v=>v[2]===cat);
    // Spezialmodus Verwechslungsgefahr
    if(cat==="Rot" || type==="confuse") data=data.filter(v=>v[2]==="Rot");

    if(custom) data=custom;
    currentSet=shuffle([...data]);
    index=0;errors=[];skipped=[];
    el.trainer.style.display="block";
    el.result.style.display="none";
    showNext();
  }

  /* ======== N√§chste Karte ======== */
  function showNext(){
    if(index>=currentSet.length){
      if(skipped.length){ currentSet=skipped; skipped=[]; index=0; el.fb.textContent="üìò √úbersprungene Runde"; showNext(); return;}
      showResult(); return;
    }

    const [en,de,cat] = currentSet[index];
    let ask, answer;
    if(mode==="toGerman"){ ask=en; answer=de; }
    else if(mode==="toEnglish"){ ask=de; answer=en; }
    else { if(Math.random()<.5){ ask=en; answer=de; } else { ask=de; answer=en; } }

    const color = CAT_COLORS[cat] || "#94a3b8";
    const textColor = TEXT_ON[cat] || "#fff";
    el.word.style.background=color;
    el.word.style.color=textColor;
    el.word.innerHTML = `<div style="font-size:1.1rem;margin-bottom:8px">${CATEGORIES[cat]}</div><b>${ask}</b>`;
    el.fb.textContent="";

    const delay = parseInt(el.delay.value);

    // === Modus 1: Klassische Eingabe ===
    if(gameType==="learn"){
      el.ans.style.display="inline-block";
      el.right.style.display=el.wrong.style.display="none";
      el.skip.style.display="inline-block";
      el.ans.value="";
      el.ans.focus();

      el.ans.onkeydown=e=>{
        if(e.key==="Enter"){
          const ok = el.ans.value.trim().toLowerCase()===answer.toLowerCase();
          if(feedbackOn){ el.fb.textContent = ok?"‚úÖ Richtig!":`‚ùå Falsch ‚Üí ${answer}`; flash(ok?"correct":"wrong"); }
          if(!ok) errors.push([ask,answer]);
          index++;
          setTimeout(showNext,delay);
        }
      };
      el.skip.onclick=()=>{ skipped.push([en,de,cat]); index++; showNext(); };
    }

    // === Modus 2: Karteikarten + Verwechslungsgefahr ===
    else {
      el.ans.style.display="none";
      el.right.style.display=el.wrong.style.display=el.skip.style.display="inline-block";
      trap=Math.random()<.3; // T√§uschung aktiv?
      currentAnswer = trap ? getWrong(answer) : answer;
      el.fb.innerHTML=`üí° <b>${currentAnswer}</b>`;

      const okBtn = trap ? el.wrong : el.right;
      okBtn.onclick=()=>{ 
        if(trap){ openCorrection(answer,ask); }
        else { nextCard(true,ask,answer); }
      };

      const failBtn = trap ? el.right : el.wrong;
      failBtn.onclick=()=>nextCard(false,ask,answer);
      el.skip.onclick=()=>{ skipped.push([en,de,cat]); index++; showNext(); };
    }
  }

  /* ======== Eingabeaufforderung bei T√§uschung ======== */
  function openCorrection(correct,ask){
    el.ans.style.display="inline-block";
    el.ans.value="";
    el.fb.textContent="Gib die richtige √úbersetzung ein:";
    el.right.style.display=el.wrong.style.display="none";

    el.ans.onkeydown=e=>{
      if(e.key==="Enter"){
        const ok = el.ans.value.trim().toLowerCase()===correct.toLowerCase();
        if(feedbackOn){ el.fb.textContent = ok?"‚úÖ Richtig!":`‚ùå Falsch ‚Üí ${correct}`; flash(ok?"correct":"wrong"); }
        if(!ok) errors.push([ask,correct]);
        index++;
        setTimeout(showNext,parseInt(el.delay.value));
      }
    };
  }

  /* ======== N√§chste Karte im Karteikartenmodus ======== */
  function nextCard(ok,ask,ans){
    if(feedbackOn){ el.fb.textContent = ok?"‚úÖ Richtig!":"‚ùå Falsch!"; flash(ok?"correct":"wrong"); }
    if(!ok) errors.push([ask,ans]);
    index++;
    setTimeout(showNext,parseInt(el.delay.value));
  }

  /* ======== Ergebnis anzeigen ======== */
  function showResult(){
    el.trainer.style.display="none";
    let html="<h3>Runde beendet</h3>";
    html += errors.length
      ? `<p>${errors.length} Fehler:</p><ul>${errors.map(([q,a])=>`<li>${q} ‚Üí ${a}</li>`).join("")}</ul>`
      : "<p>Keine Fehler üéâ</p>";
    el.result.innerHTML=html;
    el.result.style.display="block";
  }

  /* ======== Event-Listener ======== */
  el.learn.onclick = ()=>startGame("learn",el.mode.value);
  el.cards.onclick = ()=>startGame("cards",el.mode.value);
  el.last.onclick = ()=>{
    const total = list.length;
    if(!total){ alert("Keine Vokabeln vorhanden."); return; }
    const recent = list.slice(-30);
    const confirmMode = confirm("üìö Letzte 30 Vokabeln:\nOK = Karteikarten, Abbrechen = Eingabe");
    startGame(confirmMode?"cards":"learn",el.mode.value,recent);
  };
  el.restart.onclick = ()=>location.reload();

  /* ======== Laden starten ======== */
  loadData();
});
</script>
