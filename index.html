<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>🧠 Vokabeltrainer</title>
<style>
  body{font-family:sans-serif;background:#f7f9fb;margin:0;padding:20px;text-align:center;}
  .app{max-width:900px;margin:auto;}
  h1{font-size:1.8rem;margin-bottom:.6rem;}

  /* Karten / Sektionen – an dein bestehendes Layout angelehnt */
  .section{background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);border-radius:12px;padding:20px;margin-top:24px;text-align:left;}
  .section h2{margin-top:0;color:#2c3e50;border-bottom:2px solid #e3e7ef;padding-bottom:6px;font-size:1.2rem;}

  /* Bedienelemente */
  input,button{padding:10px 12px;font-size:1rem;border-radius:8px;border:1px solid #cfd6e4;margin:6px;}
  button{cursor:pointer;background:#2980b9;color:#fff;border:none;}
  button:hover{background:#3498db;}
  .btn-secondary{background:#7f8c8d;} .btn-secondary:hover{background:#95a5a6;}
  .btn-good{background:#27ae60;} .btn-good:hover{background:#2ecc71;}
  .btn-bad{background:#c0392b;} .btn-bad:hover{background:#e74c3c;}

  .qa{display:grid;grid-template-columns:1fr;gap:10px}
  .qa .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .qa label{min-width:120px;font-weight:600;color:#2c3e50;}
  .qa input{flex:1;min-width:220px}

  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
  .stats{margin-top:10px;color:#555}

  a.linkbtn{display:inline-block;padding:10px 16px;border-radius:8px;background:#74b9ff;color:#000;text-decoration:none;font-weight:600;}
  a.linkbtn:hover{background:#a6d4ff;}

  /* Zuletzt hinzugefügt */
  .recent-list{list-style:none;padding-left:0;margin:10px 0;}
  .recent-list li{background:#f7f9fb;border-left:4px solid #2980b9;margin:6px 0;padding:8px 10px;border-radius:6px;}
  .recent-list span{font-weight:bold;color:#2c3e50;}

  /* Status + Snackbar */
  #datasourceStatus{margin-top:10px;color:#555;font-size:.9rem;}
  #reloadJson{background:#8e44ad} #reloadJson:hover{background:#9b59b6;}
  #updateSnackbar{position:fixed;bottom:-120px;left:50%;transform:translateX(-50%);
    background:#2ecc71;color:#fff;padding:14px 18px;border-radius:10px;
    display:flex;align-items:center;gap:14px;box-shadow:0 4px 8px rgba(0,0,0,.2);
    transition:bottom .5s ease;z-index:1000;}
  #updateSnackbar.show{bottom:25px;}
  #updateSnackbar button{background:#27ae60;border:none;padding:6px 10px;border-radius:6px;color:#fff;}
  #updateSnackbar button:hover{background:#2ecc71;}
  #updateSnackbar .later{background:#7f8c8d;} #updateSnackbar .later:hover{background:#95a5a6;}
</style>
</head>
<body>
<div class="app">
  <h1>🧠 Vokabeltrainer</h1>

  <!-- Trainingsbereich (simpler, deinem Stil nachempfunden) -->
  <div class="section">
    <h2>🎯 Training</h2>
    <div class="qa">
      <div class="row">
        <label>Englisch</label>
        <input id="qEn" readonly placeholder="(zufälliges Wort)">
      </div>
      <div class="row">
        <label>Deutsch</label>
        <input id="qDe" type="password" readonly placeholder="(versteckt)">
      </div>
    </div>
    <div class="actions">
      <button id="showAnswer" class="btn-secondary">👁️ Antwort zeigen</button>
      <button id="markRight" class="btn-good">✅ Richtig</button>
      <button id="markWrong" class="btn-bad">❌ Falsch</button>
      <button id="nextWord">➡️ Nächstes Wort</button>
      <a href="vokabeln.html" class="linkbtn">📘 Zur Vokabelübersicht</a>
    </div>
    <div class="stats" id="statsLine">🔢 Richtig: 0 | Falsch: 0</div>
  </div>

  <!-- Zuletzt hinzugefügt + Sync -->
  <div class="section">
    <h2>🕒 Zuletzt hinzugefügt</h2>
    <ul id="recentList" class="recent-list"></ul>
    <div id="datasourceStatus">📂 Datenquelle: wird geprüft...</div>
    <button id="reloadJson">🔄 JSON aktualisieren</button>
  </div>
</div>

<!-- Snackbar -->
<div id="updateSnackbar">
  <span>Eine neue Vokabelliste ist verfügbar!</span>
  <button class="updateNow">🔄 Jetzt aktualisieren</button>
  <button class="later">Später</button>
</div>

<script>
(() => {
  const $=s=>document.querySelector(s);
  const $$=s=>[...document.querySelectorAll(s)];
  const normalize=v=>[v[0]||"",v[1]||"",v[2]||"Gelb",v[3]||"",v[4]||"",v[5]||new Date().toISOString()];
  const loadLocal=()=>JSON.parse(localStorage.getItem("vokabeln")||"[]").map(normalize);
  const saveLocal=v=>{localStorage.setItem("vokabeln",JSON.stringify(v));localStorage.setItem("vokabeln_updated",new Date().toISOString());};

  const snackbar=$("#updateSnackbar");
  const showSnackbar=(onUpdate)=>{snackbar.classList.add("show");
    snackbar.querySelector(".updateNow").onclick=()=>{snackbar.classList.remove("show");onUpdate();};
    snackbar.querySelector(".later").onclick=()=>snackbar.classList.remove("show");
    setTimeout(()=>snackbar.classList.remove("show"),15000);
  };

  /* Mini-Hash (djb2) */
  function hashString(str){let h=5381;for(let i=0;i<str.length;i++){h=((h<<5)+h)+str.charCodeAt(i);h|=0;}return String(h);}

  const SYNC_URLS=["./vokabeln.json","vokabeln.json",window.location.origin+"/vokabeln.json",window.location.origin+"/vokabeltrainer/vokabeln.json"];

  async function fetchNewestJsonCandidate(){
    let best={date:0,hash:"",data:null,url:""};
    for(const url of SYNC_URLS){
      try{
        const r=await fetch(url,{cache:"no-store"});
        if(!r.ok)continue;
        const txt=await r.text();
        const data=JSON.parse(txt);
        if(!Array.isArray(data))continue;
        const remoteDate=new Date(r.headers.get("last-modified")||0).getTime();
        const h=hashString(txt);
        if(remoteDate>best.date || (remoteDate===best.date && h!==best.hash)){best={date:remoteDate,hash:h,data,url};}
      }catch(e){/* ignore */}
    }
    return best.data?best:null;
  }

  async function trySyncFromJson(force=false){
    const status=$("#datasourceStatus");
    const candidate=await fetchNewestJsonCandidate();
    const localUpdate=new Date(localStorage.getItem("vokabeln_updated")||0).getTime();
    const localHash=localStorage.getItem("vokabeln_remote_hash")||"";

    if(candidate){
      const newer = candidate.date>localUpdate || (candidate.hash && candidate.hash!==localHash);
      if(newer && !force){
        showSnackbar(()=>{ saveLocal(candidate.data.map(normalize)); localStorage.setItem("vokabeln_remote_hash",candidate.hash); status.textContent="📂 Datenquelle: "+candidate.url; refreshUI(); });
      }else if(force){
        saveLocal(candidate.data.map(normalize)); localStorage.setItem("vokabeln_remote_hash",candidate.hash);
        status.textContent="📂 Manuell aktualisiert"; refreshUI();
      }else if(localStorage.getItem("vokabeln")){
        status.textContent="💾 Lokaler Speicher aktiv";
      }else{
        const def=[["hammer","Hammer","Pink","","","2025-10-26T12:00:00Z"]];
        saveLocal(def); status.textContent="✨ Standardliste verwendet"; refreshUI();
      }
    }else{
      if(localStorage.getItem("vokabeln")) status.textContent="💾 Lokaler Speicher aktiv";
      else{ const def=[["hammer","Hammer","Pink","","","2025-10-26T12:00:00Z"]]; saveLocal(def); status.textContent="✨ Standardliste verwendet"; refreshUI(); }
    }
  }

  /* Trainer-Logik (einfach gehalten, Layoutfreundlich) */
  let words=[], idx=-1, right=0, wrong=0;
  function pickNext(){
    if(!words.length){ $("#qEn").value="–"; $("#qDe").value=""; $("#qDe").type="password"; return; }
    idx = Math.floor(Math.random()*words.length);
    $("#qEn").value = words[idx][0];
    $("#qDe").value = words[idx][1];
    $("#qDe").type = "password";
  }
  function renderStats(){ $("#statsLine").textContent=`🔢 Richtig: ${right} | Falsch: ${wrong}`; }

  function renderRecent(){
    const list=loadLocal();
    const ul=$("#recentList");
    const sorted=[...list].sort((a,b)=>new Date(b[5])-new Date(a[5]));
    const last5=sorted.slice(0,5);
    ul.innerHTML= last5.map(v=>`<li><span>${v[0]}</span> → ${v[1]} <small style="color:#777;">(${new Date(v[5]).toLocaleString("de-DE")})</small></li>`).join("")
      || "<li><em>Keine Einträge</em></li>";
  }

  function refreshUI(){
    words = loadLocal();
    renderRecent();
    pickNext();
  }

  // Events
  $("#showAnswer").onclick=()=>{$("#qDe").type="text";};
  $("#markRight").onclick=()=>{right++;renderStats();pickNext();};
  $("#markWrong").onclick=()=>{wrong++;renderStats();pickNext();};
  $("#nextWord").onclick=()=>pickNext();
  $("#reloadJson").onclick=async()=>{await trySyncFromJson(true);};

  // Echtzeit-Update aus anderen Tabs/Seiten
  window.addEventListener("storage",e=>{
    if(e.key==="vokabeln"||e.key==="vokabeln_updated"){
      refreshUI();
      $("#datasourceStatus").textContent="🔄 Automatisch aktualisiert (Synchronisierung erkannt)";
    }
  });

  (async function init(){
    await trySyncFromJson();
    refreshUI();
    renderStats();
  })();
})();
</script>
</body>
</html>
