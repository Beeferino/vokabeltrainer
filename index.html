<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>📘 Vokabelübersicht</title>
<style>
  /* ——— Grundlayout wie index.html (hell, clean) ——— */
  body{font-family:"Segoe UI",Roboto,sans-serif;background:#f7f9fb;margin:0;padding:20px;text-align:center;color:#111;}
  .app{max-width:1100px;margin:auto;}
  h1{font-size:1.8rem;margin-bottom:.6rem}
  h2{font-size:1.1rem;margin:0 0 .6rem}
  .section{background:#fff;padding:16px 20px;border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:18px}
  .flex{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
  button,input,select{padding:8px 10px;font-size:1rem;border-radius:8px;border:1px solid #ccc;margin:5px}
  button{cursor:pointer;background:#2980b9;color:#fff;border:none;transition:background .2s ease,transform .1s ease}
  button:hover{background:#3498db;transform:translateY(-1px)}
  .chip{display:inline-block;padding:5px 10px;border-radius:10px;color:#fff;font-size:.9rem}
  .divider{border:0;border-top:3px solid #e3e7ef;margin:18px 0}
  .subdivider{border:0;border-top:1px solid #e6e9f0;margin:14px 0}

  /* Tabelle */
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left}
  th{background:#eef3ff;cursor:pointer;user-select:none;position:relative}
  th:hover{background:#e2ebff}
  tr:hover{background:#f4f9ff}
  th.sort-asc::after{content:"▲";position:absolute;right:8px;color:#2980b9}
  th.sort-desc::after{content:"▼";position:absolute;right:8px;color:#2980b9}

  /* Lexica A–Z */
  .lexica{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:8px 0 4px}
  .lexica button{background:#ecf0f1;color:#333;border:1px solid #ccc;font-weight:600;padding:6px 9px;border-radius:8px}
  .lexica button.active{background:#2980b9;color:#fff}

  /* Paginierung */
  .pagination{display:flex;justify-content:center;gap:8px;margin-top:10px}
  .pagination button{background:#ecf0f1;color:#333;border:1px solid #ccc;padding:6px 10px}
  .pagination button.active{background:#2980b9;color:#fff}

  /* Modal (Details/ Bearbeiten) */
  #modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
  #modalContent{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.3);min-width:280px;max-width:460px;width:92%}
  #modalContent h3{margin-top:0}
  #modalContent input, #modalContent select{width:100%;box-sizing:border-box;margin:6px 0}

  /* Toast + Sync-Status */
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#2ecc71;color:#fff;padding:10px 16px;border-radius:8px;display:none;z-index:999}
  #datasourceStatus{position:fixed;right:12px;bottom:10px;font-size:.8rem;opacity:.75;color:#555;pointer-events:none}

  /* Footer */
  .footer{margin-top:8px;font-size:.95rem;color:#555}
  .last-change{margin-top:12px;font-size:.9rem;color:#555}

  /* Mobile */
  @media (max-width: 768px){
    body{padding:12px}
    th,td{padding:8px}
    button,input,select{font-size:.95rem}
    .section{padding:14px 12px}
  }
</style>
</head>
<body>
  <div class="app">
    <h1>📘 Vokabelübersicht</h1>
    <div id="syncBadge" style="font-size:.9rem;color:#555;opacity:.9;margin-bottom:8px;">🔄 JSON wird synchronisiert…</div>

    <!-- A–Z -->
    <div id="lexica" class="lexica"></div>

    <!-- Filter & Suche -->
    <div class="section">
      <h2>🔍 Filter & Suche</h2>
      <div class="flex">
        <label>Kategorie:
          <select id="filterCat">
            <option value="Alle">Alle (bunt gemischt)</option>
          </select>
        </label>
        <input id="searchInput" type="text" placeholder="🔎 Suchen (EN / DE)">
        <button id="resetFilter">🔄 Filter zurücksetzen</button>
      </div>
    </div>

    <!-- Vokabelliste -->
    <div class="section">
      <h2>📄 Vokabelliste</h2>
      <table id="vokabelTable">
        <thead>
          <tr>
            <th data-col="0">Englisch</th>
            <th data-col="1">Deutsch</th>
            <th data-col="2">Kategorie</th>
            <th style="width:110px;">Aktion</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="pagination" class="pagination"></div>
      <div id="infoFooter" style="margin-top:6px;font-size:.95rem;color:#555;"></div>
    </div>

    <!-- Neue Vokabel -->
    <div class="section">
      <h2>➕ Neue Vokabel hinzufügen</h2>
      <div class="flex">
        <input id="newEn" type="text" placeholder="Englisch">
        <input id="newDe" type="text" placeholder="Deutsch">
        <select id="newCat"></select>
        <input id="newGroup" type="text" placeholder="Gruppe / Variante">
        <input id="newHint" type="text" placeholder="Hinweis">
        <button id="addBtn">Hinzufügen</button>
      </div>
    </div>

    <hr class="divider">

    <!-- JSON / Datei – kompakt -->
    <div class="section">
      <h2>💾 JSON & Synchronisierung</h2>
      <div class="flex">
        <button id="syncBtn">🔄 Von GitHub neu laden (Merge)</button>
        <button id="downloadBtn" disabled>💾 Aktualisierte vokabeln.json herunterladen</button>
      </div>
      <div class="subdivider"></div>
      <div id="syncInfo" style="font-size:.95rem;color:#555;">Quelle: – | Letzter Abgleich: –</div>
    </div>

    <hr class="divider">

    <!-- Zuletzt hinzugefügt -->
    <div class="section">
      <h2>🧾 Zuletzt hinzugefügt</h2>
      <div id="lastAdded">–</div>
    </div>

    <div class="footer">
      <button onclick="location.href='index.html'">⬅️ Zurück zum Trainer</button>
      <div class="last-change" id="lastChange">📅 Letzte Änderung: –</div>
      <p>© 2025 @Beefi</p>
    </div>
  </div>

  <!-- Modal: Details / Bearbeiten -->
  <div id="modal">
    <div id="modalContent">
      <h3>🔍 Vokabel-Details</h3>
      <input id="editEn" type="text" placeholder="Englisch" readonly>
      <input id="editDe" type="text" placeholder="Deutsch" readonly>
      <select id="editCat" disabled></select>
      <input id="editGroup" type="text" placeholder="Gruppe / Variante" readonly>
      <input id="editHint" type="text" placeholder="Hinweis" readonly>
      <div class="flex" style="margin-top:6px;">
        <button id="toggleEdit">🔧 Bearbeiten</button>
        <button id="closeModal">❌ Schließen</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Gespeichert</div>
  <div id="datasourceStatus" aria-live="polite">🔄 JSON + lokale Ergänzungen (gemergt)</div>

<script>
(() => {
  /* ===== Konfiguration / Konstanten ===== */
  const REMOTE_JSON_URL = 'vokabeln.json'; // relativ zu GitHub Pages Root (z.B. /vokabeltrainer/vokabeln.json)
  const CATEGORY_NAMES = {
    Gelb:"Grundwerkzeuge Metallverarbeitung", Pink:"Werkzeugkasten Mechaniker",
    Blau:"Blech- / Kunststoffarbeiten", Gruen:"Drehen / Fräsen",
    HellesPink:"Hydraulik / Pneumatik", Orange:"Elektrotechnik",
    Dunkelgruen:"Fluggerätemechanik allgemein", Rot:"Verwechslungsgefahr"
  };
  const COLOR_MAP = {
    Gelb:"#F4D03F", Pink:"#E91E63", Blau:"#1976D2", Gruen:"#1E8449",
    HellesPink:"#F54927", Orange:"#E67E22", Dunkelgruen:"#117A65", Rot:"#C0392B"
  };

  /* ===== Helpers ===== */
  const $=s=>document.querySelector(s);
  const $$=s=>document.querySelectorAll(s);
  const toast=(m,color="#2ecc71")=>{const t=$("#toast");t.textContent=m;t.style.background=color;t.style.display="block";setTimeout(()=>t.style.display="none",1500);};
  const normalize=v=>[v[0]||"",v[1]||"",v[2]||"Gelb",v[3]||"",v[4]||"",v[5]||new Date().toISOString()];
  const keyOf=v=>`${(v[0]||"").toLowerCase().trim()}|${(v[1]||"").toLowerCase().trim()}`; // EN|DE

  const loadLocal = () => (JSON.parse(localStorage.getItem("vokabeln")||"[]")).map(normalize);
  const saveLocal = (list) => { localStorage.setItem("vokabeln", JSON.stringify(list)); localStorage.setItem("vokabeln_updated", new Date().toISOString()); };
  const setLastChange = () => { const upd=localStorage.getItem("vokabeln_updated"); $("#lastChange").textContent = `📅 Letzte Änderung: ${upd? new Date(upd).toLocaleString("de-DE"):"–"}`; };

  // Merge: remote first, then local overrides/additions
  function merge(remote, local){
    const map=new Map();
    remote.map(normalize).forEach(v=>map.set(keyOf(v), v));
    local.map(normalize).forEach(v=>map.set(keyOf(v), v)); // lokale Änderungen haben Vorrang
    return Array.from(map.values());
  }

  async function fetchRemote(){
    try{
      const r=await fetch(REMOTE_JSON_URL,{cache:'no-store'});
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j=await r.json();
      return Array.isArray(j)? j: [];
    }catch(e){
      return null; // offline/fehler
    }
  }

  function enableDownloadMerged(list){
    const btn=$("#downloadBtn");
    btn.disabled=false;
    const blob=new Blob([JSON.stringify(list,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    btn.onclick=()=>{const a=document.createElement("a");a.href=url;a.download="vokabeln.json";a.click();};
  }

  function fillCategorySelect(sel){
    sel.innerHTML="";
    for(const k in CATEGORY_NAMES){
      const o=document.createElement("option");
      o.value=k; o.textContent=CATEGORY_NAMES[k];
      o.style.background=COLOR_MAP[k]; o.style.color="#fff";
      sel.appendChild(o);
    }
  }

  // A–Z bar
  function renderLexica(currentLetter){
    const letters=["Alle",..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"];
    const lx=$("#lexica"); lx.innerHTML="";
    letters.forEach(l=>{
      const b=document.createElement("button");
      b.textContent=l; if(l===currentLetter) b.classList.add("active");
      b.onclick=()=>{ state.letter=l; state.page=1; renderTable(); renderLexica(state.letter); };
      lx.appendChild(b);
    });
  }

  /* ===== State ===== */
  const state = {
    list: [],
    filtered: [],
    page: 1,
    perPage: 15,
    sortCol: 0,
    sortAsc: true,
    letter: "Alle",
    filterCat: "Alle",
    search: ""
  };

  /* ===== UI: Rendering ===== */
  function applyFilterSort(){
    const {list, letter, filterCat, search, sortCol, sortAsc} = state;
    // Filter
    let arr = list.filter(([en,de,cat,grp,hint])=>{
      if(letter!=="Alle" && !en.toUpperCase().startsWith(letter)) return false;
      if(filterCat!=="Alle" && cat!==filterCat) return false;
      if(search){ const hay=(en+" "+de).toLowerCase(); if(!hay.includes(search)) return false; }
      return true;
    });
    // Sort
    arr.sort((a,b)=>{
      const x=(a[sortCol]||"").toString().toLowerCase();
      const y=(b[sortCol]||"").toString().toLowerCase();
      if(x<y) return state.sortAsc? -1:1;
      if(x>y) return state.sortAsc? 1:-1;
      return 0;
    });
    state.filtered = arr;
  }

  function renderTable(){
    applyFilterSort();
    const {filtered, page, perPage} = state;
    const pages = Math.max(1, Math.ceil(filtered.length / perPage));
    if(state.page > pages) state.page = pages;
    const start = (state.page-1)*perPage;
    const rows = filtered.slice(start, start+perPage);

    // tbody
    const tb=$("#vokabelTable tbody"); tb.innerHTML="";
    rows.forEach(v=>{
      const i = state.list.indexOf(v);
      const [en,de,cat] = v;
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${en}</td>
        <td>${de}</td>
        <td><span class="chip" style="background:${COLOR_MAP[cat]}">${CATEGORY_NAMES[cat]}</span></td>
        <td>
          <button class="viewBtn" data-i="${i}">🔍</button>
          <button class="delBtn" data-i="${i}">🗑️</button>
        </td>`;
      tb.appendChild(tr);
    });

    // Pagination
    const pg=$("#pagination"); pg.innerHTML="";
    for(let p=1;p<=pages;p++){
      const b=document.createElement("button");
      b.textContent=p; if(p===state.page) b.classList.add("active");
      b.onclick=()=>{ state.page=p; renderTable(); };
      pg.appendChild(b);
    }

    // Info-Footer
    $("#infoFooter").textContent =
      `📚 Gesamt: ${state.list.length} | 🔎 Gefiltert: ${state.filtered.length} | 📄 Seite ${state.page}/${pages}`;

    // Bind row buttons
    $$(".viewBtn").forEach(b=> b.onclick = () => openView(parseInt(b.dataset.i)));
    $$(".delBtn").forEach(b=> b.onclick = () => onDelete(parseInt(b.dataset.i)));
  }

  function renderLastAdded(){
    const div=$("#lastAdded");
    const list=state.list;
    if(!list.length){ div.textContent="Keine Vokabeln vorhanden."; return; }
    const last=list.slice(-5).reverse();
    div.innerHTML = last.map(v => `<div><b>${v[0]}</b> – ${v[1]} <span style="color:${COLOR_MAP[v[2]]}">(${CATEGORY_NAMES[v[2]]})</span></div>`).join("");
  }

  function updateSortIndicators(){
    $$("th[data-col]").forEach(th=>th.classList.remove("sort-asc","sort-desc"));
    const active=$(`th[data-col="${state.sortCol}"]`);
    if(active) active.classList.add(state.sortAsc? "sort-asc":"sort-desc");
  }

  /* ===== Modal: View/Edit ===== */
  function setReadonlyModal(isReadonly){
    $("#editEn").readOnly = isReadonly;
    $("#editDe").readOnly = isReadonly;
    $("#editGroup").readOnly = isReadonly;
    $("#editHint").readOnly = isReadonly;
    $("#editCat").disabled = isReadonly;
  }

  let editIndex = null;

  function openView(i){
    editIndex = i;
    const [en,de,cat,grp,hint] = state.list[i];
    $("#editEn").value=en; $("#editDe").value=de; $("#editCat").value=cat;
    $("#editGroup").value=grp||""; $("#editHint").value=hint||"";
    setReadonlyModal(true);
    $("#toggleEdit").textContent="🔧 Bearbeiten";
    $("#modal").style.display="flex";
  }

  $("#toggleEdit").onclick = () => {
    if($("#toggleEdit").textContent.includes("Bearbeiten")){
      setReadonlyModal(false);
      $("#toggleEdit").textContent="💾 Speichern";
    }else{
      const v=state.list[editIndex];
      v[0]=$("#editEn").value.trim();
      v[1]=$("#editDe").value.trim();
      v[2]=$("#editCat").value;
      v[3]=$("#editGroup").value.trim();
      v[4]=$("#editHint").value.trim();
      v[5]=new Date().toISOString();
      // persist + refresh + download enable
      saveLocal(state.list);
      setLastChange();
      renderTable(); renderLastAdded();
      enableDownloadMerged(state.list);
      toast("💾 Gespeichert");
      setReadonlyModal(true);
      $("#toggleEdit").textContent="🔧 Bearbeiten";
    }
  };
  $("#closeModal").onclick = () => $("#modal").style.display="none";

  /* ===== CRUD ===== */
  function onDelete(i){
    if(!confirm("Diese Vokabel löschen?")) return;
    state.list.splice(i,1);
    saveLocal(state.list);
    setLastChange();
    renderTable(); renderLastAdded();
    enableDownloadMerged(state.list);
    toast("🗑️ Gelöscht","#e74c3c");
  }

  $("#addBtn").onclick = () => {
    const en=$("#newEn").value.trim(),
          de=$("#newDe").value.trim(),
          cat=$("#newCat").value,
          grp=$("#newGroup").value.trim(),
          hint=$("#newHint").value.trim();
    if(!en || !de || !cat) return alert("Bitte Englisch, Deutsch und Kategorie ausfüllen.");
    state.list.push([en,de,cat,grp,hint,new Date().toISOString()]);
    saveLocal(state.list);
    setLastChange();
    $("#newEn").value=$("#newDe").value=$("#newGroup").value=$("#newHint").value="";
    renderTable(); renderLastAdded();
    enableDownloadMerged(state.list);
    toast("➕ Hinzugefügt");
  };

  /* ===== Filter / Suche / Sort ===== */
  $("#filterCat").onchange = e => { state.filterCat=e.target.value; state.page=1; renderTable(); };
  $("#searchInput").oninput = e => { state.search=e.target.value.trim().toLowerCase(); state.page=1; renderTable(); };
  $("#resetFilter").onclick = () => {
    state.search=""; $("#searchInput").value="";
    state.filterCat="Alle"; $("#filterCat").value="Alle";
    state.letter="Alle"; renderLexica(state.letter);
    state.page=1; renderTable();
  };

  $$("th[data-col]").forEach(th=>{
    th.onclick=()=>{
      const col = parseInt(th.dataset.col);
      if(state.sortCol===col) state.sortAsc = !state.sortAsc;
      else { state.sortCol=col; state.sortAsc=true; }
      updateSortIndicators();
      renderTable();
    };
  });

  /* ===== Sync & Init ===== */
  async function initialSync(){
    $("#syncBadge").textContent="🔄 JSON wird synchronisiert…";
    const remote = await fetchRemote();      // kann null sein (offline)
    const local  = loadLocal();              // lokale Änderungen
    let merged;
    let source="";
    if(remote){ merged = merge(remote, local); source="GitHub + Lokal (gemergt)"; }
    else{ merged = local; source="Lokal (offline)"; }

    // Persistiere den Merge als neuen lokalen Stand
    state.list = merged.map(normalize);
    saveLocal(state.list);
    setLastChange();

    // UI auffrischen
    renderLexica(state.letter);
    renderTable();
    renderLastAdded();

    // Dropdowns füllen
    const selNew=$("#newCat"), selEdit=$("#editCat"), selFilter=$("#filterCat");
    fillCategorySelect(selNew); fillCategorySelect(selEdit);
    // Filter-Kategorien (mit "Alle")
    selFilter.innerHTML = "<option value='Alle'>Alle (bunt gemischt)</option>";
    for(const k in CATEGORY_NAMES){
      const o=document.createElement("option");
      o.value=k; o.textContent=CATEGORY_NAMES[k];
      o.style.background=COLOR_MAP[k]; o.style.color="#fff";
      selFilter.appendChild(o);
    }

    // Sort-Indikatoren initial auf Englisch
    state.sortCol=0; state.sortAsc=true; updateSortIndicators();

    // Sync-Badges
    $("#datasourceStatus").textContent = remote ? "📂 Datenquelle: GitHub JSON (gemergt mit lokalen Änderungen)" : "💾 Datenquelle: Lokaler Speicher (offline)";
    $("#syncInfo").textContent = `Quelle: ${source} | Letzter Abgleich: ${new Date().toLocaleString("de-DE")}`;
    $("#syncBadge").textContent = `✅ Synchronisiert – Quelle: ${source}`;

    // Download der aktualisierten JSON aktivieren
    enableDownloadMerged(state.list);
  }

  // Manuelles Re-Sync (z. B. nach Upload auf GitHub)
  $("#syncBtn").onclick = async () => {
    $("#syncBadge").textContent="🔄 JSON wird synchronisiert…";
    await initialSync();
    toast("🔄 JSON neu geladen & gemergt");
  };

  // Start
  initialSync();
})();
</script>
</body>
</html>
