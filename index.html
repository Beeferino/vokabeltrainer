<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß† Vokabeltrainer</title>
  <style>
    body { font-family: sans-serif; background: #f5f7fa; margin: 0; padding: 20px; text-align: center; }
    .app { max-width: 700px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { font-size: 1.8rem; margin-bottom: 0.4rem; }
    h2 { font-size: 1.2rem; margin-top: 1.4rem; color: #555; }
    button { padding: 10px 14px; margin: 6px; border: none; border-radius: 8px; background: #3498db; color: #fff; font-size: 1rem; cursor: pointer; }
    button:hover { background: #2980b9; }
    input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 70%; font-size: 1rem; }
    .hidden { display: none; }
    #trainer { margin-top: 25px; }
    #wordBox { font-size: 1.4rem; margin-bottom: 12px; }
    #feedback { margin-top: 10px; font-weight: bold; }
    footer { margin-top: 40px; font-size: 0.9rem; color: #777; }
    #datasourceStatus{position:fixed;right:12px;bottom:10px;font-size:.8rem;opacity:.75;color:#555;}
    #recentWrapper { margin-top:20px; }
    #recentHeader { cursor:pointer; font-weight:600; display:inline-block; background:#e9f2ff; color:#004085; padding:8px 12px; border-radius:8px; }
    #recentList { display:none; background:#fff; border:1px solid #ccd; border-radius:8px; padding:10px; margin-top:6px; max-width:500px; margin-inline:auto; text-align:left; }
    #recentUl { list-style:none; padding:0; margin:0; }
    #recentUl li { padding:4px 0; border-bottom:1px dashed #ddd; }
    #recentUl li:last-child { border-bottom:none; }
  </style>
</head>
<body>
  <div class="app">
    <h1>üß† Vokabeltrainer</h1>
    <p>W√§hle einen Modus:</p>
    <button id="startTrainer">üìñ Vokabel-Abfrage starten</button>
    <button id="last30">üïì Letzte 30 Vokabeln</button>
    <button id="flashcards">üóÇÔ∏è Karteikarten spielen</button>
    <br><br>
    <a href="vokabeln.html"><button>üìò Vokabel√ºbersicht √∂ffnen</button></a>

    <!-- üîπ Zuletzt hinzugef√ºgt -->
    <div id="recentWrapper">
      <div id="recentHeader">üìú Zuletzt hinzugef√ºgt (anzeigen)</div>
      <div id="recentList">
        <ul id="recentUl"></ul>
      </div>
    </div>

    <div id="trainer" class="hidden">
      <div id="wordBox"></div>
      <input type="text" id="answerInput" placeholder="√úbersetzung eingeben...">
      <br>
      <button id="checkBtn">Pr√ºfen</button>
      <button id="skipBtn">√úberspringen</button>
      <div id="feedback"></div>
    </div>

    <footer>
      <br>
      <small>¬© 2025 @Beefi</small>
    </footer>
  </div>

  <div id="datasourceStatus" aria-live="polite">üìÇ Datenquelle: wird gepr√ºft‚Ä¶</div>

  <script>
  (() => {
    // --- Konstanten ---
    const CATEGORY_NAMES = { Gelb:"Grundwerkzeuge Metallverarbeitung", Pink:"Werkzeugkasten Mechaniker", Blau:"Blech- / Kunststoffarbeiten", Gruen:"Drehen / Fr√§sen", HellesPink:"Hydraulik / Pneumatik", Orange:"Elektrotechnik", Dunkelgruen:"Flugger√§temechanik allgemein", Rot:"Verwechslungsgefahr" };
    const COLOR_MAP = { Gelb:"#F4D03F", Pink:"#E91E63", Blau:"#1976D2", Gruen:"#1E8449", HellesPink:"#F54927", Orange:"#E67E22", Dunkelgruen:"#117A65", Rot:"#C0392B" };

    const $ = s => document.querySelector(s);
    const statusEl = $("#datasourceStatus");

    const normalize = v => [v[0]||"",v[1]||"",v[2]||"Gelb",v[3]||"",v[4]||"",v[5]||new Date().toISOString()];
    const loadLocal = () => JSON.parse(localStorage.getItem("vokabeln") || "[]").map(normalize);
    const saveLocal = v => { localStorage.setItem("vokabeln", JSON.stringify(v)); localStorage.setItem("vokabeln_updated", new Date().toISOString()); };

    function keyOf(v){ return `${(v[0]||"").toLowerCase().trim()}|${(v[1]||"").toLowerCase().trim()}`; }
    function mergeVocabLists(remote, local) {
      const map=new Map();
      remote.map(normalize).forEach(v=>map.set(keyOf(v),v));
      local.map(normalize).forEach(v=>{ if(!map.has(keyOf(v))) map.set(keyOf(v),v); });
      return Array.from(map.values());
    }

    async function trySyncFromJson() {
      const urls = ["./vokabeln.json","vokabeln.json",window.location.origin+"/vokabeln.json",window.location.origin+"/vokabeltrainer/vokabeln.json"];
      let remote = null;
      for (const u of urls) {
        try { const r = await fetch(u, {cache:"no-store"}); if(!r.ok) continue;
          const d = await r.json(); if(Array.isArray(d)) { remote=d; break; } } catch {}
      }
      const local = loadLocal();
      if (!remote && local.length===0) {
        const def=[["hammer","Hammer","Pink","","","2025-01-01T00:00:00Z"],["file","Feile","Gelb","","","2025-01-01T00:00:00Z"],["drill","Bohrer","Pink","","","2025-01-01T00:00:00Z"]];
        saveLocal(def); statusEl.textContent="‚ú® Standardliste verwendet";
      } else if (remote) {
        saveLocal(mergeVocabLists(remote, local));
        statusEl.textContent="üîÑ JSON + lokale Erg√§nzungen (gemergt)";
      } else {
        statusEl.textContent="üíæ Lokaler Speicher (Offline)";
      }
      vocabList = loadLocal();
      renderRecent();
    }

    // === Trainer-Logik ===
    let vocabList = [];
    let currentList = [];
    let currentIndex = 0;

    function startTrainer(mode) {
      $("#trainer").classList.remove("hidden");
      currentList = [...vocabList];
      if (mode === "last30") currentList = vocabList.slice(-30);
      if (mode === "flashcards") shuffle(currentList);
      currentIndex = 0;
      showWord();
    }

    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

    function showWord() {
      if (currentIndex >= currentList.length) {
        $("#wordBox").textContent = "üéâ Alle Vokabeln durch!";
        $("#answerInput, #checkBtn, #skipBtn").forEach ? $("#answerInput").disabled = true : null;
        return;
      }
      const [en,de,cat,grp,hint] = currentList[currentIndex];
      $("#wordBox").innerHTML = `<b>${en}</b><br><small style='color:#666'>(${CATEGORY_NAMES[cat] || cat})</small><br><small>${hint || ""}</small>`;
      $("#feedback").textContent = "";
      $("#answerInput").value = "";
      $("#answerInput").focus();
    }

    $("#checkBtn").onclick = () => {
      const answer = $("#answerInput").value.trim().toLowerCase();
      const correct = currentList[currentIndex][1].toLowerCase();
      $("#feedback").textContent = (answer === correct)
        ? "‚úÖ Richtig!"
        : `‚ùå Falsch! Richtig: ${currentList[currentIndex][1]}`;
      currentIndex++;
      setTimeout(showWord, 1000);
    };

    $("#skipBtn").onclick = () => { currentIndex++; showWord(); };

    // === Zuletzt hinzugef√ºgt ===
    function renderRecent() {
      const list = loadLocal();
      const ul = document.getElementById("recentUl");
      ul.innerHTML = "";
      const last = list.slice(-5).reverse();
      if (last.length === 0) {
        ul.innerHTML = "<li><em>Keine Vokabeln vorhanden.</em></li>";
        return;
      }
      last.forEach(([en,de,cat]) => {
        const color = COLOR_MAP[cat] || "#777";
        const li = document.createElement("li");
        li.innerHTML = `<b>${en}</b> ‚Äì ${de} <span style="color:${color}; font-size:0.9em;">(${CATEGORY_NAMES[cat] || cat})</span>`;
        ul.appendChild(li);
      });
    }

    const header = document.getElementById("recentHeader");
    const listDiv = document.getElementById("recentList");
    header.addEventListener("click", () => {
      const open = listDiv.style.display === "block";
      listDiv.style.display = open ? "none" : "block";
      header.textContent = open ? "üìú Zuletzt hinzugef√ºgt (anzeigen)" : "üìú Zuletzt hinzugef√ºgt (verbergen)";
    });

    // === INIT ===
    (async function init() {
      await trySyncFromJson();
      $("#startTrainer").onclick = () => startTrainer("normal");
      $("#last30").onclick = () => startTrainer("last30");
      $("#flashcards").onclick = () => startTrainer("flashcards");
    })();
  })();
  </script>
</body>
</html>
