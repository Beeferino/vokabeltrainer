<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vokabeltrainer</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#6b7280;
    --primary:#2563eb;
    --primary-2:#1d4ed8;
    --green:#22c55e;
    --red:#ef4444;
    --amber:#f59e0b;
    --chip:#f1f5f9;
    --chip-ink:#0f172a;
    --ring:rgba(37,99,235,.3);
    --shadow:0 8px 30px rgba(2,8,23,0.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink);
    background:linear-gradient(180deg,#eef3ff 0%, #f7f9ff 60%, #ffffff 100%);
  }
  .wrap{
    max-width:980px;
    margin:32px auto;
    padding:16px;
  }
  .app{
    background:var(--card);
    border-radius:20px;
    box-shadow:var(--shadow);
    padding:28px 24px 20px;
  }
  h1{
    margin:0 0 4px;
    font-size:28px;
    text-align:center;
    letter-spacing:.2px;
  }
  .title-accent{
    display:flex;align-items:center;justify-content:center;gap:10px;
    margin:6px 0 18px;
  }
  .title-accent:before,.title-accent:after{
    content:"";height:3px;width:180px;border-radius:999px;
    background:linear-gradient(90deg,transparent, var(--primary),transparent);
    filter:blur(.5px)
  }

  .controls{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    gap:14px;
    align-items:center;
    justify-items:center;
    margin-bottom:10px;
  }
  .row{
    display:flex;flex-wrap:wrap;gap:12px;justify-content:center;
  }
  label{font-size:14px;color:var(--muted)}
  select, input[type="text"]{
    font:inherit;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #dbe2f1;
    background:#fff;
    min-width:220px;
    outline:none;
  }
  select:focus, input[type="text"]:focus{box-shadow:0 0 0 4px var(--ring);border-color:var(--primary)}

  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 14px;border-radius:12px;
    background:var(--primary);color:#fff;border:none;cursor:pointer;
    font-weight:600; box-shadow:0 6px 18px rgba(37,99,235,.18);
    transition:.18s transform, .18s filter, .18s background;
  }
  .btn:hover{background:var(--primary-2); transform:translateY(-1px)}
  .btn.secondary{background:#e5ecff; color:#1f3a8a; box-shadow:none}
  .btn.grey{background:#e5e7eb;color:#111827;box-shadow:none}
  .btn.green{background:var(--green)}
  .btn.red{background:var(--red)}
  .btn.flat{background:#eef2ff;color:#1f3a8a;box-shadow:none}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

  /* Spielcontainer */
  .stageShell{
    position:relative;
    margin:18px 0 8px;
    border-radius:16px;
    background:linear-gradient(180deg,#f9fafb 0%, #fff 100%);
    border:1px solid #eef1f7;
    min-height:180px;
    display:none; /* erst sichtbar nach Start */
  }
  .stageShell.show{display:block;}
  .stageShell .blur-cover{
    position:absolute;inset:0;
    backdrop-filter:blur(7px) saturate(1.2);
    -webkit-backdrop-filter:blur(7px) saturate(1.2);
    background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.65));
    border-radius:16px;display:flex;align-items:center;justify-content:center;
    color:var(--muted); font-weight:600; letter-spacing:.2px;
  }
  .stage{ padding:26px 18px 22px; }

  .chip{
    display:inline-block;padding:10px 14px;border-radius:999px;
    background:var(--chip); color:#111827; font-weight:700; font-size:16px;
    box-shadow:inset 0 1px 0 #fff, 0 2px 8px rgba(15,23,42,.06);
    margin:0 auto 12px; text-align:center;
  }
  .chip.cat{ background:#fff7e6; color:#111; border:1px solid #fde68a}
  .word{ font-size:32px; font-weight:800; text-align:center; margin:10px 0 6px }
  .hint{ color:var(--muted); text-align:center; min-height:22px }

  .actions{
    display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:14px;
  }

  .progress{
    text-align:center; color:#334155; font-weight:600; margin:8px 0 2px;
  }

  .ioRow{
    display:flex; gap:8px; justify-content:center; align-items:center; margin-top:10px;
  }
  .ioRow input[type="text"]{
    min-width:420px; height:42px;
  }

  .pillbar{
    display:flex;justify-content:space-between;align-items:center;
    gap:12px;margin-top:16px;
  }

  /* Einklappbox */
  details{
    background:#eef2ff; border:1px solid #e2e8ff; border-radius:12px; padding:8px 10px;
  }
  summary{cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px; justify-content:center; font-weight:700; color:#1e40af}
  summary::-webkit-details-marker{display:none}
  .lastList{ padding:8px 2px 4px; text-align:center; }
  .lastList div{ margin:2px 0 }

  .source{ text-align:center; color:#64748b; margin-top:8px; font-size:14px}
  .footerRow{
    display:flex;justify-content:space-between;align-items:center; gap:12px; margin-top:10px;
  }
  .floatingBar{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <h1>üéØ Vokabeltrainer</h1>
      <div class="title-accent" aria-hidden="true"></div>

      <div class="controls">
        <label> Kategorie:
          <select id="category">
            <option value="Alle">Alle (bunt gemischt)</option>
          </select>
        </label>

        <label> Modus:
          <select id="mode">
            <option value="toGerman">Englisch ‚Üí Deutsch</option>
            <option value="toEnglish">Deutsch ‚Üí Englisch</option>
            <option value="mixed" selected>Gemischt</option>
          </select>
        </label>

        <label> Delay:
          <select id="delaySel">
            <option value="1000">1 s</option>
            <option value="3000" selected>3 s</option>
            <option value="5000">5 s</option>
          </select>
        </label>
      </div>

      <div class="row" style="margin-bottom:8px">
        <button class="btn" id="learnBtn">‚úçÔ∏è Vokabel-Abfrage starten</button>
        <button class="btn" id="last30Btn">üóÇÔ∏è Letzte 30</button>
        <button class="btn" id="cardsBtn">üß† Karteikarten starten</button>
      </div>

      <div class="row" style="margin-bottom:6px">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="feedbackToggle" checked>
          <span>Sofortiges Feedback</span>
        </label>
      </div>

      <div class="progress" id="progress" style="display:none"></div>

      <div class="stageShell" id="stageShell">
        <div class="blur-cover" id="blurCover">W√§hle oben einen Spielmodus‚Ä¶</div>
        <div class="stage" id="trainer" style="display:none">
          <div class="chip cat" id="catChip"></div>
          <div class="word" id="word"></div>
          <div class="hint" id="hint"></div>

          <!-- Eingabe-Spiel Zeile -->
          <div class="ioRow" id="inputRow" style="display:none">
            <input id="answerInput" type="text" placeholder="√úbersetzung eingeben‚Ä¶" autocomplete="off">
            <button class="btn flat" id="submitInput">Eingabe</button>
          </div>

          <!-- Karteikarten Buttons -->
          <div class="actions" id="cardBtns" style="display:none">
            <button class="btn green" id="rightBtn">Richtig</button>
            <button class="btn red" id="trapBtn">T√§uschung erkannt</button>
            <button class="btn grey" id="skipBtn">√úberspringen</button>
          </div>

          <!-- Eingabe nach erkannter T√§uschung -->
          <div class="ioRow" id="trapInputRow" style="display:none">
            <input id="trapAnswer" type="text" placeholder="Korrekte √úbersetzung eingeben‚Ä¶" autocomplete="off">
            <button class="btn flat" id="trapSubmit">Eingabe</button>
          </div>
        </div>
      </div>

      <div class="footerRow">
        <div class="floatingBar">
          <button class="btn secondary" id="openVocab">üìò Vokabeln</button>
        </div>
        <button class="btn secondary" id="restartBtn">üîÑ Neustart</button>
      </div>

      <details id="lastBox" style="margin-top:12px;">
        <summary>üÜï Zuletzt hinzugef√ºgt ‚ñæ</summary>
        <div class="lastList" id="lastAddedList">‚Äì</div>
      </details>

      <div class="source" id="datasourceStatus">Datenquelle: ‚Ä¶</div>
      <div class="source">¬© 2025 @Beefi</div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Kategorien
  const CATEGORY_NAMES = {
    Gelb:"Grundwerkzeuge Metallverarbeitung",
    Pink:"Werkzeugkasten Mechaniker",
    Blau:"Blech- / Kunststoffarbeiten",
    Gruen:"Drehen / Fr√§sen",
    HellesPink:"Hydraulik / Pneumatik",
    Orange:"Elektrotechnik",
    Dunkelgruen:"Flugger√§temechanik allgemein",
    Rot:"Verwechslungsgefahr"
  };
  const COLOR_MAP = {
    Gelb:"#F4D03F", Pink:"#E91E63", Blau:"#1976D2", Gruen:"#1E8449",
    HellesPink:"#F54927", Orange:"#E67E22", Dunkelgruen:"#117A65", Rot:"#C0392B"
  };

  // UI Elements
  const statusEl = document.getElementById('datasourceStatus');
  const catSel   = document.getElementById('category');
  const modeSel  = document.getElementById('mode');
  const delaySel = document.getElementById('delaySel');
  const feedbackToggle = document.getElementById('feedbackToggle');

  const learnBtn = document.getElementById('learnBtn');
  const cardsBtn = document.getElementById('cardsBtn');
  const last30Btn= document.getElementById('last30Btn');

  const stageShell= document.getElementById('stageShell');
  const blurCover = document.getElementById('blurCover');
  const trainer   = document.getElementById('trainer');

  const catChip = document.getElementById('catChip');
  const wordEl  = document.getElementById('word');
  const hintEl  = document.getElementById('hint');

  const inputRow = document.getElementById('inputRow');
  const answerInput = document.getElementById('answerInput');
  const submitInput = document.getElementById('submitInput');

  const cardBtns = document.getElementById('cardBtns');
  const rightBtn = document.getElementById('rightBtn');
  const trapBtn  = document.getElementById('trapBtn');
  const skipBtn  = document.getElementById('skipBtn');

  const trapInputRow = document.getElementById('trapInputRow');
  const trapAnswer   = document.getElementById('trapAnswer');
  const trapSubmit   = document.getElementById('trapSubmit');

  const progress = document.getElementById('progress');
  const restartBtn = document.getElementById('restartBtn');
  const openVocab  = document.getElementById('openVocab');

  const lastAddedList = document.getElementById('lastAddedList');
  const lastBox = document.getElementById('lastBox');

  // State
  let list = [];
  let round = [];
  let idx = 0;
  let errorsCount = 0;
  let errorRound = [];
  let skipped = [];
  let gameType = null; // 'learn' | 'cards'
  let mode = 'mixed';
  let delay = parseInt(delaySel.value,10);
  let isTrap = false;       // for cards
  let correctAnswer = "";   // holds correct translation for current card
  let shownCandidate = "";  // what we show on card under the word

  // Helpers
  const S = k => JSON.parse(localStorage.getItem(k) || "[]");
  const saveLocal = (key,val) => localStorage.setItem(key, JSON.stringify(val));

  function fillCategories(){
    // keep "Alle"
    for(const k in CATEGORY_NAMES){
      const o = document.createElement('option');
      o.value = k;
      o.textContent = " " + CATEGORY_NAMES[k];
      o.style.backgroundColor = COLOR_MAP[k];
      o.style.color = "#fff";
      catSel.appendChild(o);
    }
  }

  async function syncFromGithub(){
    try{
      const r = await fetch("https://beeferino.github.io/vokabeltrainer/vokabeln.json?ts="+Date.now(), {cache:'no-store'});
      if(!r.ok) throw new Error(r.status);
      const data = await r.json();
      saveLocal("vokabeln", data);
      localStorage.setItem("vokabeln_updated", new Date().toISOString());
      statusEl.textContent = "Datenquelle: GitHub (Online)";
    }catch(e){
      statusEl.textContent = "Datenquelle: Lokaler Speicher";
      if(!localStorage.getItem("vokabeln")){
        // minimal fallback
        const def = [
          ["angle","Winkel","Gelb"],
          ["hammer","Hammer","Pink"],
          ["ruler","Ma√üstab","Gelb"],
          ["broom","Besen","Gelb"]
        ];
        saveLocal("vokabeln", def);
        localStorage.setItem("vokabeln_updated", new Date().toISOString());
      }
    }
  }

  function showStage(){
    stageShell.classList.add('show');
    blurCover.style.display = 'none';
    trainer.style.display = 'block';
  }
  function hideStage(){
    trainer.style.display = 'none';
    blurCover.style.display = 'flex';
    stageShell.classList.add('show'); // Shell sichtbar, Cover sagt ‚Äûw√§hle Modus‚Ä¶‚Äú
  }

  function setCatChip(catKey){
    const name = CATEGORY_NAMES[catKey] || "‚Äî";
    const c = COLOR_MAP[catKey] || "#e2e8f0";
    catChip.textContent = name;
    catChip.style.background = "#fff7e6";
    catChip.style.border = "1px solid #fde68a";
  }

  function selectListByCat(){
    const cat = catSel.value;
    return (cat==="Alle") ? list.slice() : list.filter(v=>v[2]===cat);
  }

  function updateProgress(){
    progress.style.display = 'block';
    progress.textContent = `Vokabel ${idx+1}/${round.length} | Fehler: ${errorsCount}`;
  }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
  }

  function pickAskAns([en,de]){
    // returns {ask, answer, askIsEn}
    if(mode==='toGerman') return {ask:en, answer:de, askIsEn:true};
    if(mode==='toEnglish') return {ask:de, answer:en, askIsEn:false};
    // mixed
    if(Math.random()<0.5) return {ask:en, answer:de, askIsEn:true};
    return {ask:de, answer:en, askIsEn:false};
  }

  function nextOrFinish(){
    idx++;
    // first pass finished
    if(idx>=round.length){
      if(errorRound.length){
        // repeat only errors (keine ‚Äûundefined‚Äú, wir behalten triples)
        round = errorRound.slice();
        errorRound = [];
        idx = 0;
        showToast("üìò Wiederholung der Fehler");
        renderCard();
        return;
      }
      // end
      trainer.innerHTML = `
        <div style="text-align:center;padding:32px 8px">
          <h2 style="margin:0 0 10px">Runde beendet</h2>
          <p style="color:#475569;margin:0 0 14px">Fehler insgesamt: ${errorsCount}</p>
          <button class="btn" onclick="location.reload()">üîÑ Neue Runde</button>
        </div>`;
      return;
    }
    renderCard();
  }

  function showToast(msg){
    hintEl.textContent = msg;
  }

  function startRound(type, custom=null){
    list = S("vokabeln");
    if(!list.length){ alert("Keine Vokabeln gefunden."); return; }
    gameType = type;
    mode = modeSel.value;
    delay = parseInt(delaySel.value,10);

    let pool = custom ? custom.slice() : selectListByCat();
    shuffle(pool);
    round = pool.slice(0,15); // immer 15
    idx = 0;
    errorsCount = 0; errorRound = []; skipped = [];

    showStage();
    renderCard();
  }

  function renderCard(){
    updateProgress();

    const [en,de,cat] = round[idx]; // triple immer vorhanden
    setCatChip(cat);

    const {ask, answer} = pickAskAns([en,de]);
    correctAnswer = answer; // f√ºr beide Modi

    if(gameType==='learn'){
      // Eingabespiel
      cardBtns.style.display = 'none';
      trapInputRow.style.display = 'none';
      inputRow.style.display = 'flex';

      wordEl.textContent = ask;
      hintEl.textContent = ""; // leer, bis Feedback kommt
      answerInput.value = "";
      answerInput.focus();

      const submitAction = () => {
        const ok = answerInput.value.trim().toLowerCase() === correctAnswer.toLowerCase();
        if(feedbackToggle.checked){
          hintEl.textContent = ok ? "‚úÖ Richtig!" : `‚ùå Falsch! Richtige Antwort: ${correctAnswer}`;
        }
        if(!ok){
          errorsCount++;
          errorRound.push([en,de,cat]);
        }
        setTimeout(nextOrFinish, delay);
      };
      submitInput.onclick = submitAction;
      answerInput.onkeydown = (e)=>{ if(e.key==="Enter") submitAction(); };

      // Skip
      skipBtn.onclick = ()=>{ skipped.push([en,de,cat]); nextOrFinish(); };

    } else {
      // Karteikarten ‚Äì Mitdenker Edition
      // jede Karte kann T√§uschung sein
      const pool = list.map(v=>v[1]); // deutsche Antworten-Pool
      const wrong = (()=>{let w; do{ w = pool[Math.floor(Math.random()*pool.length)] } while(w===correctAnswer); return w;})();
      isTrap = Math.random()<0.35; // 35% T√§uschung
      shownCandidate = isTrap ? wrong : correctAnswer;

      wordEl.textContent = ask;
      hintEl.textContent = shownCandidate; // der Kandidat
      inputRow.style.display = 'none';
      trapInputRow.style.display = 'none';
      cardBtns.style.display = 'flex';

      rightBtn.onclick = ()=>{
        // Spieler sagt: Paarung stimmt
        const ok = !isTrap;
        hintEl.textContent = ok ? "‚úÖ Richtig!" : `‚ùå T√§uschung ‚Äì korrekt w√§re: ${correctAnswer}`;
        if(!ok) errorsCount++, errorRound.push([en,de,cat]);
        setTimeout(nextOrFinish, delay);
      };

      trapBtn.onclick = ()=>{
        // Spieler behauptet T√§uschung
        if(isTrap){
          // Eingabe der korrekten L√∂sung verlangen
          cardBtns.style.display = 'none';
          trapInputRow.style.display = 'flex';
          trapAnswer.value = "";
          trapAnswer.focus();

          const check = ()=>{
            const ok = trapAnswer.value.trim().toLowerCase() === correctAnswer.toLowerCase();
            hintEl.textContent = ok ? "‚úÖ Korrektur richtig!" : `‚ùå Falsch ‚Äì korrekt: ${correctAnswer}`;
            if(!ok) errorsCount++, errorRound.push([en,de,cat]);
            setTimeout(nextOrFinish, delay);
          };
          trapSubmit.onclick = check;
          trapAnswer.onkeydown = (e)=>{ if(e.key==="Enter") check(); };

        }else{
          // War gar keine T√§uschung ‚Üí sofort Fehler
          hintEl.textContent = `‚ùå Das war keine T√§uschung. Korrekt: ${correctAnswer}`;
          errorsCount++; errorRound.push([en,de,cat]);
          setTimeout(nextOrFinish, delay);
        }
      };

      skipBtn.onclick = ()=>{ skipped.push([en,de,cat]); nextOrFinish(); };
    }
  }

  // Letzte 5 unten
  function renderLast(){
    const all = S("vokabeln");
    if(!all.length){ lastAddedList.textContent="‚Äì"; return; }
    const last = all.slice(-5).reverse();
    lastAddedList.innerHTML = last.map(v=>{
      const [en,de,cat] = v;
      const c = COLOR_MAP[cat]||"#64748b";
      const catName = CATEGORY_NAMES[cat]||"";
      return `<div><b>${en}</b> ‚Äì ${de} <span style="color:${c}">(${catName})</span></div>`;
    }).join("");
  }

  // Events
  learnBtn.onclick = ()=> startRound('learn');
  cardsBtn.onclick = ()=> startRound('cards');

  last30Btn.onclick = ()=>{
    const all = S("vokabeln");
    if(!all.length){ alert("Keine Vokabeln."); return; }
    const last = all.slice(-30);
    const choice = confirm("üóÇÔ∏è Letzte 30:\nOK = Karteikarten (Mitdenker)\nAbbrechen = Eingabe-Spiel");
    startRound(choice ? 'cards' : 'learn', last);
  };

  restartBtn.onclick = ()=> location.reload();
  openVocab.onclick  = ()=> window.location.href = "vokabeln.html";

  // Init
  (async ()=>{
    await syncFromGithub();
    fillCategories();
    renderLast();
    // ‚ÄûZuletzt hinzugef√ºgt‚Äú standardm√§√üig zu:
    lastBox.open = false;
    hideStage();
  })();
});
</script>
</body>
</html>
