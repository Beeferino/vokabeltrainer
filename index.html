<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vokabeltrainer</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; background:#f5f7fb; margin:0; text-align:center; }
  .app { max-width: 900px; margin: 30px auto; }
  h1 { margin: 0 0 14px; font-size: 2rem; }
  /* Controls (Kategorie/Modus) */
  .controls{display:flex;flex-wrap:wrap;justify-content:center;gap:16px;margin:10px 0 18px;}
  .controls label{display:flex;align-items:center;gap:8px}
  select{padding:8px 10px;border-radius:8px;border:1px solid #ccc;font-size:1rem}
  /* Soft-UI tiles */
  .tiles{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;margin:5px 0 10px}
  .tile{flex:1 1 320px;max-width:380px;background:#f9f9fb;border-radius:14px;
    box-shadow:0 6px 16px rgba(0,0,0,.07), inset 0 2px 4px rgba(255,255,255,.7);
    padding:16px 18px; cursor:pointer; transition:.18s; font-size:1.05rem}
  .tile:hover{transform:translateY(-2px); background:#eef2f8}
  .tile.center{max-width:520px}
  /* Feedback settings */
  .feedback-settings{background:#f1f4f9;border-radius:14px;padding:12px 18px;display:inline-flex;gap:16px;align-items:center;margin:16px 0;box-shadow:0 4px 12px rgba(0,0,0,.06)}
  /* Link button */
  .linkbtn{display:inline-block;padding:12px 18px;border-radius:10px;background:#74b9ff;color:#000;text-decoration:none;font-weight:700}
  .linkbtn:hover{background:#a6d4ff}
  .divider{border-top:2px solid #e5e9f0;margin:20px auto;width:92%}
  /* Recent box (collapsible) */
  #toggleRecent{margin-top:14px;background:#edf3ff;color:#0d3b66;border:1px solid #d3def2;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  #toggleRecent:hover{background:#e5edff}
  #recentBox{display:none;max-width:520px;margin:12px auto 0;background:#fafbff;border-radius:12px;box-shadow:inset 0 1px 2px rgba(0,0,0,.05);padding:12px 16px}
  #recentList{list-style:none;margin:8px 0 0;padding:0}
  #recentList li{padding:6px 0;border-bottom:1px dashed #ddd}
  #recentList li:last-child{border-bottom:none}
  .catLabel{font-size:.9rem;opacity:.75}
  footer{margin-top:14px;color:#666}

  /* Trainer UI */
  .card{position:relative;background:#fff;margin:14px auto 0;max-width:640px;padding:20px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
  .word{font-size:1.6rem;margin:10px 0 12px;font-weight:700}
  .feedback{min-height:1.2em;margin:6px 0 4px}
  #cardButtons{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px}
  #rightBtn{background:#2ECC71;color:#fff;border:none;border-radius:10px;padding:10px 16px}
  #wrongBtn{background:#E74C3C;color:#fff;border:none;border-radius:10px;padding:10px 16px}
  #skipBtn{background:#bdc3c7;color:#000;border:none;border-radius:10px;padding:10px 16px}
  input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid #cfd6e4;font-size:1rem;width:92%;max-width:420px}
  .chip{display:inline-block;padding:6px 10px;border-radius:12px;color:#fff;font-size:.9rem}
  .muted{opacity:.7;font-size:.95rem}
</style>
</head>
<body>
<div class="app">
  <h1>üéØ Vokabeltrainer</h1>

  <div class="controls">
    <label>Kategorie:
      <select id="category">
        <option value="Alle">Alle (bunt gemischt)</option>
      </select>
    </label>
    <label>Modus:
      <select id="mode">
        <option value="toGerman">Englisch ‚Üí Deutsch</option>
        <option value="toEnglish">Deutsch ‚Üí Englisch</option>
        <option value="mixed">Gemischt</option>
      </select>
    </label>
  </div>

  <div class="tiles">
    <div class="tile" id="learnTile">‚úçÔ∏è Vokabel-Abfrage starten</div>
    <div class="tile" id="last30Tile">üìö Letzte 30 Vokabeln</div>
  </div>
  <div class="tiles" style="justify-content:center">
    <div class="tile center" id="cardsTile">üß† Karteikarten starten</div>
  </div>

  <div class="feedback-settings">
    <label><input type="checkbox" id="feedbackToggle" checked> Sofortiges Feedback anzeigen</label>
    <label>Toast-Dauer:
      <select id="toastTime">
        <option value="800">0,8 s</option>
        <option value="1000" selected>1 s</option>
        <option value="1500">1,5 s</option>
        <option value="2000">2 s</option>
      </select>
    </label>
  </div>

  <div class="divider"></div>

  <a class="linkbtn" href="vokabeln.html">üìò Vokabel√ºbersicht √∂ffnen</a>

  <button id="toggleRecent">üìú Zuletzt hinzugef√ºgt (anzeigen)</button>
  <div id="recentBox">
    <ul id="recentList"><li><em>Keine Vokabeln vorhanden.</em></li></ul>
  </div>

  <!-- Trainer -->
  <div id="trainer" style="display:none">
    <div class="card" id="card">
      <div id="word" class="word"></div>
      <div class="muted" id="meta" style="display:none;"></div>
      <input id="answerInput" type="text" placeholder="√úbersetzung eingeben‚Ä¶" style="display:none;">
      <div class="feedback" id="feedback"></div>
      <div id="cardButtons">
        <button id="rightBtn" style="display:none">Richtig</button>
        <button id="wrongBtn" style="display:none">Falsch</button>
        <button id="skipBtn"  style="display:none">√úberspringen</button>
      </div>
    </div>
    <button id="restartBtn" class="tile center" style="margin-top:12px">üîÑ Neustart</button>
  </div>

  <div id="result" class="card" style="display:none"></div>

  <footer>¬© 2025 @Beefi</footer>
</div>

<script>
(() => {
  // ===== Constants / utils =====
  const CATEGORY_NAMES = {
    Gelb:"Grundwerkzeuge Metallverarbeitung", Pink:"Werkzeugkasten Mechaniker",
    Blau:"Blech- / Kunststoffarbeiten", Gruen:"Drehen / Fr√§sen",
    HellesPink:"Hydraulik / Pneumatik", Orange:"Elektrotechnik",
    Dunkelgruen:"Flugger√§temechanik allgemein", Rot:"Verwechslungsgefahr"
  };
  const COLOR_MAP = { Gelb:"#F4D03F", Pink:"#E91E63", Blau:"#1976D2", Gruen:"#1E8449", HellesPink:"#F54927", Orange:"#E67E22", Dunkelgruen:"#117A65", Rot:"#C0392B" };

  const $ = s => document.querySelector(s);
  const normalize = v => [v[0]||"", v[1]||"", v[2]||"Gelb", v[3]||"", v[4]||"", v[5]||new Date().toISOString()];
  const loadLocal = () => JSON.parse(localStorage.getItem("vokabeln")||"[]").map(normalize);
  const saveLocal = v => { localStorage.setItem("vokabeln", JSON.stringify(v)); localStorage.setItem("vokabeln_updated", new Date().toISOString()); };

  // ===== JSON Sync (merge) =====
  async function trySyncFromJson(){
    const urls=["./vokabeln.json","vokabeln.json",location.origin+"/vokabeln.json",location.origin+"/vokabeltrainer/vokabeln.json"];
    let remote=null;
    for(const u of urls){
      try{ const r=await fetch(u,{cache:"no-store"}); if(r.ok){ const d=await r.json(); if(Array.isArray(d)){remote=d; break;} } }catch{}
    }
    const local=loadLocal();
    if(!remote && local.length===0){
      const def=[["hammer","Hammer","Pink","","","2025-01-01T00:00:00Z"],["file","Feile","Gelb","","","2025-01-01T00:00:00Z"],["drill","Bohrer","Pink","","","2025-01-01T00:00:00Z"]];
      saveLocal(def);
    } else if(remote){
      saveLocal(merge(remote, local));
    }
    renderRecent();
  }
  function merge(remote, local){
    const key = v => (v[0]||"").toLowerCase()+"|"+(v[1]||"").toLowerCase();
    const map=new Map();
    remote.map(normalize).forEach(v=>map.set(key(v), v));
    local.map(normalize).forEach(v=>{ if(!map.has(key(v))) map.set(key(v), v); });
    return [...map.values()];
  }

  // ===== Recent box =====
  function renderRecent(){
    const ul=$("#recentList"); ul.innerHTML="";
    const last=loadLocal().slice(-5).reverse();
    if(!last.length){ ul.innerHTML="<li><em>Keine Vokabeln vorhanden.</em></li>"; return; }
    last.forEach(([en,de,cat])=>{
      const li=document.createElement("li");
      li.innerHTML=`<b>${en}</b> ‚Äì ${de} <span class="catLabel" style="color:${COLOR_MAP[cat]||"#555"}">(${CATEGORY_NAMES[cat]||cat})</span>`;
      ul.appendChild(li);
    });
  }
  $("#toggleRecent").onclick=()=>{
    const box=$("#recentBox"); const vis=box.style.display==="block";
    box.style.display= vis ? "none" : "block";
    $("#toggleRecent").textContent = vis ? "üìú Zuletzt hinzugef√ºgt (anzeigen)" : "üìú Zuletzt hinzugef√ºgt (verbergen)";
  };

  // ===== Trainer/game state =====
  let list=[], round=[], idx=0, errors=[], skipped=[], gameType="learn", mode="mixed", category="Alle";
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

  function renderCats(){
    const sel=$("#category");
    // reset (keine Doppel)
    sel.innerHTML = "<option value='Alle'>Alle (bunt gemischt)</option>";
    Object.keys(CATEGORY_NAMES).forEach(k=>{
      const o=document.createElement("option");
      o.value=k; o.textContent=CATEGORY_NAMES[k];
      sel.appendChild(o);
    });
  }

  function startRound(selMode, type, subset=null){
    list = loadLocal();
    if(list.length===0){ return; }
    mode = selMode;
    gameType = type;
    category = $("#category").value;

    let pool = category==="Alle" ? list : list.filter(v=>v[2]===category);
    if(subset) pool = subset;
    shuffle(pool);
    round = pool.slice(0, 15);
    idx=0; errors=[]; skipped=[];

    $("#result").style.display="none";
    $("#trainer").style.display="block";
    showNext();
  }

  function showNext(){
    const feedbackOn = $("#feedbackToggle").checked;
    const toastDelay = parseInt($("#toastTime").value, 10) || 1000;

    if(idx >= round.length){
      if(skipped.length){
        round = skipped; skipped=[]; idx=0;
        $("#feedback").textContent="üìò Jetzt die √ºbersprungenen Vokabeln!";
      }else{
        $("#trainer").style.display="none";
        const r=$("#result"); r.style.display="block";
        let html="<h3>Runde beendet</h3>";
        if(errors.length===0) html+="<p>Keine Fehler üéâ</p>";
        else {
          html+=`<p>${errors.length} Fehler:</p><ul>`;
          errors.forEach(([q,a])=> html+=`<li>${q} ‚Üí ${a}</li>`);
          html+="</ul>";
        }
        html+="<div style='margin-top:8px' class='muted'>Tipp: Kategorie/Modus oben √§ndern und neue Runde starten.</div>";
        r.innerHTML=html;
        return;
      }
    }

    const [en,de,cat,grp,hint] = round[idx];
    let ask, answer;
    if(mode==="toGerman"){ ask=en; answer=de; }
    else if(mode==="toEnglish"){ ask=de; answer=en; }
    else { if(Math.random()<0.5){ ask=en; answer=de; } else { ask=de; answer=en; } }

    const catChip = `<span class="chip" style="background:${COLOR_MAP[cat]||"#999"}">${CATEGORY_NAMES[cat]||cat}</span>`;
    $("#word").innerHTML = `${catChip}<br><br>${ask}`;
    // Meta: Gruppe & Hinweis ‚Äì immer anzeigen im Kartenmodus (auch ohne Feedback)
    const metaText = [grp?`Gruppe: <b>${grp}</b>`:"", hint?`Hinweis: <b>${hint}</b>`:""].filter(Boolean).join(" ‚Ä¢ ");
    $("#meta").innerHTML = metaText;
    $("#meta").style.display = gameType==="cards" && metaText ? "block" : (metaText ? "block" : "none");

    // Reset UI
    $("#feedback").textContent="";
    const answerInput=$("#answerInput");
    const rightBtn=$("#rightBtn"), wrongBtn=$("#wrongBtn"), skipBtn=$("#skipBtn");

    if(gameType==="learn"){
      answerInput.style.display="inline-block";
      rightBtn.style.display="none"; wrongBtn.style.display="none"; skipBtn.style.display="inline-block";
      answerInput.value=""; answerInput.focus();
      answerInput.onkeydown = (e)=>{
        if(e.key==="Enter"){
          const ok = answerInput.value.trim().toLowerCase() === (answer||"").toLowerCase();
          if(feedbackOn){ $("#feedback").textContent = ok ? "‚úÖ Richtig!" : `‚ùå Falsch! Richtige Antwort: ${answer}`; }
          if(!ok) errors.push([ask, answer]);
          idx++;
          setTimeout(showNext, feedbackOn ? toastDelay : 0);
        }
      };
      skipBtn.onclick = ()=>{ skipped.push([en,de,cat,grp,hint]); idx++; showNext(); };
    }else{ // cards
      answerInput.style.display="none";
      rightBtn.style.display="inline-block"; wrongBtn.style.display="inline-block"; skipBtn.style.display="inline-block";

      // 30% Fallenkarte: zeigt falsche Antwort
      const isTrap = Math.random() < 0.30;
      const pool = list.map(v => mode==="toEnglish" ? v[0] : v[1]);
      let shown = answer;
      if(isTrap){
        do { shown = pool[Math.floor(Math.random()*pool.length)] || answer; } while(shown===answer);
      }
      $("#feedback").innerHTML = `üí° <b>${shown}</b>`; // Vorschlag
      if(!feedbackOn){ $("#feedback").style.opacity=".7"; } else { $("#feedback").style.opacity="1"; }

      // Buttons mischen
      const parent=$("#cardButtons");
      if(Math.random()<0.5) parent.insertBefore(wrongBtn, rightBtn); else parent.insertBefore(rightBtn, wrongBtn);

      rightBtn.onclick = ()=>{
        const ok = !isTrap;
        if(feedbackOn) $("#feedback").textContent = ok ? "‚úÖ Richtig!" : "‚ùå Falsch!";
        if(!ok) errors.push([ask, answer]);
        idx++; setTimeout(showNext, feedbackOn ? Math.min(800, parseInt($("#toastTime").value,10)) : 0);
      };
      wrongBtn.onclick = ()=>{
        const ok = isTrap;
        if(feedbackOn) $("#feedback").textContent = ok ? "‚úÖ Richtig!" : "‚ùå Falsch!";
        if(!ok) errors.push([ask, answer]);
        idx++; setTimeout(showNext, feedbackOn ? Math.min(800, parseInt($("#toastTime").value,10)) : 0);
      };
      skipBtn.onclick = ()=>{ skipped.push([en,de,cat,grp,hint]); idx++; showNext(); };
    }
  }

  // ===== Event wiring =====
  $("#learnTile").onclick   = ()=> startRound($("#mode").value, "learn");
  $("#cardsTile").onclick   = ()=> startRound($("#mode").value, "cards");
  $("#last30Tile").onclick  = ()=> {
    const all=loadLocal(); if(!all.length){ return; }
    const last30 = all.slice(-30);
    startRound($("#mode").value, "learn", last30);
  };
  $("#restartBtn").onclick  = ()=> location.reload();

  // ===== Init =====
  function renderCats(){
    const sel=$("#category");
    sel.innerHTML = "<option value='Alle'>Alle (bunt gemischt)</option>";
    Object.keys(CATEGORY_NAMES).forEach(k=>{
      const o=document.createElement("option");
      o.value=k; o.textContent=CATEGORY_NAMES[k];
      sel.appendChild(o);
    });
  }

  (async function init(){
    renderCats();
    await trySyncFromJson();
  })();

})();
</script>
</body>
</html>
