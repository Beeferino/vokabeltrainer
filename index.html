<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vokabeltrainer – Beeferino</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">

<style>
  @media (max-width: 600px) {
    .controls { gap: 24px; }
    select { min-width: 120px; }
  }

  :root{
    --blue:#2563eb;--blue2:#1d4ed8;--ink:#0f172a;
    --glass:rgba(255,255,255,.88);
    --ok:#22c55e;--bad:#ef4444;--muted:#9ca3af
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter,system-ui,sans-serif;
    background:linear-gradient(145deg,#eef4ff,#dbeafe);color:var(--ink)
  }
  body.dark{background:linear-gradient(145deg,#1e293b,#0f172a);color:#f8fafc}
  body.dark .app{background:rgba(30,41,59,.85)}
  .app{
    max-width:1000px;margin:28px auto;padding:22px;background:var(--glass);
    border-radius:22px;box-shadow:0 10px 32px rgba(0,0,0,.10);backdrop-filter:blur(8px)
  }
  h1{margin:0;text-align:center;font-size:2rem;font-weight:800;color:#1e3a8a}
  body.dark h1{color:#93c5fd}
  .hr{width:160px;height:4px;background:var(--blue);border-radius:4px;margin:10px auto 20px}
  .controls,.functions,.toolbar{display:flex;flex-wrap:wrap;justify-content:center;gap:20px}
  .controls label{display:flex;align-items:center;gap:6px}
  select,.tbtn{
    padding:8px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:1rem;background:#fff
  }
  body.dark select, body.dark .tbtn{background:#0f172a;border-color:#334155;color:#e5e7eb}
  .kachel{
    flex:1 1 240px;text-align:center;background:var(--blue);color:#fff;padding:14px 18px;border-radius:14px;
    font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(37,99,235,.25);transition:transform .15s,background .15s
  }
  .kachel small{font-weight:600;opacity:.9}
  .kachel:hover{transform:translateY(-1px);background:var(--blue2)}
  .progress{text-align:center;font-weight:700;margin:8px 0 4px;min-height:1.2em}
  .subnote{text-align:center;font-size:.95rem;color:#334155;margin:-2px 0 12px}
  .subnote b{font-weight:800;color:#1e3a8a}
  body.dark .subnote{color:#cbd5e1} body.dark .subnote b{color:#93c5fd}
  .goalbar{width:90%;max-width:560px;height:10px;border-radius:999px;background:#e5e7eb;margin:8px auto 0;overflow:hidden}
  .goalbar>div{height:100%;width:0%;background:linear-gradient(90deg,#34d399,#10b981);transition:width .4s}

  #stage{
    display:none;margin-top:14px;padding:28px;border-radius:20px;background:rgba(255,255,255,.95);
    box-shadow:inset 0 0 10px rgba(0,0,0,.05);text-align:center
  }
  body.dark #stage{background:rgba(2,6,23,.9)}
  .chip{display:inline-block;font-weight:800;padding:8px 14px;border-radius:999px;margin-bottom:10px}
  .word{font-size:1.9rem;font-weight:800;margin:8px 0 6px}
  .offer{font-size:1.1rem;color:#1f2937;margin:6px 0 12px;min-height:1.3em}
  body.dark .offer{color:#e5e7eb}
  .btnrow{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
  .btn{border:none;border-radius:12px;padding:10px 20px;font-weight:700;font-size:1rem;cursor:pointer}
  .ok{background:var(--ok);color:#fff}
  .bad{background:var(--bad);color:#fff}
  .skip{background:var(--muted);color:#fff}
  .inprow{display:none;gap:8px;justify-content:center;margin-top:12px}
  .inprow input{
    width:60%;min-width:260px;padding:10px 14px;border:1px solid #d1d5db;border-radius:12px;font-size:1rem
  }
  .inprow button{background:var(--blue);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:700}

  .flash-correct{animation:good .4s}
  .flash-wrong{animation:bad .4s}
  @keyframes good{from{background:#dcfce7}to{background:rgba(255,255,255,.95)}}
  @keyframes bad{from{background:#fee2e2}to{background:rgba(255,255,255,.95)}}

  .footer-actions{display:flex;justify-content:space-between;gap:12px;margin-top:24px}
  .footer-actions a,.footer-actions button{
    display:inline-flex;align-items:center;justify-content:center;gap:6px;background:linear-gradient(135deg,#eaf0ff,#f8faff);
    border:1px solid #dbe3ff;color:#1f2937;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;text-decoration:none;font-size:1rem;
    box-shadow:0 3px 8px rgba(0,0,0,.05);transition:all .25s ease
  }
  .footer-actions a:hover,.footer-actions button:hover{background:linear-gradient(135deg,#e0e7ff,#f1f5ff);transform:translateY(-1px);box-shadow:0 5px 12px rgba(37,99,235,.15)}

  .feedback-toggle{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:10px}
  .trenner{height:3px;width:60%;margin:36px auto 16px;background:linear-gradient(90deg,transparent,#93c5fd,#2563eb,#93c5fd,transparent);border-radius:2px;animation:shine 5s linear infinite}
  @keyframes shine{0%{background-position:0 0}100%{background-position:400px 0}}
    /* ===== Modal (Statistik + Fehler) ===== */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:50
  }
  .modal{
    width:min(860px,96vw);max-height:85vh;overflow:auto;background:#fff;border-radius:18px;box-shadow:0 24px 60px rgba(0,0,0,.25)
  }
  .modal header{position:sticky;top:0;background:#fff;padding:18px 20px;border-bottom:1px solid #eef2ff;border-top-left-radius:18px;border-top-right-radius:18px}
  .modal h2{margin:0;font-size:1.25rem;color:#0f172a}
  .modal .content{padding:16px 20px 22px}
  .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:14px}
  .stat{background:linear-gradient(135deg,#f8fafc,#eff6ff);border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px}
  .stat .label{font-size:.85rem;color:#64748b;font-weight:600}
  .stat .value{font-size:1.25rem;font-weight:800}
  .error-list{margin-top:6px}
  .error-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border:1px solid #eef2ff;border-radius:12px;margin-bottom:8px}
  .badge{font-size:.78rem;font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.06)}
  .modal footer{position:sticky;bottom:0;background:#fff;border-top:1px solid #eef2ff;padding:12px 16px;display:flex;gap:8px;justify-content:flex-end}
  .btn-ghost{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-ghost,.btn-primary,.download{border-radius:10px;padding:10px 14px;font-weight:800;border:none;cursor:pointer}
  .download{margin-right:auto;background:#e5f2ff;border:1px solid #c7ddff;color:#0f172a}

function getDailyProgress(){
  const today=new Date().toISOString().slice(0,10);
  return parseInt(localStorage.getItem('daily_'+today)||'0',10);
}

function updateGoalUI(val){
  goalFill.style.width=Math.min(100,Math.round(val/30*100))+'%';
  goalText.textContent=`Tagesziel: ${val} / 30 richtige Antworten`;
}

async function checkRemoteUpdate(){
  // Dummy-Funktion: hier könnte später Vergleich mit Cloud-Daten passieren
  console.log("checkRemoteUpdate()");
}

  /* ===== Abstände ===== */
  .controls { margin-bottom: 18px; }
  .toolbar { margin-top: 6px; margin-bottom: 22px; }

  /* === "Zuletzt hinzugefügt" – kompaktere Kacheln === */
  details.recent-section {
    background: rgba(255,255,255,0.95); border-radius: 20px; padding: 22px;
    margin-top: 10px; text-align: center;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    backdrop-filter: blur(10px);
    transition: all .35s ease;
    overflow: hidden;
  }
  details.recent-section summary {
    background: rgba(240,244,255,0.8);
    border-radius: 14px;
    padding: 10px 14px;
    font-weight: 700;
    color: #1e3a8a;
    cursor: pointer;
    list-style: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all .25s ease;
  }
  details.recent-section summary::before{content:"▶";font-size:.85em;color:#2563eb;transition:transform .3s ease,color .3s ease}
  details.recent-section summary::after{content:"◀";font-size:.85em;color:#2563eb;transition:transform .3s ease,color .3s ease}
  details.recent-section[open] summary::before,
  details.recent-section[open] summary::after{content:"▼";color:#1d4ed8}

  /* kompakte Cards */
  #recent { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:16px; }
  .recent-item{
    border-radius:14px; padding:10px 12px; font-weight:700;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
    display:flex; flex-direction:column; align-items:flex-start;
    line-height:1.35; min-height:72px;
  }
  .recent-item b{font-size:1.02rem}
  .recent-item small{font-weight:600;font-size:.8rem;opacity:.9;margin-top:6px}

  /* === Dark-Variante Recent === */
  body.dark details.recent-section {background: rgba(15,23,42,0.6); box-shadow: 0 4px 14px rgba(0,0,0,0.4)}
  body.dark details.recent-section summary {background: rgba(255,255,255,0.08); color:#e2e8f0!important}
  body.dark details.recent-section summary::before, body.dark details.recent-section summary::after {color:#60a5fa}
  body.dark .recent-item{box-shadow:0 4px 8px rgba(0,0,0,.25)}

  /* ===== Footer-Zentrierung ===== */
  .foot { text-align:center; font-size:.9rem; color:#64748b; margin-top:14px; margin-bottom:6px; }
  body.dark .foot { color:#cbd5e1; }
</style>
</head>
<body>
<div class="app">
  <h1>🎯 Vokabeltrainer</h1>
  <div class="hr"></div>

  <div class="controls">
    <label>Kategorie:
      <select id="selCat">
        <option value="Alle">Alle (bunt gemischt)</option>
      </select>
    </label>
    <label>Modus:
      <select id="selMode">
        <option value="mixed">Gemischt</option>
        <option value="toGerman">Englisch → Deutsch</option>
        <option value="toEnglish">Deutsch → Englisch</option>
      </select>
    </label>
    <label>Delay:
      <select id="selDelay">
        <option value="1000">1 s</option>
        <option value="3000" selected>3 s</option>
        <option value="5000">5 s</option>
      </select>
    </label>
  </div>

  <div class="toolbar">
    <button id="btnErrorsOnly" class="tbtn">🔁 Fehler wiederholen</button>
    <button id="btnStats" class="tbtn">📊 Statistik</button>
    <label class="dark-toggle tbtn" id="btnDark"><input type="checkbox" id="chkDark"> 🌙 Dark Mode</label>
    <label class="dark-toggle tbtn" id="btnSound"><input type="checkbox" id="chkSound" checked> 🔈 Sound</label>
    <label class="dark-toggle tbtn" id="btnFeedback"><input type="checkbox" id="chkFeedback" checked> 💬 Feedback</label>
  </div>
  <div class="functions">
    <div id="btnLearn" class="kachel">✍️ Vokabel-Abfrage starten</div>
    <div id="btnLast30" class="kachel">📗 Letzte eingegebenen Vokabeln</div>
    <div id="btnCards" class="kachel">🧠 Karteikarten<br><small><i>Mitdenker Edition</i></small></div>
  </div>

  <div id="progress" class="progress">Bereit.</div>
  <div id="startNote" class="subnote">
    Wähle zuerst einen <b>Übungsmodus</b>, um zu beginnen:
    <b>Gemischt</b> (abwechselnd), <b>Englisch → Deutsch</b> oder
    <b>Deutsch → Englisch</b>.<br>
    Danach einfach auf <b>„Vokabel-Abfrage starten“</b> klicken.
    <div class="goalbar"><div id="goalFill"></div></div>
    <div style="font-size:.85rem;margin-top:6px;opacity:.8" id="goalText">
      Tagesziel: 0 / 30 richtige Antworten
    </div>
  </div>

  <section id="stage">
    <div id="chip" class="chip">–</div>
    <div id="q" class="word">Bereit?</div>
    <div id="offer" class="offer"></div>

    <div id="rowButtons" class="btnrow">
      <button id="btnRight" class="btn ok" style="display:none;">Richtig</button>
      <button id="btnDec" class="btn bad" style="display:none;">Täuschung erkannt</button>
      <button id="btnSkip" class="btn skip" style="display:none;">Weiter</button>
    </div>

    <div id="rowInput" class="inprow">
      <input id="inp" type="text" placeholder="Übersetzung eingeben …">
      <button id="btnSub">Eingabe</button>
    </div>
  </section>

  <div class="footer-actions">
    <a href="vokabeln.html">📂 Vokabeln</a>
    <button id="btnHardReload">🔄 Neustart</button>
  </div>

  <div class="trenner"></div>

  <details class="recent-section">
    <summary>Zuletzt hinzugefügt</summary>
    <div id="recent">–</div>
  </details>

  <div class="foot">© 2025 Beeferino • Datenquelle: GitHub / lokal</div>
  <div id="syncState"
       style="text-align:center;margin-top:6px;font-size:.9rem;
              color:#22c55e;opacity:.4;transition:opacity 1s;">
    🟢 Daten aktuell
  </div>
</div>

<!-- ===== Modal ===== -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header><h2 id="modalTitle">📊 Runden-Statistik & Fehlerübersicht</h2></header>
    <div class="content">
      <div class="stat-grid" id="statGrid"></div>
      <div class="error-list" id="errorList"></div>
    </div>
    <footer>
      <button id="btnDownload" class="download">⬇️ Fehlerliste speichern</button>
      <button id="btnContinue" class="btn-ghost">Weiter üben</button>
      <button id="btnClose" class="btn-primary">Schließen</button>
    </footer>
  </div>
</div>

<script>
(function(){
/* ========= Setup & Utils ========= */
const CATS = {
  Gelb:["Grundwerkzeuge Metallverarbeitung","#F4D03F","#000"],
  Pink:["Werkzeugkasten Mechaniker","#E91E63","#fff"],
  Blau:["Blech- / Kunststoffarbeiten","#1976D2","#fff"],
  Gruen:["Drehen / Fräsen","#1E8449","#fff"],
  HellesPink:["Hydraulik / Pneumatik","#F54927","#fff"],
  Orange:["Elektrotechnik","#E67E22","#fff"],
  Dunkelgruen:["Fluggerätemechanik allgemein","#117A65","#fff"]
};

const el=id=>document.getElementById(id);
const selCat=el("selCat"), selDelay=el("selDelay"),
      chkFeedback=el("chkFeedback"), selMode=el("selMode");
const btnLearn=el("btnLearn"), btnCards=el("btnCards"),
      btnLast30=el("btnLast30"), btnErrorsOnly=el("btnErrorsOnly"),
      btnStats=el("btnStats");
const progress=el("progress"), stage=el("stage"),
      chip=el("chip"), q=el("q"), offer=el("offer");
const btnRight=el("btnRight"), btnDec=el("btnDec"),
      btnSkip=el("btnSkip"), rowButtons=el("rowButtons"),
      rowInput=el("rowInput"), inp=el("inp"), btnSub=el("btnSub"),
      recent=el("recent");
const modalBackdrop=el("modalBackdrop"), errorList=el("errorList"),
      statGrid=el("statGrid"), btnClose=el("btnClose"),
      btnContinue=el("btnContinue"), btnDownload=el("btnDownload");
const startNote=el("startNote"), goalFill=el("goalFill"),
      goalText=el("goalText");
const chkDark=el("chkDark"), chkSound=el("chkSound"),
      btnHardReload=el("btnHardReload");

/* Kategorien befüllen */
(function buildCatOptions(){
  while (selCat.options.length > 1) selCat.remove(1);
  for(const k in CATS){
    const [label,bg,fg] = CATS[k];
    const o=document.createElement("option");
    o.value=k; o.textContent=label;
    o.style.background=bg; o.style.color=fg;
    selCat.appendChild(o);
  }
  const extra=document.createElement("option");
  extra.value="confuse";
  extra.textContent="⚠️ Verwechslungsgefahr-Vokabeln";
  extra.style.background="#ffe4e6";
  extra.style.color="#b91c1c";
  selCat.appendChild(extra);
})();
/* ========= Audio / Feedback ========= */
function beep(freq=660,ms=80,type='sine',vol=0.03){
  if(!chkSound.checked) return;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type=type;o.frequency.value=freq;g.gain.value=vol;
    o.connect(g);g.connect(ctx.destination);
    o.start();setTimeout(()=>{o.stop();ctx.close();},ms);
  }catch{}
}

/* ========= Hilfsfunktionen ========= */
function shuffle(a){for(let i=a.length-1;i>0;i--){const r=Math.floor(Math.random()*(i+1));[a[i],a[r]]=[a[r],a[i]];}}
function normalize(s){
  return s.trim().toLowerCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .replace(/[-–—]/g,"-").replace(/\s+/g," ");
}
function isCorrectInput(input,solution){
  const a=normalize(input);
  const opts=solution.split(/[\/;|,]/).map(x=>normalize(x));
  return opts.includes(a);
}
  
/* ========= Tagesziel & Daten ======== */
const DAILY_GOAL = 30;

function saveDailyProgress(correctInc = 0) {
  const today = new Date().toISOString().slice(0, 10);
  const key = "daily_" + today;
  const val = parseInt(localStorage.getItem(key) || "0", 10) + correctInc;
  localStorage.setItem(key, String(val));
  updateGoalUI(val);
}

function getDailyProgress() {
  const today = new Date().toISOString().slice(0, 10);
  return parseInt(localStorage.getItem("daily_" + today) || "0", 10);
}

function updateGoalUI(val) {
  const pct = Math.min(100, Math.round((val / DAILY_GOAL) * 100));
  goalFill.style.width = pct + "%";
  goalText.textContent = `Tagesziel: ${val} / ${DAILY_GOAL} richtige Antworten`;
}

/* ========= Daten laden & Sync ========= */
// Optional: wenn du bereits eine Version davon hast, nutze nur EINE!

function normalizeRow(v){
  return [
    v[0]||"", v[1]||"", v[2]||"Gelb",
    v[3]||"", v[4]||"", v[5]||new Date().toISOString(),
    !!v[6]
  ];
}

async function fetchFromGitHub(){
  const url = "https://beeferino.github.io/vokabeltrainer/vokabeln.json";
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("fetch failed");
  const j = await r.json();
  const norm = j.map(normalizeRow);
  localStorage.setItem("vokabeln", JSON.stringify(norm));
  localStorage.setItem("vokabeln_updated", new Date().toISOString());
  data = norm;
}

async function loadData() {
  try {
    const localUpd = localStorage.getItem("vokabeln_updated");
    const lastUsed = localStorage.getItem("index_last_sync");
    const localNewer = localUpd && (!lastUsed || new Date(localUpd) > new Date(lastUsed));

    if (localNewer) {
      data = (JSON.parse(localStorage.getItem("vokabeln") || "[]")).map(normalizeRow);
    } else {
      await fetchFromGitHub();
    }
    localStorage.setItem("index_last_sync", new Date().toISOString());
    renderRecent?.(); // falls vorhanden
  } catch (e) {
    // Fallback offline
    data = (JSON.parse(localStorage.getItem("vokabeln") || "[]")).map(normalizeRow);
  }
}

async function checkRemoteUpdate(){
  try{
    const r = await fetch("https://beeferino.github.io/vokabeltrainer/vokabeln.json",{cache:"no-store"});
    const j = await r.json();
    const norm = j.map(normalizeRow);
    const local = JSON.parse(localStorage.getItem("vokabeln")||"[]");
    if(JSON.stringify(norm)!==JSON.stringify(local)){
      localStorage.setItem("vokabeln",JSON.stringify(norm));
      localStorage.setItem("vokabeln_updated",new Date().toISOString());
      if (typeof setSyncState === "function") setSyncState('🔄 Neue Daten aus Cloud geladen','#22c55e');
      data = norm;
      renderRecent?.();
    } else {
      if (typeof setSyncState === "function") setSyncState('🟢 Daten aktuell','#22c55e');
    }
  } catch {
    if (typeof setSyncState === "function") setSyncState('🟠 Offline – arbeite lokal','#f59e0b');
  }
}

/* ========= Variablen ========= */
let data=[],round=[],errorsList=[],curr=null,correct="";
let totalAsked=0,totalErrors=0,totalSkipped=0,sinceCheckpoint=0;
let i=0,delay=3000,game="idle",modeEndless=false,trap=false;
let currAskedEN=true,source=[],sourceIdx=0;
const errorMap=new Map(),catStats=new Map();

/* ========= Statistik ========= */
function resetStats(){totalAsked=totalErrors=totalSkipped=sinceCheckpoint=0;errorMap.clear();catStats.clear();}
function bumpCat(cat,err,asked=true){
  const o=catStats.get(cat)||{asked:0,errors:0,total:0};
  if(asked) o.asked++; if(err) o.errors++; o.total++;
  catStats.set(cat,o);
}
function recordErrorForSummary(item,askedEN){
  const[en,de,cat]=item;
  const q=askedEN?en:de,ans=askedEN?de:en;
  const k=`${en}|${de}|${askedEN?1:0}`;
  if(!errorMap.has(k)) errorMap.set(k,{q,correct:ans,cat});
}

/* ========= Stage/UI ========= */
function setProg(){progress.textContent=`Frage ${totalAsked+1} | Fehler: ${totalErrors}`;}
function showStage(s){stage.style.display=s?"block":"none";}

/* ========= Checkpoint ========= */
function maybeCheckpointOr(next){
  sinceCheckpoint++;
  if(sinceCheckpoint>=15){
    sinceCheckpoint=0;
    if(confirm("✅ 15 Fragen beantwortet.\nRunde beenden und Ergebnisse anzeigen?")){endRound();return;}
  }
  next();
}

/* ========= Spiel-Setup ========= */
function pickDirection(){
  return selMode.value==="toGerman"?true:selMode.value==="toEnglish"?false:Math.random()<0.5;
}
function filterByCategory(list){
  const v=selCat.value;
  if(v==="Alle") return list.slice();
  if(v==="confuse") return list.filter(x=>!!x[6]);
  return list.filter(x=>x[2]===v);
}

/* ========= Sessions ========= */
function startInputSession(pool){
  game="input";modeEndless=true;resetStats();
  source=pool.slice();shuffle(source);sourceIdx=0;
  btnRight.style.display=btnDec.style.display="none";
  btnSkip.style.display="inline-block";rowInput.style.display="flex";
  showStage(true);nextInput();
}
function startCardsSession(pool){
  game="cards";modeEndless=false;resetStats();
  errorsList=[];i=0;trap=false;
  round=pool.slice();shuffle(round);
  btnRight.style.display=btnDec.style.display=btnSkip.style.display="inline-block";
  rowInput.style.display="none";showStage(true);nextCard();
}

/* ========= Nächste Aufgaben ========= */
function nextInput(){
  delay=parseInt(selDelay.value,10);
  if(!source.length){alert("Keine Vokabeln.");showStage(false);return;}
  curr=source[sourceIdx];sourceIdx=(sourceIdx+1)%source.length;if(sourceIdx===0)shuffle(source);
  const[en,de,cat]=curr,c=CATS[cat]||["Kategorie","#ddd","#000"];
  chip.textContent=c[0];chip.style.background=c[1];chip.style.color=c[2];
  currAskedEN=pickDirection();q.textContent=currAskedEN?en:de;
  correct=currAskedEN?de:en;offer.textContent="";inp.value="";inp.focus();setProg();
}
function nextCard(){
  delay=parseInt(selDelay.value,10);
  if(i>=round.length){
    if(errorsList.length){alert(`↻ ${errorsList.length} zur Wiederholung`);round=errorsList;i=0;errorsList=[];nextCard();return;}
    showStage(false);progress.textContent="Fertig!";setTimeout(endRound,300);return;
  }
  const[en,de,cat]=round[i],c=CATS[cat]||["Kategorie","#ddd","#000"];
  chip.textContent=c[0];chip.style.background=c[1];chip.style.color=c[2];
  const askEN=pickDirection();q.textContent=askEN?en:de;correct=askEN?de:en;currAskedEN=askEN;
  if(Math.random()<0.3){const pool=data.map(v=>askEN?v[1]:v[0]);let wrong;do{wrong=pool[Math.floor(Math.random()*pool.length)];}while(wrong===correct);offer.textContent="💡 "+wrong;trap=true;}
  else{offer.textContent="💡 "+correct;trap=false;}
  setProg();
}

/* ========= Eingaben ========= */
function flash(ok,done){if(ok)beep(880,70);else beep(220,120,'square');
  if(!chkFeedback.checked){done();return;}
  stage.classList.add(ok?"flash-correct":"flash-wrong");
  setTimeout(()=>{stage.classList.remove(ok?"flash-correct":"flash-wrong");done();},delay);
}
function handleInputSubmit(){
  if(game!=="input"&&!(game==="cards"&&rowInput.style.display==="flex"))return;
  const itemRef=(game==="input")?curr:round[i];
  const ok=isCorrectInput(inp.value,correct);
  totalAsked++;
  if(game==="input"){
    if(ok){bumpCat(itemRef[2],false);flash(true,()=>maybeCheckpointOr(nextInput));}
    else{totalErrors++;bumpCat(itemRef[2],true);recordErrorForSummary(itemRef,currAskedEN);offer.innerHTML=`❌ Richtige Antwort: <b>${correct}</b>`;flash(false,()=>maybeCheckpointOr(nextInput));}
  }else{
    if(ok){bumpCat(itemRef[2],false);flash(true,()=>{i++;maybeCheckpointOr(nextCard);});}
    else{totalErrors++;bumpCat(itemRef[2],true);errorsList.push(itemRef);recordErrorForSummary(itemRef,currAskedEN);
         offer.innerHTML=`❌ Richtige Antwort: <b>${correct}</b>`;flash(false,()=>{i++;maybeCheckpointOr(nextCard);});}
  }
}

/* ========= Modal ========= */
function openModal(){modalBackdrop.style.display="flex";modalBackdrop.setAttribute("aria-hidden","false");btnClose.focus();}
function closeModal(){modalBackdrop.style.display="none";modalBackdrop.setAttribute("aria-hidden","true");}
modalBackdrop.addEventListener("click",e=>{if(e.target===modalBackdrop)closeModal();});
document.addEventListener("keydown",e=>{if(e.key==="Escape")closeModal();});
btnClose.onclick=closeModal;

/* ✅ FIXED: Weiter-üben-Button */
btnContinue.onclick=()=>{
  closeModal();
  sinceCheckpoint=0;totalSkipped=0;
  setTimeout(()=>{
    if(game==="input"){nextInput();inp.focus();}
    else if(game==="cards"){nextCard();}
  },250);
};

btnDownload.onclick=()=>{
  const lines=[];statGrid.querySelectorAll(".stat").forEach(s=>{
    const l=s.querySelector(".label")?.textContent?.trim();
    const v=s.querySelector(".value")?.textContent?.trim();
    if(l&&v)lines.push(`${l}: ${v}`);
  });
  lines.push("","Fehlerliste:");
  errorMap.forEach(v=>{
    const c=CATS[v.cat]||["Kategorie","#ddd","#000"];
    lines.push(`- ${v.q} -> ${v.correct} [${c[0]}]`);
  });
  const blob=new Blob([lines.join("\\n")],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);a.download="vokabelrunde.txt";a.click();
  URL.revokeObjectURL(a.href);
};

/* ========= Ende der Runde ========= */
function endRound(){
  showStage(false);
  const asked=totalAsked,err=totalErrors,sk=totalSkipped,correctCount=Math.max(0,asked-err-sk),
        acc=asked?Math.round(correctCount/asked*100):100;
  statGrid.innerHTML=`<div class="stat"><div class="label">Gesamt</div><div class="value">${asked}</div></div>
    <div class="stat"><div class="label">Korrekt</div><div class="value">${correctCount}</div></div>
    <div class="stat"><div class="label">Fehler</div><div class="value">${err}</div></div>
    <div class="stat"><div class="label">Übersprungen</div><div class="value">${sk}</div></div>
    <div class="stat"><div class="label">Trefferquote</div><div class="value">${acc}%</div></div>`;
  errorList.innerHTML=errorMap.size?"":
     `<div class="error-item" style="justify-content:center">${err? "Fehler" : "🎉 Keine Fehler!"}</div>`;
  errorMap.forEach(v=>{
    const c=CATS[v.cat]||["Kategorie","#ddd","#000"];
    const r=document.createElement("div");
    r.className="error-item";
    r.innerHTML=`<div style="max-width:70%"><b>${v.q}</b><div>→ <b>${v.correct}</b></div></div>
      <span class="badge" style="background:${c[1]};color:${c[2]}">${c[0]}</span>`;
    errorList.appendChild(r);
  });
  openModal();
}

/* ========= Start-Buttons ========= */
btnSub.onclick=handleInputSubmit;
btnSkip.onclick=()=>{if(game==="idle")return;totalAsked++;totalSkipped++;
  const ref=(game==="input")?curr:round[i];bumpCat(ref[2],false,false);
  sinceCheckpoint++;if(sinceCheckpoint>=15){sinceCheckpoint=0;if(confirm("15 beantwortet. Ergebnisse anzeigen?")){endRound();return;}}
  if(game==="input")nextInput();else{i++;nextCard();}
};
btnRight.onclick=()=>{if(game!=="cards")return;const ref=round[i];totalAsked++;
  if(trap){totalErrors++;bumpCat(ref[2],true);recordErrorForSummary(ref,currAskedEN);
           offer.innerHTML=`❌ Richtige Antwort: <b>${correct}</b>`;flash(false,()=>{i++;maybeCheckpointOr(nextCard);});}
  else{bumpCat(ref[2],false);flash(true,()=>{i++;maybeCheckpointOr(nextCard);});}};
btnDec.onclick=()=>{if(game!=="cards")return;rowInput.style.display="flex";inp.value="";inp.focus();};

/* ========= Keyboard ========= */
document.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&rowInput.style.display!=="none")btnSub.click();
  else if(e.key==="ArrowRight")btnSkip.click();
  else if(e.key.toLowerCase()==="r"&&game==="cards")btnRight.click();
  else if(e.key.toLowerCase()==="t"&&game==="cards")btnDec.click();
});

/* ========= Start-Logik ========= */
btnLearn.onclick=()=>{const pool=filterByCategory(data);if(!pool.length){alert("Keine Vokabeln.");return;}startInputSession(pool);};
btnCards.onclick=()=>{const pool=filterByCategory(data);if(!pool.length){alert("Keine Vokabeln.");return;}startCardsSession(pool);};
btnLast30.onclick=()=>{const last30=data.slice(-30);if(!last30.length){alert("Keine Vokabeln.");return;}
  const useCards=confirm("Mitdenker Edition aktivieren?\nOK=Karteikarten, Abbrechen=Eingabe");
  const pool=filterByCategory(last30);if(!pool.length){alert("Keine passenden.");return;}
  if(useCards)startCardsSession(pool);else startInputSession(pool);};

/* ===== Init ===== */
function softResetUI(){
  showStage(false);
  startNote.style.opacity = 1;
  progress.textContent = "Bereit.";
  offer.textContent = "";
  q.textContent = "Bereit?";
  chip.textContent = "–";
  chip.style.background = "";
  chip.style.color = "";
  rowInput.style.display = "none";
  rowButtons.style.display = "flex";
  btnRight.style.display = "none";
  btnDec.style.display = "none";
  btnSkip.style.display = "none";
  resetStats();
  errorsList = [];
  round = [];
  i = 0;
  source = [];
  sourceIdx = 0;
  curr = null;
  correct = "";
  game = "idle";
  modeEndless = false;
}

softResetUI();
updateGoalUI(getDailyProgress());
loadData().then(checkRemoteUpdate);

/* Neustart (Soft-Reset) */
btnHardReload.addEventListener('click', softResetUI);

/* ===== Weiter-üben-Fix (funktioniert garantiert) ===== */
btnContinue.onclick = () => {
  closeModal();

  // Zähler zurücksetzen, aber keine Statistik löschen
  sinceCheckpoint = 0;
  totalSkipped = 0;

  setTimeout(() => {
    if (game === "input") {
      nextInput();
      inp.focus();
    } else if (game === "cards") {
      nextCard();
    }
  }, 250);
};

/* ===== PWA Register (fehler-tolerant) ===== */
if ('serviceWorker' in navigator) {
  try {
    navigator.serviceWorker.register('service-worker.js').catch(() => {});
  } catch (e) {
    console.warn('ServiceWorker konnte nicht registriert werden:', e);
  }
}

/* ===== Start-Hinweis ausblenden ===== */
[btnLearn, btnLast30, btnCards, btnErrorsOnly].forEach(btn => {
  btn.addEventListener("click", () => {
    startNote.style.display = "none";
  });
});

})(); //  ✅ GANZ WICHTIG: Das schließt die Hauptfunktion!
</script>
</body>
</html>
