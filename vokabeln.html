<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“˜ VokabelÃ¼bersicht</title>
<style>
body{font-family:sans-serif;background:#f7f9fb;margin:0;padding:20px;text-align:center;}
.app{max-width:1100px;margin:auto;}
h1{font-size:1.8rem;margin-bottom:.6rem;}
.section{background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.05);border-radius:12px;padding:20px;margin-top:24px;text-align:left;}
.section h2{margin-top:0;color:#2c3e50;border-bottom:2px solid #e3e7ef;padding-bottom:6px;font-size:1.2rem;}
button{cursor:pointer;background:#2980b9;color:#fff;border:none;padding:8px 12px;border-radius:6px;}
button:hover{background:#3498db;}
#datasourceStatus{font-size:.9rem;margin-top:10px;color:#555;}
#reloadJson{background:#8e44ad;margin-top:5px;}
#reloadJson:hover{background:#9b59b6;}
.recent-list{list-style:none;padding:0;margin:10px 0;}
.recent-list li{background:#f7f9fb;border-left:4px solid #2980b9;margin:6px 0;padding:8px 10px;border-radius:6px;}
.recent-list span{font-weight:bold;color:#2c3e50;}
/* Snackbar-Stil */
#updateSnackbar{
  position:fixed;bottom:-120px;left:50%;transform:translateX(-50%);
  background:#2ecc71;color:#fff;padding:14px 18px;border-radius:10px;
  display:flex;align-items:center;gap:14px;box-shadow:0 4px 8px rgba(0,0,0,0.2);
  transition:bottom .5s ease;z-index:1000;
}
#updateSnackbar.show{bottom:25px;}
#updateSnackbar button{background:#27ae60;border:none;padding:6px 10px;border-radius:6px;color:#fff;}
#updateSnackbar button:hover{background:#2ecc71;}
#updateSnackbar .later{background:#7f8c8d;}
#updateSnackbar .later:hover{background:#95a5a6;}
</style>
</head>
<body>
<div class="app">
  <h1>ğŸ“˜ VokabelÃ¼bersicht</h1>
  <div class="section">
    <h2>ğŸ•’ Zuletzt hinzugefÃ¼gt</h2>
    <ul id="recentList" class="recent-list"></ul>
  </div>
  <div class="section">
    <h2>âš™ï¸ Verwaltung</h2>
    <button id="reloadJson">ğŸ”„ JSON aktualisieren</button>
    <div id="datasourceStatus">ğŸ“‚ Datenquelle: wird geprÃ¼ft...</div>
  </div>
</div>

<!-- Snackbar unten -->
<div id="updateSnackbar">
  <span>Eine neue Vokabelliste ist verfÃ¼gbar!</span>
  <button class="updateNow">ğŸ”„ Jetzt aktualisieren</button>
  <button class="later">SpÃ¤ter</button>
</div>

<script>
(() => {
  const $=s=>document.querySelector(s);
  const normalize=v=>[v[0]||"",v[1]||"",v[2]||"Gelb",v[3]||"",v[4]||"",v[5]||new Date().toISOString()];
  const loadLocal=()=>JSON.parse(localStorage.getItem("vokabeln")||"[]").map(normalize);
  const saveLocal=v=>{localStorage.setItem("vokabeln",JSON.stringify(v));localStorage.setItem("vokabeln_updated",new Date().toISOString());};

  const snackbar=$("#updateSnackbar");
  const showSnackbar=(onUpdate)=>{
    snackbar.classList.add("show");
    snackbar.querySelector(".updateNow").onclick=()=>{snackbar.classList.remove("show");onUpdate();};
    snackbar.querySelector(".later").onclick=()=>snackbar.classList.remove("show");
  };

  async function trySyncFromJson(force=false){
    const status=$("#datasourceStatus");
    const urls=["./vokabeln.json","vokabeln.json",window.location.origin+"/vokabeltrainer/vokabeln.json"];
    let newestData=null,newestDate=0,usedUrl="";
    for(const url of urls){
      try{
        const r=await fetch(url,{cache:"no-store"});
        if(!r.ok)continue;
        const txt=await r.text();
        const data=JSON.parse(txt);
        if(!Array.isArray(data))continue;
        const remoteDate=new Date(r.headers.get("last-modified")||0).getTime();
        if(remoteDate>newestDate){newestDate=remoteDate;newestData=data;usedUrl=url;}
      }catch(e){continue;}
    }
    const localUpdate=new Date(localStorage.getItem("vokabeln_updated")||0).getTime();
    if(newestData&&newestDate>localUpdate&&!force){
      showSnackbar(async()=>{
        saveLocal(newestData.map(normalize));
        status.textContent="ğŸ“‚ Datenquelle: "+usedUrl;
        renderRecent();
      });
    }else if(force&&newestData){
      saveLocal(newestData.map(normalize));
      status.textContent="ğŸ“‚ Manuell aktualisiert";
      renderRecent();
    }else if(localStorage.getItem("vokabeln")){
      status.textContent="ğŸ’¾ Lokaler Speicher aktiv";
    }else{
      const def=[["hammer","Hammer","Pink","","","2025-10-26T12:00:00Z"]];
      saveLocal(def);
      status.textContent="âœ¨ Standardliste verwendet";
    }
  }

  function renderRecent(){
    const list=loadLocal();
    const ul=$("#recentList");
    const sorted=[...list].sort((a,b)=>new Date(b[5])-new Date(a[5]));
    const last5=sorted.slice(0,5);
    ul.innerHTML=last5.map(v=>`<li><span>${v[0]}</span> â†’ ${v[1]} <small style="color:#777;">(${new Date(v[5]).toLocaleString("de-DE")})</small></li>`).join("")||"<li><em>Keine EintrÃ¤ge</em></li>";
  }

  (async function init(){
    await trySyncFromJson();
    renderRecent();
    $("#reloadJson").onclick=async()=>{await trySyncFromJson(true);renderRecent();};
  })();
})();
</script>
</body>
</html>
