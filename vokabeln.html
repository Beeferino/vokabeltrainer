<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üìò Vokabel√ºbersicht</title>
  <style>
    body { font-family: sans-serif; background: #f7f9fb; margin: 0; padding: 20px; text-align: center; }
    .app { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.08); }
    h1 { font-size: 1.8rem; margin-bottom: 0.4rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #eef2f7; cursor: pointer; user-select: none; }
    tr:hover { background: #f0f7ff; }
    input, select, button { padding: 8px 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; margin: 4px; }
    button { cursor: pointer; background: #3498db; color: #fff; border: none; }
    button:hover { background: #2980b9; }
    .category-chip { padding: 3px 8px; border-radius: 8px; color: #fff; }
    .filter-bar { margin-top: 10px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; align-items: center; }
    .lexica { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin: 8px 0; }
    .lexica button { background: #ecf0f1; color: #333; border: 1px solid #ccc; font-weight: 600; padding: 5px 9px; }
    .lexica button.active { background: #3498db; color: #fff; }
    .section-divider { margin: 24px 0; border-top: 2px solid #e0e5ec; }
    footer { margin-top: 30px; color: #666; }
    #datasourceStatus { position: fixed; right: 12px; bottom: 10px; font-size: .8rem; opacity: .75; color: #555; pointer-events: none; }

    /* Popup Editor */
    #editPopup {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      padding: 14px;
      width: 320px;
      display: none;
      text-align: left;
      z-index: 1200;
    }
    #editPopup input, #editPopup select {
      width: 100%; margin-bottom: 8px; font-size: 1rem;
      padding: 6px; border: 1px solid #ccc; border-radius: 6px;
    }
    #editPopup h3 { margin-top: 0; font-size: 1.1rem; color: #333; }
    #editPopup button { padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; }
    #editPopup button:hover { opacity: 0.9; }

    /* Zuletzt hinzugef√ºgt */
    #recentBox {
      margin-top: 25px;
      background: #f3f6fa;
      border-radius: 8px;
      padding: 15px;
      max-width: 520px;
      margin-inline: auto;
      border: 1px solid #e0e5ec;
    }
    #recentBox h3 { margin-top: 0; font-size: 1.1rem; color: #333; }
    #recentList { list-style: none; padding: 0; margin: 10px 0 0; }
    #recentList li { padding: 6px 0; border-bottom: 1px dashed #ccc; font-size: 0.95rem; }
    #recentList li:last-child { border-bottom: none; }
    .catLabel { font-size: 0.9rem; opacity: 0.8; }
  </style>
</head>
<body>
  <div class="app">
    <h1>üìò Vokabel√ºbersicht</h1>

    <div class="lexica" id="lexica"></div>

    <div class="filter-bar">
      <label>Kategorie:
        <select id="filterCategory">
          <option value="Alle">Alle (bunt gemischt)</option>
        </select>
      </label>
      <label>Gruppe / Variante:
        <select id="filterGroup"><option value="Alle">Alle</option></select>
      </label>
      <input id="searchInput" type="text" placeholder="üîé Suchen (EN / DE / Gruppe / Hinweis)">
      <button id="resetFilter">üîÑ Filter zur√ºcksetzen</button>
    </div>

    <table id="vocabTable">
      <thead>
        <tr><th>Englisch</th><th>Deutsch</th><th>Kategorie</th><th>Gruppe / Variante</th><th>Hinweis</th><th>Aktion</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="section-divider"></div>

    <div>
      <h3>‚ûï Neue Vokabel hinzuf√ºgen</h3>
      <input id="newEnglish" type="text" placeholder="Englisch">
      <input id="newGerman" type="text" placeholder="Deutsch">
      <select id="newCategory"></select>
      <input id="newGroup" type="text" placeholder="Gruppe / Variante">
      <input id="newHint" type="text" placeholder="Hinweis">
      <button id="addBtn">Hinzuf√ºgen</button>
    </div>

    <div style="margin-top:10px;">
      <button id="deleteSelected">üóëÔ∏è Ausgew√§hlte l√∂schen</button>
    </div>

    <div class="section-divider"></div>

    <div>
      <h3>üíæ Datei- & JSON-Verwaltung</h3>
      <button id="exportBtn">üì§ Exportieren</button>
      <input type="file" id="importFile" accept=".json" style="display:none;">
      <button id="importBtn">üì• Importieren</button>
      <button id="downloadMerged">üíæ vokabeln.json herunterladen</button>
      <div style="margin-top:15px;">
        <a href="index.html" class="linkbtn" style="background:#74b9ff;padding:8px 14px;border-radius:6px;text-decoration:none;color:#000;">‚¨ÖÔ∏è Zur√ºck zum Trainer</a>
      </div>
    </div>

    <!-- Zuletzt hinzugef√ºgt -->
    <div id="recentBox">
      <h3>üìú Zuletzt hinzugef√ºgt</h3>
      <ul id="recentList"><li><em>Keine Vokabeln vorhanden.</em></li></ul>
    </div>

    <footer style="margin-top:20px;">¬© 2025 @Beefi</footer>
  </div>

  <div id="editPopup">
    <h3>‚úèÔ∏è Vokabel bearbeiten</h3>
    <input id="editEn" placeholder="Englisch">
    <input id="editDe" placeholder="Deutsch">
    <select id="editCat"></select>
    <input id="editGrp" placeholder="Gruppe / Variante">
    <input id="editHint" placeholder="Hinweis">
    <div style="text-align:right;">
      <button id="editCancel" style="background:#ccc;">‚úñ Abbrechen</button>
      <button id="editSave" style="background:#27ae60;color:#fff;">üíæ Speichern</button>
    </div>
  </div>

  <div id="datasourceStatus">üíæ Datenquelle: wird gepr√ºft...</div>

  <script>
  (() => {
    const CATEGORY_NAMES = {
      Gelb:"Grundwerkzeuge Metallverarbeitung",
      Pink:"Werkzeugkasten Mechaniker",
      Blau:"Blech- / Kunststoffarbeiten",
      Gruen:"Drehen / Fr√§sen",
      HellesPink:"Hydraulik / Pneumatik",
      Orange:"Elektrotechnik",
      Dunkelgruen:"Flugger√§temechanik allgemein",
      Rot:"Verwechslungsgefahr"
    };
    const COLOR_MAP = {
      Gelb:"#F4D03F", Pink:"#E91E63", Blau:"#1976D2",
      Gruen:"#1E8449", HellesPink:"#F54927", Orange:"#E67E22",
      Dunkelgruen:"#117A65", Rot:"#C0392B"
    };

    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const normalize = v => [v[0]||"", v[1]||"", v[2]||"Gelb", v[3]||"", v[4]||"", v[5]||new Date().toISOString()];
    const loadLocal = () => JSON.parse(localStorage.getItem("vokabeln") || "[]").map(normalize);
    const saveLocal = v => { localStorage.setItem("vokabeln", JSON.stringify(v)); localStorage.setItem("vokabeln_updated", new Date().toISOString()); };
    const statusEl = $("#datasourceStatus");

    async function trySyncFromJson(){
      const urls=["./vokabeln.json","vokabeln.json",window.location.origin+"/vokabeln.json",window.location.origin+"/vokabeltrainer/vokabeln.json"];
      let remote=null;
      for(const u of urls){
        try{
          const r=await fetch(u,{cache:"no-store"});
          if(r.ok){ const d=await r.json(); if(Array.isArray(d)){remote=d;break;} }
        }catch{}
      }
      const local=loadLocal();
      if(!remote && local.length===0){
        const def=[["hammer","Hammer","Pink","","","2025-01-01T00:00:00Z"],["file","Feile","Gelb","","","2025-01-01T00:00:00Z"]];
        saveLocal(def);
        statusEl.textContent="‚ú® Standardliste verwendet";
      } else if(remote){
        const merged=merge(remote, local);
        saveLocal(merged);
        statusEl.textContent="üîÑ JSON + lokale Erg√§nzungen (gemergt)";
      } else statusEl.textContent="üíæ Lokaler Speicher (Offline)";
      list=loadLocal();
      render();
      renderRecent();
    }

    function merge(remote, local){
      const map=new Map();
      remote.map(normalize).forEach(v=>map.set(v[0].toLowerCase()+"|"+v[1].toLowerCase(),v));
      local.map(normalize).forEach(v=>{const k=v[0].toLowerCase()+"|"+v[1].toLowerCase();if(!map.has(k))map.set(k,v);});
      return Array.from(map.values());
    }

    let list=[];
    let editIndex=-1;

    function render(){
      const tbody=$("#vocabTable tbody");
      tbody.innerHTML="";
      list.forEach((v,i)=>{
        const [en,de,cat,grp,hint]=v;
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${en}</td><td>${de}</td>
          <td><span class='category-chip' style='background:${COLOR_MAP[cat]||"#ccc"}'>${CATEGORY_NAMES[cat]||cat}</span></td>
          <td>${grp||""}</td><td>${hint||""}</td>
          <td><button class='edit-btn' data-i='${i}'>‚úèÔ∏è</button></td>`;
        tbody.appendChild(tr);
      });
      $$(".edit-btn").forEach(b=>b.onclick=()=>openEditor(parseInt(b.dataset.i)));
    }

    function openEditor(i){
      editIndex=i;
      const [en,de,cat,grp,hint]=list[i];
      $("#editEn").value=en;
      $("#editDe").value=de;
      $("#editGrp").value=grp||"";
      $("#editHint").value=hint||"";
      const sel=$("#editCat");
      sel.innerHTML="";
      Object.keys(CATEGORY_NAMES).forEach(k=>{
        const o=document.createElement("option");
        o.value=k;o.textContent=CATEGORY_NAMES[k];
        if(k===cat)o.selected=true;
        sel.appendChild(o);
      });
      $("#editPopup").style.display="block";
    }

    $("#editCancel").onclick=()=>$("#editPopup").style.display="none";
    $("#editSave").onclick=()=>{
      if(editIndex<0)return;
      const v=list[editIndex];
      list[editIndex]=[
        $("#editEn").value.trim()||v[0],
        $("#editDe").value.trim()||v[1],
        $("#editCat").value,
        $("#editGrp").value.trim(),
        $("#editHint").value.trim(),
        v[5]
      ];
      saveLocal(list);
      render();
      renderRecent();
      $("#editPopup").style.display="none";
    };

    $("#addBtn").onclick=()=>{
      const en=$("#newEnglish").value.trim();
      const de=$("#newGerman").value.trim();
      const cat=$("#newCategory").value;
      const grp=$("#newGroup").value.trim();
      const hint=$("#newHint").value.trim();
      if(!en||!de)return alert("Bitte Englisch und Deutsch ausf√ºllen!");
      list.push([en,de,cat,grp,hint,new Date().toISOString()]);
      saveLocal(list);
      render(); renderRecent();
      $("#newEnglish").value=$("#newGerman").value=$("#newGroup").value=$("#newHint").value="";
    };

    $("#deleteSelected").onclick=()=>{
      if(!confirm("Ausgew√§hlte l√∂schen?"))return;
      const checkboxes=$$("input[type=checkbox]:checked");
      const idxs=checkboxes.map(c=>parseInt(c.dataset.i)).sort((a,b)=>b-a);
      idxs.forEach(i=>list.splice(i,1));
      saveLocal(list);
      render(); renderRecent();
    };

    $("#exportBtn").onclick=()=>{
      const blob=new Blob([JSON.stringify(list,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="vokabeln.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };

    $("#importBtn").onclick=()=>$("#importFile").click();
    $("#importFile").onchange=e=>{
      const f=e.target.files[0];
      if(!f)return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          const incoming=JSON.parse(r.result);
          list=merge(list,incoming);
          saveLocal(list);
          render(); renderRecent();
        }catch{alert("Fehler beim Import");}
      };
      r.readAsText(f);
    };
    $("#downloadMerged").onclick=()=>$("#exportBtn").click();

    function renderRecent(){
      const ul=$("#recentList");
      ul.innerHTML="";
      const last=list.slice(-5).reverse();
      if(!last.length){ul.innerHTML="<li><em>Keine Vokabeln vorhanden.</em></li>";return;}
      last.forEach(([en,de,cat])=>{
        const li=document.createElement("li");
        li.innerHTML=`<b>${en}</b> ‚Äì ${de} <span class='catLabel' style='color:${COLOR_MAP[cat]||"#555"}'>(${CATEGORY_NAMES[cat]||cat})</span>`;
        ul.appendChild(li);
      });
    }

    (async function init(){
      Object.keys(CATEGORY_NAMES).forEach(k=>{
        const o=document.createElement("option");o.value=k;o.textContent=CATEGORY_NAMES[k];
        $("#newCategory").appendChild(o);
      });
      await trySyncFromJson();
    })();
  })();
  </script>
</body>
</html>
