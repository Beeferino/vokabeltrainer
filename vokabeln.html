<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vokabelübersicht</title>
<style>
body{font-family:sans-serif;background:#f7f9fb;margin:0;padding:20px;}
.app{max-width:900px;margin:auto;text-align:center;}
h1{font-size:1.8rem;margin-bottom:1rem;}
table{border-collapse:collapse;width:100%;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.1);border-radius:12px;overflow:hidden;}
th,td{padding:10px;border-bottom:1px solid #ddd;}
th{background:#2980b9;color:#fff;}
tr:hover{background:#f1f8ff;}
input,select,button{font-size:1rem;padding:8px 12px;border-radius:8px;border:1px solid #ccc;margin:5px;}
button{cursor:pointer;background:#2980b9;color:#fff;border:none;transition:background .2s ease,transform .1s ease;}
button:hover{background:#3498db;transform:translateY(-1px);}
.controls{margin:20px 0;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
.footer{margin-top:30px;font-size:0.95rem;color:#555;}
a.linkbtn{display:inline-block;padding:10px 16px;border-radius:8px;background:#74b9ff;color:#000;text-decoration:none;font-weight:600;}
a.linkbtn:hover{background:#a6d4ff;}
#datasourceStatus{position:fixed;right:12px;bottom:10px;font-size:.8rem;opacity:.75;color:#555;pointer-events:none;}
</style>
</head>
<body>
<div class="app">
<h1>📘 Vokabelübersicht</h1>

<div class="controls">
<input id="en" placeholder="Englisch">
<input id="de" placeholder="Deutsch">
<select id="cat">
<option value="Gelb">Grundwerkzeuge Metallverarbeitung</option>
<option value="Pink">Werkzeugkasten Mechaniker</option>
<option value="Blau">Blech-/Kunststoffarbeiten</option>
<option value="Gruen">Drehen / Fräsen</option>
<option value="HellesPink">Hydraulik / Pneumatik</option>
<option value="Orange">Elektrotechnik</option>
<option value="Dunkelgruen">Fluggerätemechanik allgemein</option>
<option value="Rot">Verwechslungsgefahr</option>
</select>
<button id="addBtn">➕ Hinzufügen</button>
<button id="updateJsonBtn">🔄 JSON aktualisieren</button>
<button id="exportBtn">💾 vokabeln.json herunterladen</button>
</div>

<table id="table">
<thead><tr><th>Englisch</th><th>Deutsch</th><th>Kategorie</th><th>Aktionen</th></tr></thead>
<tbody></tbody>
</table>

<div class="footer">
<a href="index.html" class="linkbtn">🏠 Zurück zum Trainer</a>
</div>
</div>

<div id="datasourceStatus">💾 Datenquelle: Lokaler Speicher</div>

<script>
/* ================================
   ROBUSTER JSON-SYNC mit MERGE + EXPORT + BACKUP
   ================================ */
const statusEl=document.getElementById("datasourceStatus");

function getDefaultList(){
  return [["hammer","Hammer","Pink"],["file","Feile","Gelb"],["drill","Bohrer","Pink"]];
}
function mergeVocabLists(remote,local){
  const key=v=>`${v[0].toLowerCase()}|${v[1].toLowerCase()}`;
  const map=new Map();
  remote.forEach(v=>map.set(key(v),v));
  local.forEach(v=>{if(!map.has(key(v)))map.set(key(v),v);});
  return Array.from(map.values());
}
function saveLocal(v){localStorage.setItem("vokabeln",JSON.stringify(v));localStorage.setItem("vokabeln_updated",new Date().toISOString());}
function loadLocal(){return JSON.parse(localStorage.getItem("vokabeln")||"[]");}

/* 🔒 BACKUP-FUNKTION */
function createBackup(){
  const data=JSON.stringify(loadLocal(),null,2);
  const blob=new Blob([data],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const timestamp=new Date().toISOString().split("T")[0];
  a.href=url;
  a.download=`vokabeln_backup_${timestamp}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

/* 💾 EXPORT-AKTUELL */
function exportJson(){
  const data=JSON.stringify(loadLocal(),null,2);
  const blob=new Blob([data],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="vokabeln.json";a.click();
  URL.revokeObjectURL(url);
}

/* 🔄 JSON-SYNC (mit Merge) */
async function trySyncFromJson(){
  const urls=["./vokabeln.json","vokabeln.json",window.location.origin+"/vokabeln.json",window.location.origin+"/vokabeltrainer/vokabeln.json"];
  let remote=null;
  for(const u of urls){
    try{
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok)continue;
      const d=await r.json();
      if(Array.isArray(d)){remote=d;break;}
    }catch{}
  }
  const local=loadLocal();
  if(!remote&&local.length===0){
    const def=getDefaultList();
    saveLocal(def);
    statusEl.textContent="✨ Standardliste verwendet";
    renderTable();
    return;
  }
  if(remote){
    const merged=mergeVocabLists(remote,local);
    saveLocal(merged);
    statusEl.textContent="🔄 JSON + lokale Ergänzungen";
    renderTable();
  } else {
    statusEl.textContent="💾 Lokaler Speicher";
    renderTable();
  }
}

/* ================================
   TABELLE + BEARBEITUNG
   ================================ */
const tbody=document.querySelector("#table tbody");

function renderTable(){
  const data=loadLocal();
  tbody.innerHTML="";
  data.forEach((v,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${v[0]}</td>
      <td>${v[1]}</td>
      <td>${v[2]}</td>
      <td>
        <button onclick="deleteRow(${i})">❌</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* 🔥 Löschen mit automatischem Backup */
function deleteRow(i){
  const data=loadLocal();
  if(confirm(`"${data[i][0]}" wirklich löschen? Es wird vorher ein Backup erstellt.`)){
    createBackup(); // 💾 Backup anlegen
    data.splice(i,1);
    saveLocal(data);
    renderTable();
  }
}

/* ➕ Hinzufügen */
document.getElementById("addBtn").onclick=()=>{
  const en=document.getElementById("en").value.trim();
  const de=document.getElementById("de").value.trim();
  const cat=document.getElementById("cat").value;
  if(!en||!de)return alert("Bitte beide Felder ausfüllen.");
  const data=loadLocal();
  data.push([en,de,cat]);
  saveLocal(data);
  document.getElementById("en").value="";
  document.getElementById("de").value="";
  renderTable();
};

/* 🔘 Buttons */
document.getElementById("updateJsonBtn").onclick=trySyncFromJson;
document.getElementById("exportBtn").onclick=exportJson;

/* 🚀 Start */
trySyncFromJson();
</script>
</body>
</html>
