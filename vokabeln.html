<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üìò Vokabel√ºbersicht</title>

  <style>
    body { font-family: sans-serif; background: #f7f9fb; margin: 0; padding: 20px; text-align: center; }
    .app { max-width: 1100px; margin: auto; }
    h1 { font-size: 1.8rem; margin-bottom: 0.6rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #eef2f7; cursor: pointer; user-select: none; }
    th.sort-asc::after { content: " ‚Üë"; color: #666; }
    th.sort-desc::after { content: " ‚Üì"; color: #666; }
    tr:hover { background: #f0f7ff; }
    .category-chip { display: inline-block; padding: 5px 10px; border-radius: 10px; color: #fff; }
    input, select, button { padding: 8px 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #cfd6e4; margin: 5px; }
    button { cursor: pointer; background: #2980b9; color: #fff; border: none; }
    button:hover { background: #3498db; }
    a.linkbtn { display: inline-block; padding: 10px 16px; border-radius: 8px; background: #74b9ff; color: #000; text-decoration: none; font-weight: 600; }
    a.linkbtn:hover { background: #a6d4ff; }
    .info-footer { margin-top: 16px; font-size: 0.95rem; color: #555; }
    .lexica { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin: 10px 0; }
    .lexica button { background: #ecf0f1; color: #333; border: 1px solid #ccc; font-weight: 600; padding: 6px 9px; }
    .lexica button.active { background: #2980b9; color: #fff; }
    .filter-bar { margin-top: 10px; display: flex; justify-content: center; gap: 14px; flex-wrap: wrap; align-items: center; }
    .searchbox { min-width: 260px; }
    .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
    .pagination button { background: #ecf0f1; color: #333; border: 1px solid #ccc; padding: 6px 10px; }
    .pagination button.active { background: #2980b9; color: #fff; }
    .section-divider { margin: 24px 0; border-top: 3px solid #e3e7ef; }
    .new-entry { margin-top: 10px; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #2ecc71; color: #fff; padding: 10px 16px; border-radius: 8px; display: none; z-index: 999; }
    .colored { transition: background 0.3s ease; }
    footer { margin-top: 30px; }
    #datasourceStatus { position: fixed; right: 12px; bottom: 10px; font-size: .8rem; opacity: .75; color: #555; pointer-events: none; }

    /* Zuletzt hinzugef√ºgt Box */
    #recentBox { background: #fafbff; border-radius: 12px; padding: 10px 18px; margin: 10px auto 18px; box-shadow: inset 0 1px 2px rgba(0,0,0,.05); max-width: 520px; }
    #recentBox ul { list-style: none; padding: 0; margin: 0; }
    #recentBox li { padding: 6px 0; border-bottom: 1px dashed #ccc; }
    #recentBox li:last-child { border-bottom: none; }
    .catLabel { font-size: 0.9rem; opacity: .75; }

    /* Modal (Popup) f√ºr Bearbeiten */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: #fff; width: 95%; max-width: 560px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); padding: 14px 16px 12px; text-align: left; }
    .modal header { font-weight: 700; font-size: 1.1rem; margin-bottom: 6px; }
    .modal .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .modal .row + .row { margin-top: 6px; }
    .modal footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
    .btn-secondary { background: #95a5a6; }
    .btn-secondary:hover { background: #aab7b8; }
    .btn-danger { background: #e74c3c; }
    .btn-danger:hover { background: #ff6b5a; }
  </style>
</head>

<body>
  <div class="app">
    <h1>üìò Vokabel√ºbersicht</h1>

    <div id="lexica" class="lexica"></div>

    <div class="filter-bar">
      <label>Kategorie:
        <select id="filterCategory" class="colored"></select>
      </label>
      <label>Gruppe / Variante:
        <select id="filterGroup"><option value="Alle">Alle</option></select>
      </label>
      <input id="searchInput" class="searchbox" type="text" placeholder="üîé Suchen (EN / DE / Gruppe / Hinweis)">
      <button id="resetFilter">üîÑ Filter zur√ºcksetzen</button>
    </div>

    <table id="vocabTable">
      <thead>
        <tr>
          <th style="width:36px;">&nbsp;</th>
          <th data-key="en">Englisch</th>
          <th data-key="de">Deutsch</th>
          <th data-key="cat">Kategorie</th>
          <th data-key="grp">Gruppe / Variante</th>
          <th data-key="hint">Hinweis</th>
          <th style="width:100px;">Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="pagination" class="pagination"></div>
    <div id="infoFooter" class="info-footer"></div>

    <div class="section-divider"></div>

    <div class="new-entry">
      <h3>‚ûï Neue Vokabel hinzuf√ºgen</h3>
      <div>
        <input id="newEnglish" type="text" placeholder="Englisch" disabled>
        <input id="newGerman" type="text" placeholder="Deutsch" disabled>
        <select id="newCategory" class="colored" disabled></select>
        <input id="newGroup" type="text" placeholder="Gruppe / Variante" disabled>
        <input id="newHint" type="text" placeholder="Hinweis" disabled>
        <button id="addBtn" disabled>Hinzuf√ºgen</button>
      </div>
      <div style="margin-top:8px;">
        <button id="toggleAdd">‚úèÔ∏è Eingabe aktivieren</button>
        <button id="deleteSelected">üóëÔ∏è Ausgew√§hlte l√∂schen</button>
      </div>
    </div>

    <div class="section-divider"></div>

    <footer>
      <h3>üíæ Datei- & JSON-Verwaltung</h3>
      <div style="margin-top:10px;">
        <button id="exportBtn">üì§ Exportieren</button>
        <input type="file" id="importFile" accept=".json" style="display:none;">
        <button id="importBtn">üì• Importieren</button>
        <button id="downloadMerged">üíæ vokabeln.json herunterladen</button>
      </div>

      <div class="section-divider"></div>

      <h3>üìú Zuletzt hinzugef√ºgt</h3>
      <div id="recentBox"><ul id="recentList"><li><em>Keine Vokabeln vorhanden.</em></li></ul></div>

      <a href="index.html" class="linkbtn">‚¨ÖÔ∏è Zur√ºck zum Trainer</a>
    </footer>
  </div>

  <div id="toast" class="toast">üíæ Gespeichert</div>
  <div id="datasourceStatus">üîÑ JSON + lokale Erg√§nzungen (gemergt)</div>

  <!-- Modal: Bearbeiten -->
  <div id="editBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>‚úèÔ∏è Vokabel bearbeiten</header>
      <div class="row">
        <input id="eEn" placeholder="Englisch">
        <input id="eDe" placeholder="Deutsch">
      </div>
      <div class="row">
        <select id="eCat" class="colored"></select>
        <input id="eGrp" placeholder="Gruppe / Variante">
      </div>
      <div class="row">
        <input id="eHint" placeholder="Hinweis">
        <input id="eDate" type="datetime-local" title="√Ñnderungsdatum (optional)">
      </div>
      <footer>
        <button id="eCancel" class="btn-secondary">Abbrechen</button>
        <button id="eDelete" class="btn-danger">L√∂schen</button>
        <button id="eSave" class="save-btn">üíæ Speichern</button>
      </footer>
    </div>
  </div>

  <script>
  (() => {
    // --- Konstanten & Utilities ---
    const CATEGORY_NAMES = { Gelb:"Grundwerkzeuge Metallverarbeitung", Pink:"Werkzeugkasten Mechaniker", Blau:"Blech- / Kunststoffarbeiten", Gruen:"Drehen / Fr√§sen", HellesPink:"Hydraulik / Pneumatik", Orange:"Elektrotechnik", Dunkelgruen:"Flugger√§temechanik allgemein", Rot:"Verwechslungsgefahr" };
    const COLOR_MAP = { Gelb:"#F4D03F", Pink:"#E91E63", Blau:"#1976D2", Gruen:"#1E8449", HellesPink:"#F54927", Orange:"#E67E22", Dunkelgruen:"#117A65", Rot:"#C0392B" };
    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const toast = m => { const t=$("#toast"); t.textContent=m; t.style.display="block"; setTimeout(()=>t.style.display="none",1500); };
    const labelForCategory = k => CATEGORY_NAMES[k] || k;

    const normalize = v => [v[0]||"", v[1]||"", v[2]||"Gelb", v[3]||"", v[4]||"", v[5]||new Date().toISOString()];
    const loadLocal = () => JSON.parse(localStorage.getItem("vokabeln") || "[]").map(normalize);
    const saveLocal = (v) => { localStorage.setItem("vokabeln", JSON.stringify(v)); localStorage.setItem("vokabeln_updated", new Date().toISOString()); renderRecent(); };

    const statusEl = document.getElementById('datasourceStatus');

    function setSelectColor(sel, val){
      if (!val || val === "Alle") { sel.style.background="#fff"; sel.style.color="#111"; sel.style.border="1px solid #cfd6e4"; return; }
      const c = COLOR_MAP[val] || "#fff"; sel.style.background=c; sel.style.color="#fff"; sel.style.border="1px solid #999";
    }

    function renderCategorySelect(sel, includeAll=false){
      sel.innerHTML = includeAll ? "<option value='Alle'>Alle (bunt gemischt)</option>" : "";
      Object.keys(CATEGORY_NAMES).forEach(k => {
        const o=document.createElement("option");
        o.value=k; o.textContent=labelForCategory(k);
        o.style.background = COLOR_MAP[k]; o.style.color = "#fff";
        sel.appendChild(o);
      });
      setSelectColor(sel, sel.value);
      sel.onchange = () => setSelectColor(sel, sel.value);
    }

    // --- Merge + Sync ---
    const keyOf = v => `${(v[0]||"").toLowerCase().trim()}|${(v[1]||"").toLowerCase().trim()}`;
    const mergeVocabLists = (remote, local) => {
      const map = new Map();
      remote.map(normalize).forEach(v => map.set(keyOf(v), v));
      local.map(normalize).forEach(v => { if (!map.has(keyOf(v))) map.set(keyOf(v), v); });
      return Array.from(map.values());
    };

    async function trySyncFromJson(){
      const urls = ["./vokabeln.json", "vokabeln.json", location.origin + "/vokabeln.json", location.origin + "/vokabeltrainer/vokabeln.json"];
      let remote = null;
      for (const u of urls) {
        try {
          const r = await fetch(u, { cache: "no-store" });
          if (!r.ok) continue;
          const d = await r.json();
          if (Array.isArray(d)) { remote = d; break; }
        } catch {}
      }
      const local = loadLocal();
      if (!remote && local.length === 0) {
        saveLocal([["hammer","Hammer","Pink","","","2025-01-01T00:00:00Z"]]);
        statusEl.textContent = "‚ú® Standardliste verwendet";
      } else if (remote) {
        saveLocal(mergeVocabLists(remote, local));
        statusEl.textContent = "üîÑ JSON + lokale Erg√§nzungen (gemergt)";
      } else {
        statusEl.textContent = "üíæ Lokaler Speicher (Offline)";
      }
      list = loadLocal();
      renderAll();
    }

    function downloadBlob(name, json) {
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }
    function exportJson() { downloadBlob("vokabeln.json", JSON.stringify(loadLocal(), null, 2)); }

    // --- Zustand ---
    let list = [];
    let letter = "Alle";
    let filterCat = "Alle";
    let filterGrp = "Alle";
    let searchTerm = "";
    let currentPage = 1;
    const perPage = 15;
    let sortKey = "en", sortDir = "asc";

    // --- Rendering ---
    function renderLexica(){
      const lx=$("#lexica"); lx.innerHTML = "";
      ["Alle", ...Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZ")].forEach(l => {
        const b=document.createElement("button"); b.textContent=l;
        if(l===letter) b.classList.add("active");
        b.onclick = () => { letter=l; currentPage=1; renderTable(); renderLexica(); };
        lx.appendChild(b);
      });
    }

    function renderFilterCategory(){
      const sel = $("#filterCategory");
      renderCategorySelect(sel, true);
      sel.value = "Alle";
      setSelectColor(sel, sel.value);
      sel.onchange = e => { filterCat = e.target.value; setSelectColor(sel, filterCat); currentPage = 1; renderTable(); };
    }

    function renderFilterGroup(){
      const groups = [...new Set(list.map(v => v[3]).filter(Boolean))].sort((a, b) => a.localeCompare(b, "de"));
      const sel = $("#filterGroup");
      sel.innerHTML = "<option value='Alle'>Alle</option>" + groups.map(g => `<option>${g}</option>`).join("");
      sel.onchange = e => { filterGrp = e.target.value; currentPage = 1; renderTable(); };
    }

    function filtered(){
      return list.filter(([en, de, cat, grp, hint]) => {
        if (letter !== "Alle" && !en.toUpperCase().startsWith(letter)) return false;
        if (filterCat !== "Alle" && cat !== filterCat) return false;
        if (filterGrp !== "Alle" && grp !== filterGrp) return false;
        if (searchTerm) {
          const hay = (en + " " + de + " " + (grp||"") + " " + (hint||"")).toLowerCase();
          if (!hay.includes(searchTerm)) return false;
        }
        return true;
      });
    }

    function sortList(arr){
      const map = { en:0, de:1, cat:2, grp:3, hint:4, date:5 };
      const i = map[sortKey];
      return arr.sort((a, b) => {
        let A = a[i] || "", B = b[i] || "";
        if (sortKey === "date") { A = new Date(A).getTime(); B = new Date(B).getTime(); }
        else { A = A.toString().toLowerCase(); B = B.toString().toLowerCase(); }
        if (A < B) return sortDir === "asc" ? -1 : 1;
        if (A > B) return sortDir === "asc" ? 1 : -1;
        return 0;
      });
    }

    function renderTable(){
      const all = sortList(filtered());
      const pages = Math.max(1, Math.ceil(all.length / perPage));
      if (currentPage > pages) currentPage = pages;
      const start = (currentPage - 1) * perPage;
      const rows = all.slice(start, start + perPage);

      const tbody = $("#vocabTable tbody"); tbody.innerHTML = "";
      rows.forEach(v => {
        const [en, de, cat, grp, hint] = v;
        const i = list.indexOf(v); // gleiche Referenz -> ok
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" data-index="${i}"></td>
          <td>${en}</td>
          <td>${de}</td>
          <td><span class="category-chip" style="background:${COLOR_MAP[cat]||"#999"}">${labelForCategory(cat)}</span></td>
          <td>${grp || ""}</td>
          <td>${hint || ""}</td>
          <td>
            <button class="edit-btn" data-index="${i}">‚úèÔ∏è</button>
          </td>`;
        tbody.appendChild(tr);
      });

      const pagination = $("#pagination"); pagination.innerHTML = "";
      for (let p = 1; p <= pages; p++) {
        const b=document.createElement("button");
        b.textContent = p;
        if (p === currentPage) b.classList.add("active");
        b.onclick = () => { currentPage = p; renderTable(); };
        pagination.appendChild(b);
      }

      const upd = localStorage.getItem("vokabeln_updated");
      $("#infoFooter").textContent = `üìÖ Letzte √Ñnderung: ${upd ? new Date(upd).toLocaleString("de-DE") : "‚Äì"} | üìö Gesamt: ${list.length} | üî§ Angezeigt: ${all.length}`;

      // Edit-Buttons -> Modal
      $$(".edit-btn").forEach(b => b.onclick = () => openEditModal(parseInt(b.dataset.index, 10)));
    }

    function bindSort(){
      $$("#vocabTable thead th").forEach(th => {
        const k = th.dataset.key; if (!k) return;
        th.onclick = () => {
          if (sortKey === k) sortDir = (sortDir === "asc" ? "desc" : "asc");
          else { sortKey = k; sortDir = "asc"; }
          $$("#vocabTable thead th").forEach(t => t.classList.remove("sort-asc", "sort-desc"));
          th.classList.add(sortDir === "asc" ? "sort-asc" : "sort-desc");
          renderTable();
        };
      });
    }

    function renderRecent(){
      const ul = $("#recentList"); ul.innerHTML = "";
      const last = loadLocal().slice(-5).reverse();
      if (!last.length) { ul.innerHTML = "<li><em>Keine Vokabeln vorhanden.</em></li>"; return; }
      last.forEach(([en, de, cat]) => {
        const li = document.createElement("li");
        li.innerHTML = `<b>${en}</b> ‚Äì ${de} <span class="catLabel" style="color:${COLOR_MAP[cat]||"#555"}">(${labelForCategory(cat)})</span>`;
        ul.appendChild(li);
      });
    }

    function afterListChange(){
      renderFilterGroup();
      renderTable();
      renderRecent();
    }

    function renderAll(){
      renderCategorySelect(document.getElementById("newCategory"), false);
      renderFilterCategory();
      renderFilterGroup();
      renderLexica();
      renderTable();
      bindSort();
      renderRecent();
    }

    // --- Modal Bearbeiten ---
    let editingIndex = -1;
    const backdrop = $("#editBackdrop");
    const eEn = $("#eEn"), eDe = $("#eDe"), eCat = $("#eCat"), eGrp = $("#eGrp"), eHint = $("#eHint"), eDate = $("#eDate");
    renderCategorySelect(eCat, false);

    function openEditModal(i){
      editingIndex = i;
      const [en, de, cat, grp, hint, date] = list[i];
      eEn.value = en; eDe.value = de; eCat.value = cat; setSelectColor(eCat, cat);
      eGrp.value = grp || ""; eHint.value = hint || "";
      eDate.value = date ? toLocalDatetime(date) : "";
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");
      eEn.focus();
    }
    function closeEditModal(){
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
      editingIndex = -1;
    }
    $("#eCancel").onclick = closeEditModal;
    backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeEditModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && backdrop.style.display === "flex") closeEditModal(); });

    $("#eSave").onclick = () => {
      if (editingIndex < 0) return;
      const newEn = eEn.value.trim(), newDe = eDe.value.trim();
      const newCat = eCat.value, newGrp = eGrp.value.trim(), newHint = eHint.value.trim();
      const newDate = eDate.value ? new Date(eDate.value).toISOString() : (list[editingIndex][5] || new Date().toISOString());
      if (!newEn || !newDe) return alert("Bitte Englisch und Deutsch ausf√ºllen!");
      list[editingIndex] = [newEn, newDe, newCat, newGrp, newHint, newDate];
      saveLocal(list);
      closeEditModal();
      afterListChange();
      toast("üíæ Gespeichert");
    };

    $("#eDelete").onclick = () => {
      if (editingIndex < 0) return;
      if (!confirm("Diese Vokabel wirklich l√∂schen?")) return;
      list.splice(editingIndex, 1);
      saveLocal(list);
      closeEditModal();
      afterListChange();
      toast("üóëÔ∏è Gel√∂scht");
    };

    function toLocalDatetime(iso){
      try {
        const d = new Date(iso);
        const pad = n => String(n).padStart(2, "0");
        return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) + "T" + pad(d.getHours()) + ":" + pad(d.getMinutes());
      } catch { return ""; }
    }

    // --- INIT + Controls ---
    (async function init(){
      await trySyncFromJson(); // list wird gesetzt
      // Eingabe-Toggle
      $("#toggleAdd").onclick = () => {
        const d = $("#newEnglish").disabled;
        ["newEnglish","newGerman","newCategory","newGroup","newHint","addBtn"].forEach(id=>{ $("#"+id).disabled = !d; });
        setSelectColor($("#newCategory"), $("#newCategory").value);
        $("#toggleAdd").textContent = d ? "üîí Eingabe sperren" : "‚úèÔ∏è Eingabe aktivieren";
        if (d) $("#newEnglish").focus();
      };

      $("#addBtn").onclick = () => {
        const en = $("#newEnglish").value.trim(),
              de = $("#newGerman").value.trim(),
              cat = $("#newCategory").value,
              grp = $("#newGroup").value.trim(),
              hint = $("#newHint").value.trim();
        if (!en || !de) return alert("Bitte ausf√ºllen!");
        list.push([en, de, cat, grp, hint, new Date().toISOString()]);
        saveLocal(list);
        $("#newEnglish").value = ""; $("#newGerman").value = ""; $("#newGroup").value = ""; $("#newHint").value = "";
        afterListChange();
        toast("‚ûï Hinzugef√ºgt");
      };

      $("#deleteSelected").onclick = () => {
        const sel = Array.from(document.querySelectorAll("input[type=checkbox]:checked"));
        if (!sel.length) return alert("Bitte ausw√§hlen!");
        if (!confirm("Ausgew√§hlte Vokabel(n) l√∂schen?")) return;
        const ids = sel.map(c => parseInt(c.dataset.index)).sort((a, b) => b - a);
        ids.forEach(i => list.splice(i, 1));
        saveLocal(list);
        afterListChange();
        toast("üóëÔ∏è Gel√∂scht");
      };

      $("#exportBtn").onclick = () => {
        const data = JSON.stringify(loadLocal(), null, 2);
        downloadBlob("vokabeln.json", data);
        toast("üì§ Exportiert");
      };
      $("#downloadMerged").onclick = exportJson;

      $("#importBtn").onclick = () => $("#importFile").click();
      $("#importFile").onchange = e => {
        const f = e.target.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const incoming = JSON.parse(r.result).map(normalize);
            if (confirm("Bestehende √ºberschreiben? (Abbrechen = Anh√§ngen)")) list = incoming;
            else list = mergeVocabLists(list, incoming);
            saveLocal(list);
            afterListChange();
            toast("üì• Importiert");
          } catch { alert("Fehler beim Import."); }
        };
        r.readAsText(f);
      };

      $("#resetFilter").onclick = () => {
        filterCat = "Alle"; filterGrp = "Alle"; letter = "Alle"; searchTerm = "";
        $("#searchInput").value = "";
        renderFilterCategory(); renderFilterGroup(); renderLexica(); renderTable();
      };
      $("#searchInput").addEventListener("input", e => { searchTerm = e.target.value.trim().toLowerCase(); currentPage = 1; renderTable(); });
    })();
  })();
  </script>
</body>
</html>
