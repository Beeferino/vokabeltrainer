<script>
/* === GitHub Sync (Token) ‚Äì f√ºgt sich in bestehendes UI ein, Layout bleibt unver√§ndert === */
(() => {
  const GH = {
    owner: "Beeferino",
    repo: "vokabeltrainer",
    branch: "main",
    path: "vokabeln.json",
    apiBase: "https://api.github.com"
  };

  // ---- Mini-UI (nicht-invasiv): Token Modal nur bei Bedarf einblenden ----
  function ensureTokenModal() {
    if (document.getElementById("ghTokenModal")) return;
    const modal = document.createElement("div");
    modal.id = "ghTokenModal";
    modal.style.cssText = "display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:9999;align-items:center;justify-content:center;";
    modal.innerHTML = `
      <div style="background:#fff; padding:18px 20px; border-radius:12px; width:90%; max-width:420px; box-shadow:0 10px 30px rgba(0,0,0,.25); font-family:system-ui,sans-serif;">
        <h3 style="margin:0 0 8px; font-size:1.1rem;">GitHub-Token</h3>
        <p style="margin:0 0 10px; color:#444; line-height:1.4;">
          Bitte ein <b>Fine-grained PAT</b> (Repo-Zugriff: Content: Read/Write) einf√ºgen. Der Token wird <i>nur lokal</i> gespeichert.
        </p>
        <input id="ghTokenInput" type="password" placeholder="ghp_‚Ä¶"
               style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:0.95rem;">
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button id="ghTokenSave" style="background:#2563eb;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;">Token speichern</button>
          <button id="ghTokenCancel" style="background:#e5e7eb;color:#111;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;">Abbrechen</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
    document.getElementById("ghTokenSave").onclick = () => {
      const t = document.getElementById("ghTokenInput").value.trim();
      if (!t) { alert("Bitte Token eintragen."); return; }
      localStorage.setItem("gh_token", t);
      modal.style.display = "none";
      toast("üîê Token gespeichert");
      // Optional: sofort Sync starten, wenn von Sync aufgerufen
      _pendingAction && _pendingAction();
      _pendingAction = null;
    };
    document.getElementById("ghTokenCancel").onclick = () => {
      modal.style.display = "none";
      _pendingAction = null;
    };
  }

  function openTokenModal() {
    ensureTokenModal();
    document.getElementById("ghTokenInput").value = localStorage.getItem("gh_token") || "";
    document.getElementById("ghTokenModal").style.display = "flex";
  }

  function toast(msg) {
    let t = document.getElementById("toast");
    if (!t) {
      t = document.createElement("div");
      t.id = "toast";
      t.style.cssText = "position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#16a34a;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;z-index:99999;display:none;";
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(t._h);
    t._h = setTimeout(() => t.style.display = "none", 1600);
  }

  // ---- Daten-Helfer (mergen & normalisieren) ----
  const normalize = (v) => [v[0]||"", v[1]||"", v[2]||"Gelb", v[3]||"", v[4]||"", v[5]||new Date().toISOString()];
  const keyOf = (v) => `${(v[0]||"").toLowerCase().trim()}|${(v[1]||"").toLowerCase().trim()}`;

  function mergeLists(remote, local) {
    const map = new Map();
    remote.map(normalize).forEach(v => map.set(keyOf(v), v));
    local.map(normalize).forEach(v => { if (!map.has(keyOf(v))) map.set(keyOf(v), v); });
    return [...map.values()];
  }

  function loadLocal() {
    return (JSON.parse(localStorage.getItem("vokabeln") || "[]") || []).map(normalize);
  }
  function saveLocal(list) {
    localStorage.setItem("vokabeln", JSON.stringify(list));
    localStorage.setItem("vokabeln_updated", new Date().toISOString());
  }

  // ---- GitHub API Calls ----
  async function ghGetContents(token) {
    const url = `${GH.apiBase}/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(GH.path)}?ref=${encodeURIComponent(GH.branch)}`;
    const r = await fetch(url, {
      headers: token ? { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" } : { "Accept": "application/vnd.github+json" }
    });
    if (!r.ok) throw new Error(`GET contents failed: ${r.status}`);
    return r.json(); // { content(base64), sha, ... }
  }

  function b64EncodeUnicode(str) {
    // sauberes Base64 f√ºr UTF-8 Inhalte
    return btoa(unescape(encodeURIComponent(str)));
  }

  async function ghPutContents(token, sha, mergedList) {
    const url = `${GH.apiBase}/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(GH.path)}`;
    const body = {
      message: `chore: sync vokabeln.json (auto)`,
      content: b64EncodeUnicode(JSON.stringify(mergedList, null, 2)),
      branch: GH.branch,
      sha
    };
    const r = await fetch(url, {
      method: "PUT",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Accept": "application/vnd.github+json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error(`PUT contents failed: ${r.status}`);
    return r.json();
  }

  // ---- Hauptablauf: Sync (pull -> merge -> push) ----
  let _pendingAction = null;

  async function doSync() {
    try {
      const token = localStorage.getItem("gh_token");
      if (!token) { _pendingAction = doSync; openTokenModal(); return; }

      // 1) Remote laden (sha + content)
      const remoteMeta = await ghGetContents(token);
      const remoteContent = remoteMeta && remoteMeta.content ? atob(remoteMeta.content.replace(/\n/g, "")) : "[]";
      const remote = JSON.parse(remoteContent || "[]");

      // 2) Local laden & mergen
      const local = loadLocal();
      const merged = mergeLists(remote, local);

      // 3) Upload (PUT) mit sha
      await ghPutContents(token, remoteMeta.sha, merged);

      // 4) Lokal auch speichern (und UI updaten)
      saveLocal(merged);
      toast("‚úÖ Erfolgreich synchronisiert");
      const info = document.getElementById("syncInfo");
      if (info) info.textContent = "Quelle: GitHub (synchronisiert)";

      // Falls du in deinem Code eine Render-Funktion hast, hier triggern:
      if (typeof render === "function") render();
      if (typeof renderLastAdded === "function") renderLastAdded();

    } catch (e) {
      console.error(e);
      alert("‚ùå Synchronisation fehlgeschlagen.\n" + e.message + "\n\nBitte pr√ºfe Token/Repo/Netzwerk.");
    }
  }

  // ---- Button verdrahten (existierende UI wiederverwenden) ----
  document.addEventListener("DOMContentLoaded", () => {
    ensureTokenModal();
    const syncBtn = document.getElementById("syncBtn");
    if (syncBtn) syncBtn.onclick = doSync;
  });
})();
</script>
