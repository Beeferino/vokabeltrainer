  const githubPull=async()=>{try{const r=await fetch(`https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${GH_PATH}?_=${Date.now()}`);if(!r.ok)throw 0;
    list=(await r.json()).map(normalize);saveLocal(list);renderAll();toast("🔄 Von GitHub geladen");}catch{list=loadLocal();renderAll();}};

  const fillCats=s=>{s.innerHTML="";for(const k in CATS){const o=document.createElement("option");o.value=k;o.textContent=CATS[k][0];o.style.background=CATS[k][1];o.style.color=CATS[k][2];s.appendChild(o);}};

  const buildLexica=()=>{const e=$("#lexica");e.innerHTML="";["Alle",..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"].forEach(L=>{const b=document.createElement("button");b.textContent=L;if(L===letter)b.classList.add("active");b.onclick=()=>{letter=L;renderTable();buildLexica();};e.appendChild(b);});};

  const filtered=()=>list.filter(([en,de,cat])=>{
    if(letter!=="Alle"&&!en.toUpperCase().startsWith(letter))return false;
    if(filterCat!=="Alle"&&cat!==filterCat)return false;
    if(searchTerm&&!`${en} ${de}`.toLowerCase().includes(searchTerm))return false;
    return true;
  });

  const renderTable=()=>{
    const rows=filtered().slice((currentPage-1)*perPage,(currentPage-1)*perPage+perPage);
    tblBody.innerHTML=rows.map(v=>{
      const i=list.indexOf(v),c=CATS[v[2]]||["","#ccc","#000"];
      return `<tr><td><input type="checkbox" data-idx="${i}"></td><td>${v[0]}</td><td>${v[1]}</td>
        <td><span class="category-chip" style="background:${c[1]};color:${c[2]}">${c[0]}</span></td>
        <td><button class="btn-plain" data-edit="${i}">✏️</button></td></tr>`;
    }).join("");
    $$("[data-edit]").forEach(b=>b.onclick=()=>openEdit(+b.dataset.edit));
  };

  const renderRecentList=()=>{const e=$("#recentList");if(!list.length)return e.textContent="–";
    e.innerHTML=list.slice(-5).reverse().map(v=>{
      const c=CATS[v[2]]||["","#ccc","#000"];
      return `<div class="recent-item" style="background:${c[1]};color:${c[2]};margin-bottom:8px">
        <b>${v[0]}</b> – ${v[1]}<br><small>${c[0]}</small></div>`;
    }).join("");
  };

  $("#filterCat").onchange=e=>{filterCat=e.target.value;renderTable();};
  $("#searchInput").oninput=e=>{searchTerm=e.target.value.toLowerCase();renderTable();};
  $("#btnReset").onclick=()=>{filterCat="Alle";searchTerm="";letter="Alle";$("#searchInput").value="";$("#filterCat").value="Alle";renderTable();};
  $("#btnDeleteSel").onclick=async()=>{const c=$$("input[data-idx]:checked");if(!c.length)return alert("Bitte Vokabeln auswählen.");
    if(!confirm(`Wirklich ${c.length} löschen?`))return;c.map(x=>+x.dataset.idx).sort((a,b)=>b-a).forEach(i=>list.splice(i,1));
    saveLocal(list);renderTable();toast("🗑️ Gelöscht");const ok=await githubPush(JSON.stringify(list,null,2));if(ok)toast("✅ Datenbank aktualisiert");
  };

  const openEdit=i=>{editIndex=i;const v=list[i];$("#editEn").value=v[0];$("#editDe").value=v[1];$("#editCat").value=v[2];$("#editGroup").value=v[3];$("#editHint").value=v[4];$("#modal").style.display="flex";};
  const closeEdit=()=>$("#modal").style.display="none";
  $("#btnClose").onclick=closeEdit;
  $("#btnSaveRow").onclick=async()=>{if(editIndex<0)return;const en=$("#editEn").value.trim(),de=$("#editDe").value.trim();
    if(!en||!de)return alert("Bitte Englisch & Deutsch ausfüllen.");list[editIndex]=[en,de,$("#editCat").value,$("#editGroup").value,$("#editHint").value,new Date().toISOString()];
    saveLocal(list);closeEdit();renderTable();toast("💾 Gespeichert");const ok=await githubPush(JSON.stringify(list,null,2));if(ok)toast("✅ Datenbank aktualisiert");
  };
  $("#btnDelRow").onclick=async()=>{if(editIndex<0)return;if(!confirm("Diese Vokabel löschen?"))return;
    list.splice(editIndex,1);saveLocal(list);closeEdit();renderTable();toast("🗑️ Gelöscht");const ok=await githubPush(JSON.stringify(list,null,2));if(ok)toast("✅ Datenbank aktualisiert");
  };

  const openAdd=()=>$("#modalAdd").style.display="flex",$("#fabAdd").classList.remove("pulse");
  const closeAdd=()=>$("#modalAdd").style.display="none";
  $("#fabAdd").onclick=openAdd;$("#btnAddClose").onclick=closeAdd;
  $("#btnAddSave").onclick=async()=>{const en=$("#newEn").value.trim(),de=$("#newDe").value.trim();if(!en||!de)return alert("Bitte Englisch & Deutsch ausfüllen.");
    list.push([en,de,$("#newCat").value,$("#newGroup").value,$("#newHint").value,new Date().toISOString()]);
    saveLocal(list);closeAdd();renderTable();toast("➕ Hinzugefügt");$("#fabAdd").classList.add("pulse");
    const ok=await githubPush(JSON.stringify(list,null,2));if(ok)toast("✅ Datenbank aktualisiert");
  };

  // --- Zuletzt hinzugefügt Modal ---
  const modalRecent=$("#modalRecent");$("#btnRecent").onclick=()=>{renderRecentList();modalRecent.style.display="flex";};
  $("#btnRecentClose").onclick=()=>modalRecent.style.display="none";

  $("#btnPush").onclick=async()=>{const ok=await githubPush(JSON.stringify(list,null,2));if(ok)toast("✅ Datenbank aktualisiert");};
  $("#btnPull").onclick=githubPull;

  const init=()=>{fillCats($("#filterCat"));fillCats($("#editCat"));fillCats($("#newCat"));githubPull();renderTable();};
  init();
})();
</script>
</body>
</html>
