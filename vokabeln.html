<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üìò Vokabel√ºbersicht</title>

  <style>
    body { font-family: sans-serif; background: #f7f9fb; margin: 0; padding: 20px; text-align: center; }
    .app { max-width: 1100px; margin: auto; }
    h1 { font-size: 1.8rem; margin-bottom: 0.6rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #eef2f7; cursor: pointer; user-select: none; }
    th.sort-asc::after { content: " ‚Üë"; color: #666; }
    th.sort-desc::after { content: " ‚Üì"; color: #666; }
    tr:hover { background: #f0f7ff; }
    .category-chip { display: inline-block; padding: 5px 10px; border-radius: 10px; color: #fff; }
    input, select, button { padding: 8px 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #cfd6e4; margin: 5px; }
    button { cursor: pointer; background: #2980b9; color: #fff; border: none; }
    button:hover { background: #3498db; }
    a.linkbtn { display: inline-block; padding: 10px 16px; border-radius: 8px; background: #74b9ff; color: #000; text-decoration: none; font-weight: 600; }
    a.linkbtn:hover { background: #a6d4ff; }
    .info-footer { margin-top: 16px; font-size: 0.95rem; color: #555; }
    .lexica { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin: 10px 0; }
    .lexica button { background: #ecf0f1; color: #333; border: 1px solid #ccc; font-weight: 600; padding: 6px 9px; }
    .lexica button.active { background: #2980b9; color: #fff; }
    .filter-bar { margin-top: 10px; display: flex; justify-content: center; gap: 14px; flex-wrap: wrap; align-items: center; }
    .searchbox { min-width: 260px; }
    .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
    .pagination button { background: #ecf0f1; color: #333; border: 1px solid #ccc; padding: 6px 10px; }
    .pagination button.active { background: #2980b9; color: #fff; }
    .section-divider { margin: 24px 0; border-top: 3px solid #e3e7ef; }
    .new-entry { margin-top: 10px; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #2ecc71; color: #fff; padding: 10px 16px; border-radius: 8px; display: none; z-index: 999; }
    .edit-btn { background: #f39c12; }
    .save-btn { background: #27ae60; }
    .save-btn:hover { background: #2ecc71; }
    .colored { transition: background 0.4s ease; }
    footer { margin-top: 30px; }
    #datasourceStatus { position: fixed; right: 12px; bottom: 10px; font-size: .8rem; opacity: .75; color: #555; pointer-events: none; }
    #recentBox { background: #fafbff; border-radius: 12px; padding: 10px 18px; margin: 16px auto; box-shadow: inset 0 1px 2px rgba(0,0,0,.05); max-width: 520px; }
    #recentBox ul { list-style: none; padding: 0; margin: 0; }
    #recentBox li { padding: 5px 0; border-bottom: 1px dashed #ccc; }
    #recentBox li:last-child { border-bottom: none; }
    .catLabel { font-size: 0.9rem; opacity: .75; }
  </style>
</head>

<body>
  <div class="app">
    <h1>üìò Vokabel√ºbersicht</h1>

    <div id="lexica" class="lexica"></div>

    <div class="filter-bar">
      <label>Kategorie:
        <select id="filterCategory" class="colored"></select>
      </label>
      <label>Gruppe / Variante:
        <select id="filterGroup"><option value="Alle">Alle</option></select>
      </label>
      <input id="searchInput" class="searchbox" type="text" placeholder="üîé Suchen (EN / DE / Gruppe / Hinweis)">
      <button id="resetFilter">üîÑ Filter zur√ºcksetzen</button>
    </div>

    <table id="vocabTable">
      <thead>
        <tr>
          <th style="width:36px;">&nbsp;</th>
          <th data-key="en">Englisch</th>
          <th data-key="de">Deutsch</th>
          <th data-key="cat">Kategorie</th>
          <th data-key="grp">Gruppe / Variante</th>
          <th data-key="hint">Hinweis</th>
          <th style="width:80px;">Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="pagination" class="pagination"></div>
    <div id="infoFooter" class="info-footer"></div>

    <div class="section-divider"></div>

    <div class="new-entry">
      <h3>‚ûï Neue Vokabel hinzuf√ºgen</h3>
      <div>
        <input id="newEnglish" type="text" placeholder="Englisch" disabled>
        <input id="newGerman" type="text" placeholder="Deutsch" disabled>
        <select id="newCategory" class="colored" disabled></select>
        <input id="newGroup" type="text" placeholder="Gruppe / Variante" disabled>
        <input id="newHint" type="text" placeholder="Hinweis" disabled>
        <button id="addBtn" disabled>Hinzuf√ºgen</button>
      </div>
      <div style="margin-top:8px;">
        <button id="toggleAdd">‚úèÔ∏è Eingabe aktivieren</button>
        <button id="deleteSelected">üóëÔ∏è Ausgew√§hlte l√∂schen</button>
      </div>
    </div>

    <div class="section-divider"></div>

    <footer>
      <h3>üíæ Datei- & JSON-Verwaltung</h3>
      <div style="margin-top:10px;">
        <button id="exportBtn">üì§ Exportieren</button>
        <input type="file" id="importFile" accept=".json" style="display:none;">
        <button id="importBtn">üì• Importieren</button>
        <button id="downloadMerged">üíæ vokabeln.json herunterladen</button>
      </div>

      <div class="section-divider"></div>

      <h3>üìú Zuletzt hinzugef√ºgt</h3>
      <div id="recentBox"><ul id="recentList"><li><em>Keine Vokabeln vorhanden.</em></li></ul></div>

      <a href="index.html" class="linkbtn">‚¨ÖÔ∏è Zur√ºck zum Trainer</a>
    </footer>
  </div>

  <div id="toast" class="toast">üíæ Gespeichert</div>
  <div id="datasourceStatus">üîÑ JSON + lokale Erg√§nzungen (gemergt)</div>

  <script>
  (() => {
    const CATEGORY_NAMES = { Gelb:"Grundwerkzeuge Metallverarbeitung", Pink:"Werkzeugkasten Mechaniker", Blau:"Blech- / Kunststoffarbeiten", Gruen:"Drehen / Fr√§sen", HellesPink:"Hydraulik / Pneumatik", Orange:"Elektrotechnik", Dunkelgruen:"Flugger√§temechanik allgemein", Rot:"Verwechslungsgefahr" };
    const COLOR_MAP = { Gelb:"#F4D03F", Pink:"#E91E63", Blau:"#1976D2", Gruen:"#1E8449", HellesPink:"#F54927", Orange:"#E67E22", Dunkelgruen:"#117A65", Rot:"#C0392B" };
    const labelForCategory = k => `${CATEGORY_NAMES[k]}`;
    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const toast = m => { const t=$("#toast"); t.textContent=m; t.style.display="block"; setTimeout(()=>t.style.display="none",1500); };

    const normalize = v => [v[0]||"",v[1]||"",v[2]||"Gelb",v[3]||"",v[4]||"",v[5]||new Date().toISOString()];
    const loadLocal = () => JSON.parse(localStorage.getItem("vokabeln")||"[]").map(normalize);
    const saveLocal = v => { localStorage.setItem("vokabeln",JSON.stringify(v)); localStorage.setItem("vokabeln_updated",new Date().toISOString()); renderRecent(); };

    // Merge Logic
    const keyOf = v => `${(v[0]||"").toLowerCase()}|${(v[1]||"").toLowerCase()}`;
    const merge = (remote, local) => {
      const map=new Map();
      remote.map(normalize).forEach(v=>map.set(keyOf(v),v));
      local.map(normalize).forEach(v=>{if(!map.has(keyOf(v)))map.set(keyOf(v),v)});
      return [...map.values()];
    };

    async function trySyncFromJson(){
      const urls=["./vokabeln.json","vokabeln.json",location.origin+"/vokabeln.json"];
      let remote=null;
      for(const u of urls){ try{const r=await fetch(u,{cache:"no-store"});if(r.ok){const d=await r.json();if(Array.isArray(d)){remote=d;break;}}}catch{} }
      const local=loadLocal();
      if(remote){ saveLocal(merge(remote,local)); } else if(local.length===0){
        saveLocal([["hammer","Hammer","Pink","","","2025-01-01T00:00:00Z"]]);
      }
      list=loadLocal(); renderAll();
    }

    function renderRecent(){
      const ul=$("#recentList"); ul.innerHTML="";
      const last=loadLocal().slice(-5).reverse();
      if(!last.length){ ul.innerHTML="<li><em>Keine Vokabeln vorhanden.</em></li>"; return; }
      last.forEach(([en,de,cat])=>{
        const li=document.createElement("li");
        li.innerHTML=`<b>${en}</b> ‚Äì ${de} <span class="catLabel" style="color:${COLOR_MAP[cat]||"#555"}">(${CATEGORY_NAMES[cat]||cat})</span>`;
        ul.appendChild(li);
      });
    }

    // Rendering / Table
    function renderLexica(){
      const lx=$("#lexica"); lx.innerHTML="";
      ["Alle",...Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZ")].forEach(l=>{
        const b=document.createElement("button"); b.textContent=l;
        if(l===letter)b.classList.add("active");
        b.onclick=()=>{letter=l;page=1;renderTable();renderLexica();};
        lx.appendChild(b);
      });
    }

    function renderFilterCategory(){
      const sel=$("#filterCategory");
      sel.innerHTML="<option value='Alle'>Alle (bunt gemischt)</option>";
      Object.keys(CATEGORY_NAMES).forEach(k=>{
        const o=document.createElement("option");
        o.value=k; o.textContent=labelForCategory(k);
        o.style.background=COLOR_MAP[k]; o.style.color="#fff";
        sel.appendChild(o);
      });
      sel.onchange=e=>{filterCat=e.target.value;page=1;renderTable();};
    }

    function filtered(){
      return list.filter(([en,de,cat,grp,hint])=>{
        if(letter!=="Alle"&&!en.toUpperCase().startsWith(letter))return false;
        if(filterCat!=="Alle"&&cat!==filterCat)return false;
        if(filterGrp!=="Alle"&&grp!==filterGrp)return false;
        if(search&&!(en+de+grp+hint).toLowerCase().includes(search))return false;
        return true;
      });
    }

    function renderTable(){
      const body=$("#vocabTable tbody"); body.innerHTML="";
      const rows=filtered();
      rows.forEach((v,i)=>{
        const [en,de,cat,grp,hint]=v;
        const tr=document.createElement("tr");
        tr.innerHTML=`<td><input type="checkbox" data-index="${i}"></td>
        <td>${en}</td><td>${de}</td>
        <td><span class="category-chip" style="background:${COLOR_MAP[cat]}">${CATEGORY_NAMES[cat]}</span></td>
        <td>${grp}</td><td>${hint}</td>
        <td><button class="edit-btn" data-index="${i}">‚úèÔ∏è</button></td>`;
        body.appendChild(tr);
      });
    }

    // State
    let list=[], letter="Alle", filterCat="Alle", filterGrp="Alle", search="", page=1;

    function renderAll(){
      renderLexica(); renderFilterCategory(); renderTable(); renderRecent();
      $("#infoFooter").textContent=`üìö Gesamt: ${list.length}`;
    }

    $("#toggleAdd").onclick=()=>{
      const d=$("#newEnglish").disabled;
      ["newEnglish","newGerman","newCategory","newGroup","newHint","addBtn"].forEach(id=>$("#"+id).disabled=!d);
      $("#toggleAdd").textContent=d?"üîí Eingabe sperren":"‚úèÔ∏è Eingabe aktivieren";
    };

    $("#addBtn").onclick=()=>{
      const en=$("#newEnglish").value.trim(),de=$("#newGerman").value.trim(),cat=$("#newCategory").value,grp=$("#newGroup").value.trim(),hint=$("#newHint").value.trim();
      if(!en||!de)return alert("Bitte ausf√ºllen!");
      list.push([en,de,cat,grp,hint,new Date().toISOString()]);
      saveLocal(list); renderTable(); toast("‚ûï Hinzugef√ºgt");
    };

    $("#deleteSelected").onclick=()=>{
      const ids=$$("input[type=checkbox]:checked").map(c=>parseInt(c.dataset.index));
      if(!ids.length)return alert("Bitte ausw√§hlen!");
      if(!confirm("Ausgew√§hlte Vokabeln l√∂schen?"))return;
      ids.sort((a,b)=>b-a).forEach(i=>list.splice(i,1));
      saveLocal(list); renderTable(); toast("üóëÔ∏è Gel√∂scht");
    };

    $("#resetFilter").onclick=()=>{filterCat="Alle";filterGrp="Alle";letter="Alle";search="";$("#searchInput").value="";renderAll();};
    $("#searchInput").oninput=e=>{search=e.target.value.trim().toLowerCase();renderTable();};

    (async()=>{await trySyncFromJson();})();
  })();
  </script>
</body>
</html>
