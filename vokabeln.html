// --- Sync & Storage ---
function saveLocal(){localStorage.setItem("vokabeln",JSON.stringify(list));}
function loadLocal(){try{return JSON.parse(localStorage.getItem("vokabeln")||"[]").map(norm);}catch{return[]}}

async function loadGitHub(){
  try{
    const r=await fetch("https://beeferino.github.io/vokabeltrainer/vokabeln.json",{cache:"no-store"});
    const d=await r.json();
    const local=loadLocal();
    list=dedup([...d,...local]);
    saveLocal();
    $("#srcInfo").textContent="Quelle: GitHub (Online)";
  }catch{
    list=loadLocal();
    $("#srcInfo").textContent="Quelle: Lokal";
  }
  applyFilters(); render();
}

async function githubSyncUpload(msg){
  const token=localStorage.getItem("gh_token");
  if(!token){toast("⚠️ Kein GitHub-Token gefunden – lokal gespeichert");saveLocal();return;}
  try{
    const meta=await fetch(`${GH.api}/repos/${GH.owner}/${GH.repo}/contents/${GH.path}?ref=${GH.branch}`,{
      headers:{Authorization:`Bearer ${token}`}
    }).then(r=>r.json());
    const payload={
      message:`${msg} (Beeferino Trainer)`,
      content:btoa(unescape(encodeURIComponent(JSON.stringify(list,null,2)))),
      sha:meta.sha,
      branch:GH.branch
    };
    await fetch(`${GH.api}/repos/${GH.owner}/${GH.repo}/contents/${GH.path}`,{
      method:"PUT",
      headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    toast("✅ GitHub synchronisiert");
  }catch(e){
    console.error(e);
    toast("⚠️ GitHub Sync fehlgeschlagen – lokal gespeichert");
  }
}

// Einheitliche Speicherfunktion
async function saveSync(arr,msg,newItem=null){
  list=dedup(arr);
  saveLocal();
  await githubSyncUpload(msg);
  if(newItem) showNewPopup([newItem]);
}

// Automatisches Popup für neue Vokabel(n)
function showNewPopup(items){
  const box=document.createElement("div");
  box.id="newPopup";
  Object.assign(box.style,{
    position:"fixed",inset:"0",background:"rgba(0,0,0,.45)",zIndex:"4000",
    display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"
  });
  const card=document.createElement("div");
  Object.assign(card.style,{
    background:"#fff",borderRadius:"16px",padding:"18px",maxWidth:"600px",
    width:"92vw",boxShadow:"0 10px 30px rgba(0,0,0,.25)",textAlign:"center"
  });
  card.innerHTML=`<h3 style="color:#1e3a8a;margin-top:0">✅ Neue Vokabel gespeichert</h3>
    <div id="newList" style="margin:12px 0;line-height:1.6"></div>
    <button id="closeNew" style="background:#2563eb;color:#fff;border:none;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer">Schließen</button>`;
  box.appendChild(card);
  document.body.appendChild(box);

  const listDiv=card.querySelector("#newList");
  listDiv.innerHTML=items.map(v=>{
    const c=CATS[v[2]]||["","#ddd","#000"];
    return `<div style="background:${c[1]};color:${c[2]};padding:8px 12px;border-radius:10px;margin:4px 0;font-weight:700">
      ${v[0]} → ${v[1]} <span style="font-weight:400;opacity:.8">(${c[0]})</span>
    </div>`;
  }).join("");

  card.querySelector("#closeNew").onclick=()=>box.remove();
}

// --- Event: GitHub Sync Button ---
$("#btnSync").onclick=()=>loadGitHub();

// --- Event: Neue Vokabel speichern ---
$("#btnAdd").onclick=async()=>{
  const en=$("#inEn").value.trim(),de=$("#inDe").value.trim();
  if(!en||!de)return alert("Bitte Englisch & Deutsch eingeben!");
  const newItem=[en,de,$("#inCat").value,$("#inGrp").value.trim(),$("#inHint").value.trim(),new Date().toISOString()];
  list=dedup([...list,newItem]);
  await saveSync(list,"Neue Vokabel",newItem);
  $("#inEn").value=$("#inDe").value=$("#inGrp").value=$("#inHint").value="";
  applyFilters();render();
};

// --- Multi Delete, Edit, etc. bleiben unverändert ---
