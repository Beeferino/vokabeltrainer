<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>📘 Vokabelübersicht</title>
<style>
body{font-family:sans-serif;background:#f7f9fb;margin:0;padding:20px;text-align:center;}
.app{max-width:1100px;margin:auto;}
h1{font-size:1.8rem;margin-bottom:0.6rem;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left;}
th{background:#eef2f7;cursor:pointer;user-select:none;}
th.sort-asc::after{content:" ↑";color:#666;}
th.sort-desc::after{content:" ↓";color:#666;}
tr:hover{background:#f0f7ff;}
.category-chip{display:inline-block;padding:5px 10px;border-radius:10px;color:#fff;}
input,select,button{padding:8px 10px;font-size:1rem;border-radius:6px;border:1px solid #cfd6e4;margin:5px;}
button{cursor:pointer;background:#2980b9;color:#fff;border:none;}
button:hover{background:#3498db;}
a.linkbtn{display:inline-block;padding:10px 16px;border-radius:8px;background:#74b9ff;color:#000;text-decoration:none;font-weight:600;}
a.linkbtn:hover{background:#a6d4ff;}
.info-footer{margin-top:16px;font-size:0.95rem;color:#555;}
.lexica{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:10px 0;}
.lexica button{background:#ecf0f1;color:#333;border:1px solid #ccc;font-weight:600;padding:6px 9px;}
.lexica button.active{background:#2980b9;color:#fff;}
.filter-bar{margin-top:10px;display:flex;justify-content:center;gap:14px;flex-wrap:wrap;align-items:center;}
.searchbox{min-width:260px;}
.pagination{display:flex;justify-content:center;gap:8px;margin-top:10px;}
.pagination button{background:#ecf0f1;color:#333;border:1px solid #ccc;padding:6px 10px;}
.pagination button.active{background:#2980b9;color:#fff;}
.section-divider{margin:24px 0;border-top:3px solid #e3e7ef;}
.new-entry{margin-top:10px;}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#2ecc71;color:#fff;padding:10px 16px;border-radius:8px;display:none;z-index:999;}
footer{margin-top:30px;}
#datasourceStatus{position:fixed;right:12px;bottom:10px;font-size:.8rem;opacity:.75;color:#555;pointer-events:none;}
#recentBox{background:#fafbff;border-radius:12px;padding:10px 18px;margin:10px auto 18px;box-shadow:inset 0 1px 2px rgba(0,0,0,.05);max-width:520px;}
#recentBox ul{list-style:none;padding:0;margin:0;}
#recentBox li{padding:6px 0;border-bottom:1px dashed #ccc;}
#recentBox li:last-child{border-bottom:none;}
.catLabel{font-size:0.9rem;opacity:.75;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1000;}
.modal{background:#fff;width:95%;max-width:560px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:14px 16px 12px;text-align:left;}
.modal header{font-weight:700;font-size:1.1rem;margin-bottom:6px;}
.modal .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.modal .row+.row{margin-top:6px;}
.modal footer{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;}
.btn-secondary{background:#95a5a6;}
.btn-secondary:hover{background:#aab7b8;}
.btn-danger{background:#e74c3c;}
.btn-danger:hover{background:#ff6b5a;}
</style>
</head>
<body>
<div class="app">
<h1>📘 Vokabelübersicht</h1>

<div id="lexica" class="lexica"></div>

<div class="filter-bar">
  <label>Kategorie:
    <select id="filterCategory" class="colored"></select>
  </label>
  <label>Gruppe / Variante:
    <select id="filterGroup"><option value="Alle">Alle</option></select>
  </label>
  <input id="searchInput" class="searchbox" type="text" placeholder="🔎 Suchen (EN / DE / Gruppe / Hinweis)">
  <button id="resetFilter">🔄 Filter zurücksetzen</button>
</div>

<table id="vocabTable">
  <thead>
    <tr>
      <th style="width:36px;">&nbsp;</th>
      <th data-key="en">Englisch</th>
      <th data-key="de">Deutsch</th>
      <th data-key="cat">Kategorie</th>
      <th data-key="grp">Gruppe / Variante</th>
      <th data-key="hint">Hinweis</th>
      <th style="width:100px;">Aktion</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="pagination" class="pagination"></div>
<div id="infoFooter" class="info-footer"></div>

<div class="section-divider"></div>

<div class="new-entry">
  <h3>➕ Neue Vokabel hinzufügen</h3>
  <div>
    <input id="newEnglish" type="text" placeholder="Englisch" disabled>
    <input id="newGerman" type="text" placeholder="Deutsch" disabled>
    <select id="newCategory" class="colored" disabled></select>
    <select id="newGroupSelect" disabled><option value="">(Gruppe wählen oder neu tippen)</option></select>
    <input id="newGroup" type="text" placeholder="Neue Gruppe" disabled>
    <input id="newHint" type="text" placeholder="Hinweis" disabled>
    <button id="addBtn" disabled>Hinzufügen</button>
  </div>
  <div style="margin-top:8px;">
    <button id="toggleAdd">✏️ Eingabe aktivieren</button>
    <button id="deleteSelected">🗑️ Ausgewählte löschen</button>
  </div>
</div>

<div class="section-divider"></div>

<footer>
  <h3>💾 Datei- & JSON-Verwaltung</h3>
  <div style="margin-top:10px;">
    <button id="exportBtn">📤 Exportieren</button>
    <input type="file" id="importFile" accept=".json" style="display:none;">
    <button id="importBtn">📥 Importieren</button>
    <button id="downloadMerged">💾 vokabeln.json herunterladen</button>
  </div>

  <div class="section-divider"></div>

  <h3>📜 Zuletzt hinzugefügt</h3>
  <div id="recentBox"><ul id="recentList"><li><em>Keine Vokabeln vorhanden.</em></li></ul></div>

  <a href="index.html" class="linkbtn">⬅️ Zurück zum Trainer</a>
</footer>
</div>

<div id="toast" class="toast">💾 Gespeichert</div>
<div id="datasourceStatus">🔄 JSON + lokale Ergänzungen (gemergt)</div>

<!-- Modal -->
<div id="editBackdrop" class="modal-backdrop">
  <div class="modal">
    <header>✏️ Vokabel bearbeiten</header>
    <div class="row">
      <input id="eEn" placeholder="Englisch">
      <input id="eDe" placeholder="Deutsch">
    </div>
    <div class="row">
      <select id="eCat" class="colored"></select>
      <select id="eGrpSelect"><option value="">(Gruppe wählen)</option></select>
    </div>
    <div class="row">
      <input id="eHint" placeholder="Hinweis">
      <input id="eDate" type="datetime-local" title="Änderungsdatum (optional)">
    </div>
    <footer>
      <button id="eCancel" class="btn-secondary">Abbrechen</button>
      <button id="eDelete" class="btn-danger">Löschen</button>
      <button id="eSave" class="save-btn">💾 Speichern</button>
    </footer>
  </div>
</div>

<script>
(()=>{
const CATEGORY_NAMES={Gelb:"Grundwerkzeuge Metallverarbeitung",Pink:"Werkzeugkasten Mechaniker",Blau:"Blech- / Kunststoffarbeiten",Gruen:"Drehen / Fräsen",HellesPink:"Hydraulik / Pneumatik",Orange:"Elektrotechnik",Dunkelgruen:"Fluggerätemechanik allgemein",Rot:"Verwechslungsgefahr"};
const COLOR_MAP={Gelb:"#F4D03F",Pink:"#E91E63",Blau:"#1976D2",Gruen:"#1E8449",HellesPink:"#F54927",Orange:"#E67E22",Dunkelgruen:"#117A65",Rot:"#C0392B"};
const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
const toast=m=>{const t=$("#toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",1500);};
const normalize=v=>[v[0]||"",v[1]||"",v[2]||"Gelb",v[3]||"",v[4]||"",v[5]||new Date().toISOString()];
const loadLocal=()=>JSON.parse(localStorage.getItem("vokabeln")||"[]").map(normalize);
const saveLocal=v=>{localStorage.setItem("vokabeln",JSON.stringify(v));localStorage.setItem("vokabeln_updated",new Date().toISOString());renderRecent();};
let list=[],editingIndex=-1;

function renderCategorySelect(sel,includeAll=false){
 sel.innerHTML=includeAll?"<option value='Alle'>Alle</option>":"";
 for(const k in CATEGORY_NAMES){
   const o=document.createElement("option");o.value=k;o.textContent=CATEGORY_NAMES[k];
   o.style.background=COLOR_MAP[k];o.style.color="#fff";sel.appendChild(o);
 }
 sel.onchange=()=>{sel.style.background=COLOR_MAP[sel.value]||"#fff";};
}

function renderGroupSelect(sel,current=""){
 const groups=[...new Set(loadLocal().map(v=>v[3]).filter(Boolean))].sort();
 sel.innerHTML="<option value=''>Gruppe wählen...</option>"+groups.map(g=>`<option ${g===current?"selected":""}>${g}</option>`).join("");
}

function mergeVocabLists(remote,local){
 const map=new Map(),key=v=>(v[0].toLowerCase()+"|"+v[1].toLowerCase());
 remote.forEach(v=>map.set(key(v),v));local.forEach(v=>{if(!map.has(key(v)))map.set(key(v),v);});
 return [...map.values()];
}

async function trySyncFromJson(){
 try{
   const r=await fetch("vokabeln.json",{cache:"no-store"});
   if(r.ok){const d=await r.json();if(Array.isArray(d)){saveLocal(mergeVocabLists(d,loadLocal()));}}
 }catch{}
 list=loadLocal();renderAll();
}

function renderLexica(){
 const lx=$("#lexica");lx.innerHTML="";["Alle",...Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZ")].forEach(l=>{
  const b=document.createElement("button");b.textContent=l;if(l===letter)b.classList.add("active");
  b.onclick=()=>{letter=l;currentPage=1;renderTable();renderLexica();};lx.appendChild(b);
 });
}

function renderFilterCategory(){
 const sel=$("#filterCategory");renderCategorySelect(sel,true);sel.value="Alle";
 sel.onchange=e=>{filterCat=e.target.value;currentPage=1;renderTable();};
}

function renderFilterGroup(){
 const sel=$("#filterGroup");
 const groups=[...new Set(list.map(v=>v[3]).filter(Boolean))].sort();
 sel.innerHTML="<option value='Alle'>Alle</option>"+groups.map(g=>`<option>${g}</option>`).join("");
 sel.onchange=e=>{filterGrp=e.target.value;currentPage=1;renderTable();};
}

function filtered(){
 return list.filter(([en,de,cat,grp,hint])=>{
  if(letter!=="Alle"&&!en.toUpperCase().startsWith(letter))return false;
  if(filterCat!=="Alle"&&cat!==filterCat)return false;
  if(filterGrp!=="Alle"&&grp!==filterGrp)return false;
  if(searchTerm){const hay=(en+" "+de+" "+(grp||"")+" "+(hint||"")).toLowerCase();if(!hay.includes(searchTerm))return false;}
  return true;
 });
}

function renderTable(){
 const all=filtered();const tbody=$("#vocabTable tbody");tbody.innerHTML="";
 all.slice((currentPage-1)*perPage,(currentPage)*perPage).forEach(v=>{
   const [en,de,cat,grp,hint]=v;const i=list.indexOf(v);
   const tr=document.createElement("tr");
   tr.innerHTML=`<td><input type="checkbox" data-index="${i}"></td>
   <td>${en}</td><td>${de}</td>
   <td><span class='category-chip' style='background:${COLOR_MAP[cat]}'>${CATEGORY_NAMES[cat]}</span></td>
   <td>${grp||""}</td><td>${hint||""}</td>
   <td><button class='edit-btn' data-index='${i}'>✏️</button></td>`;
   tbody.appendChild(tr);
 });
 $$(".edit-btn").forEach(b=>b.onclick=()=>openEditModal(parseInt(b.dataset.index)));
 renderRecent();
}

function renderRecent(){
 const ul=$("#recentList");ul.innerHTML="";
 const last=loadLocal().slice(-5).reverse();
 if(!last.length){ul.innerHTML="<li><em>Keine Vokabeln vorhanden.</em></li>";return;}
 last.forEach(([en,de,cat])=>{
   const li=document.createElement("li");
   li.innerHTML=`<b>${en}</b> – ${de} <span class='catLabel' style='color:${COLOR_MAP[cat]}'>(${CATEGORY_NAMES[cat]})</span>`;
   ul.appendChild(li);
 });
}

function openEditModal(i){
 editingIndex=i;const [en,de,cat,grp,hint,date]=list[i];
 $("#eEn").value=en;$("#eDe").value=de;$("#eHint").value=hint||"";
 $("#eCat").value=cat;renderGroupSelect($("#eGrpSelect"),grp);
 $("#eDate").value=date?new Date(date).toISOString().slice(0,16):"";
 $("#editBackdrop").style.display="flex";
}

$("#eCancel").onclick=()=>$("#editBackdrop").style.display="none";
$("#eSave").onclick=()=>{
 const newEn=$("#eEn").value.trim(),newDe=$("#eDe").value.trim(),newCat=$("#eCat").value;
 let newGrp=$("#eGrpSelect").value.trim();if(!newGrp)newGrp="";
 const newHint=$("#eHint").value.trim();
 if(!newEn||!newDe)return alert("Bitte ausfüllen!");
 list[editingIndex]=[newEn,newDe,newCat,newGrp,newHint,new Date().toISOString()];
 saveLocal(list);$("#editBackdrop").style.display="none";renderAll();toast("💾 Gespeichert");
};
$("#eDelete").onclick=()=>{list.splice(editingIndex,1);saveLocal(list);$("#editBackdrop").style.display="none";renderAll();toast("🗑️ Gelöscht");};

let letter="Alle",filterCat="Alle",filterGrp="Alle",searchTerm="",currentPage=1,perPage=15;

function renderAll(){
 renderCategorySelect($("#newCategory"));renderGroupSelect($("#newGroupSelect"));
 renderFilterCategory();renderFilterGroup();renderLexica();renderTable();
}

$("#toggleAdd").onclick=()=>{
 const d=$("#newEnglish").disabled;
 ["newEnglish","newGerman","newCategory","newGroup","newGroupSelect","newHint","addBtn"].forEach(id=>$("#"+id).disabled=!d);
 $("#toggleAdd").textContent=d?"🔒 Eingabe sperren":"✏️ Eingabe aktivieren";
};

$("#addBtn").onclick=()=>{
 const en=$("#newEnglish").value.trim(),de=$("#newGerman").value.trim(),cat=$("#newCategory").value;
 let grp=$("#newGroup").value.trim()||$("#newGroupSelect").value.trim();
 const hint=$("#newHint").value.trim();
 if(!en||!de)return alert("Bitte ausfüllen!");
 list.push([en,de,cat,grp,hint,new Date().toISOString()]);
 saveLocal(list);renderGroupSelect($("#newGroupSelect"));renderTable();toast("➕ Hinzugefügt");
 ["newEnglish","newGerman","newGroup","newHint"].forEach(id=>$("#"+id).value="");
};

$("#searchInput").oninput=e=>{searchTerm=e.target.value.toLowerCase();renderTable();};
$("#resetFilter").onclick=()=>{filterCat="Alle";filterGrp="Alle";letter="Alle";$("#searchInput").value="";renderAll();};
$("#exportBtn").onclick=()=>{const b=new Blob([JSON.stringify(loadLocal(),null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="vokabeln.json";a.click();};
$("#importBtn").onclick=()=>$("#importFile").click();
$("#importFile").onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const d=JSON.parse(r.result);list=mergeVocabLists(list,d);saveLocal(list);renderAll();toast("📥 Importiert");}catch{alert("Fehler beim Import.");}};r.readAsText(f);};
$("#downloadMerged").onclick=()=>$("#exportBtn").click();

trySyncFromJson();
})();
</script>
</body>
</html>
